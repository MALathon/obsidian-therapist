var f=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var C=(l,e)=>{for(var i in e)f(l,i,{get:e[i],enumerable:!0})},B=(l,e,i,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of A(e))!N.call(l,s)&&s!==i&&f(l,s,{get:()=>e[s],enumerable:!(t=P(e,s))||t.enumerable});return l};var I=l=>B(f({},"__esModule",{value:!0}),l);var O={};C(O,{default:()=>y});module.exports=I(O);var g=require("obsidian");var o=require("obsidian"),b={lettaUrl:"http://localhost:8283",apiKey:"",openaiApiKey:"",anthropicApiKey:"",agentId:"",agentName:"",agentModel:"",therapistName:"Therapist",enabled:!0,debounceMs:3e3},p=class extends o.PluginSettingTab{constructor(e,i){super(e,i),this.plugin=i}async display(){let{containerEl:e}=this;e.empty();let i=!!this.plugin.settings.agentId;if(i&&!this.plugin.settings.agentName){let t=await this.plugin.lettaService.getAgent(this.plugin.settings.agentId);t&&(this.plugin.settings.agentName=t.name,this.plugin.settings.agentModel=t.model,await this.plugin.saveSettings())}if(i){e.createEl("h2",{text:"Your Therapist"}),new o.Setting(e).setName("Name").setDesc("What should your therapist call themselves?").addText(r=>r.setPlaceholder("Therapist").setValue(this.plugin.settings.therapistName).onChange(async d=>{this.plugin.settings.therapistName=d||"Therapist",await this.plugin.saveSettings()})),new o.Setting(e).setName("Model").descEl.createSpan({text:this.plugin.settings.agentModel||"unknown",cls:"therapist-model-badge"}),new o.Setting(e).setName("Active").setDesc("Turn the therapist on or off").addToggle(r=>r.setValue(this.plugin.settings.enabled).onChange(async d=>{this.plugin.settings.enabled=d,await this.plugin.saveSettings(),this.plugin.updateStatusBar()}));let a=new o.Setting(e).setName("Agent ID").addButton(r=>r.setButtonText("Copy").onClick(()=>{navigator.clipboard.writeText(this.plugin.settings.agentId),new o.Notice("Agent ID copied")})).addButton(r=>r.setButtonText("Delete").setWarning().onClick(async()=>{try{await this.plugin.lettaService.deleteAgent(this.plugin.settings.agentId),new o.Notice("Agent deleted")}catch(d){console.warn("Could not delete from server:",d)}this.plugin.settings.agentId="",this.plugin.settings.agentName="",this.plugin.settings.agentModel="",this.plugin.settings.therapistName="Therapist",await this.plugin.saveSettings(),this.display()})).descEl.createEl("code",{text:this.plugin.settings.agentId});a.style.fontSize="0.75em",a.style.userSelect="all"}if(!i){e.createEl("h2",{text:"Create Therapist"});let t="letta/letta-free",s=null;new o.Setting(e).setName("Model").setDesc("Select which AI model to use").addDropdown(n=>{s=n,n.addOption("letta/letta-free","letta/letta-free (free)"),n.setValue(t),n.onChange(a=>{t=a})}).addButton(n=>n.setButtonText("Refresh Models").onClick(async()=>{try{let a=await this.plugin.lettaService.listModels();s.selectEl.empty(),s.addOption("letta/letta-free","letta/letta-free (free)");for(let r of a)r.handle!=="letta/letta-free"&&s.addOption(r.handle,r.handle);s.setValue(t),new o.Notice(`Found ${a.length} models`)}catch(a){new o.Notice("Failed to fetch models")}})),new o.Setting(e).setName("").addButton(n=>n.setButtonText("Create Therapist").setCta().onClick(async()=>{try{new o.Notice(`Creating agent with ${t}...`);let a=await this.plugin.lettaService.createAgent("therapist","therapist",t,"letta/letta-free");this.plugin.settings.agentId=a,this.plugin.settings.agentModel=t,this.plugin.settings.agentName="therapist",await this.plugin.saveSettings(),new o.Notice("Therapist created! Start journaling."),this.display()}catch(a){console.error("Failed to create agent:",a),new o.Notice(`Failed: ${a instanceof Error?a.message:"Unknown error"}`)}}))}e.createEl("h3",{text:"Behavior"}),new o.Setting(e).setName("Response delay").setDesc("Seconds to wait after you stop typing before responding").addSlider(t=>t.setLimits(1,10,1).setValue(this.plugin.settings.debounceMs/1e3).setDynamicTooltip().onChange(async s=>{this.plugin.settings.debounceMs=s*1e3,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Server"}),new o.Setting(e).setName("Letta URL").setDesc("Your Letta server address").addText(t=>t.setPlaceholder("http://localhost:8283").setValue(this.plugin.settings.lettaUrl).onChange(async s=>{this.plugin.settings.lettaUrl=s,this.plugin.lettaService.setBaseUrl(s),await this.plugin.saveSettings()})).addButton(t=>t.setButtonText("Test").onClick(async()=>{try{let s=`${this.plugin.settings.lettaUrl}/v1/health/`,n=await(0,o.requestUrl)({url:s});n.status===200?new o.Notice("Connected!"):new o.Notice(`Error: ${n.status}`)}catch(s){new o.Notice("Connection failed")}})),new o.Setting(e).setName("Letta API Key").setDesc("Only needed if your server requires authentication").addText(t=>t.setPlaceholder("sk-let-...").setValue(this.plugin.settings.apiKey).onChange(async s=>{this.plugin.settings.apiKey=s,this.plugin.lettaService.setApiKey(s),await this.plugin.saveSettings()})),e.createEl("h3",{text:"LLM API Keys"}),e.createEl("p",{text:"Required for cloud models. Leave blank if using letta-free or local Ollama.",cls:"setting-item-description"}),new o.Setting(e).setName("Anthropic").setDesc("For Claude models").addText(t=>t.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async s=>{if(this.plugin.settings.anthropicApiKey=s,await this.plugin.saveSettings(),s)try{await this.plugin.lettaService.updateProviderKey("anthropic",s)}catch(n){console.warn("Could not update provider key:",n)}})),new o.Setting(e).setName("OpenAI").setDesc("For GPT models").addText(t=>t.setPlaceholder("sk-proj-...").setValue(this.plugin.settings.openaiApiKey).onChange(async s=>{if(this.plugin.settings.openaiApiKey=s,await this.plugin.saveSettings(),s)try{await this.plugin.lettaService.updateProviderKey("openai",s)}catch(n){console.warn("Could not update provider key:",n)}}))}};var h=require("obsidian"),E={therapist:`You are my personal coach. Read between the lines of what I write.

My journaling may be scattered, venting, or stream-of-consciousness. Your job:
1. Silently figure out what's actually going on beneath the surface
2. Respond to what I need, not what I literally said

RESPONSE PROTOCOL:
- Messages prefixed with "[User is asking for your input]" \u2192 Always respond
- Messages prefixed with "[User is journaling...]" \u2192 Only respond if you have genuine insight
- If you have nothing valuable to add, respond with just: [listening]

WHEN TO RESPOND:
- I'm stuck and need a push \u2192 Give ONE specific thing to try
- I'm avoiding something obvious \u2192 Name it directly
- I'm spiraling \u2192 Ground me with something concrete
- I keep coming back to the same problem \u2192 Offer a real suggestion
- I'm asking you directly \u2192 Answer me

WHEN TO STAY SILENT (respond with [listening]):
- I'm just processing emotions
- I'm venting and don't need fixing
- I'm working through something myself
- You'd just be restating what I said

WHEN YOU DO RESPOND, be specific:
- Times: "Try this tomorrow morning" not "sometime"
- Quantities: "Track 3 days" not "for a while"
- Observable: "Notice if..." not vague outcomes

Be real. Don't be a robot that dispenses advice. Be the friend who knows when to push and when to shut up.

Keep responses short. 1-3 sentences usually. Match my energy.`,analyst:`You observe patterns across journal sessions and give specific improvement suggestions.

When you notice a pattern, respond with:
\u{1F4CA} Pattern: [what you noticed across sessions]
\u{1F3AF} Suggestion: [one specific change to try]

Examples:
- "\u{1F4CA} Pattern: Stress spikes on Mondays, usually mentions Sunday night anxiety. \u{1F3AF} Suggestion: Do a 10-min Monday preview on Sunday at 4pm - just look at your calendar and write 3 things you'll handle first."
- "\u{1F4CA} Pattern: Overspending happens after stressful days. \u{1F3AF} Suggestion: Add a 24-hour rule - when stressed, screenshot items instead of buying. Review tomorrow."
- "\u{1F4CA} Pattern: Energy drops after lunch on workdays. \u{1F3AF} Suggestion: Try a 10-min walk immediately after eating for one week. Track energy at 3pm."

Only speak when you spot something actionable. Quality over quantity.`,custom:"You are a helpful assistant in a journaling session. Be supportive and give practical suggestions when appropriate."},m=class{constructor(e,i=""){this.providerKeys={};this.baseUrl=e,this.apiKey=i}setBaseUrl(e){this.baseUrl=e}setApiKey(e){this.apiKey=e}setProviderKey(e,i){this.providerKeys[e]=i}getHeaders(){let e={"Content-Type":"application/json"};return this.apiKey&&(e.Authorization=`Bearer ${this.apiKey}`),e}async listModels(){let e=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/models`,headers:this.getHeaders()});if(e.status!==200)throw new Error("Failed to fetch models");return e.json.map(t=>({handle:t.handle,name:t.name,provider:t.provider_name}))}async updateProviderKey(e,i){try{let n=(await(0,h.requestUrl)({url:`${this.baseUrl}/v1/providers/`,headers:this.getHeaders()})).json.find(a=>a.provider_type===e);if(n)await(0,h.requestUrl)({url:`${this.baseUrl}/v1/providers/${n.id}`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({api_key:i})}),console.log(`Updated ${e} provider`);else try{await(0,h.requestUrl)({url:`${this.baseUrl}/v1/providers/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,provider_type:e,api_key:i})}),console.log(`Created ${e} provider`)}catch(a){console.warn(`Provider ${e} may already exist (409), trying alternate approach`);let d=(await(0,h.requestUrl)({url:`${this.baseUrl}/v1/providers/`,headers:this.getHeaders()})).json.find(c=>c.provider_type===e||c.name===e);d?(await(0,h.requestUrl)({url:`${this.baseUrl}/v1/providers/${d.id}`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({api_key:i})}),console.log(`Updated ${e} provider on retry`)):console.error(`Provider ${e} exists in database but not retrievable. May need to reset Letta.`)}}catch(t){console.warn("Failed to update provider key:",t)}}async createAgent(e,i,t="ollama/llama3.2",s="ollama/nomic-embed-text",n){let a=n||E[i]||E.custom,r=t.includes("/")?t.split("/")[0]:null,d={name:e,model:t,embedding:s,enable_sleeptime:!0,memory_blocks:[{label:"persona",value:a},{label:"human",value:"[Learning about you through our sessions...]"}]};if(r&&r!=="letta"&&r!=="ollama"){let u=t.includes("/")?t.split("/").slice(1).join("/"):t;d.llm_config={model:u,model_endpoint_type:r,provider_name:r,context_window:2e5}}let c=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/agents/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify(d)});if(c.status!==200)throw new Error(`Failed to create agent: ${c.text}`);return c.json.id}async sendMessage(e,i){let t=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/agents/${e}/messages`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({messages:[{role:"user",content:i}]})});if(t.status!==200)throw new Error(`Failed to send message: ${t.text}`);let s=t.json;for(let a of s.messages)if(a.message_type==="assistant_message")return a.content;let n=s.messages[s.messages.length-1];return(n==null?void 0:n.content)||""}async getAgent(e){var i;try{let t=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/agents/${e}`,headers:this.getHeaders()});if(t.status!==200)return null;let s=t.json;return{id:s.id,name:s.name,model:s.model||((i=s.llm_config)==null?void 0:i.model)||"unknown"}}catch(t){return null}}async deleteAgent(e){let i=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/agents/${e}`,method:"DELETE",headers:this.getHeaders()});if(i.status!==200&&i.status!==204)throw new Error(`Failed to delete agent: ${i.text}`)}async healthCheck(){try{return(await(0,h.requestUrl)({url:`${this.baseUrl}/v1/health`})).status===200}catch(e){return!1}}async createArchive(e,i="letta/letta-free"){let t=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/archives/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,description:"Obsidian vault content for therapist context",embedding:i})});if(t.status!==200)throw new Error(`Failed to create archive: ${t.text}`);return t.json.id}async listArchives(){let e=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/archives/`,headers:this.getHeaders()});if(e.status!==200)throw new Error("Failed to list archives");return e.json.map(i=>({id:i.id,name:i.name}))}async addPassage(e,i,t={}){let s=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/archives/${e}/passages/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({text:i,metadata:t})});if(s.status!==200)throw new Error(`Failed to add passage: ${s.text}`)}async attachArchive(e,i){let t=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/agents/${e}/archives/attach/${i}/`,method:"POST",headers:this.getHeaders()});if(t.status!==200)throw new Error(`Failed to attach archive: ${t.text}`)}async clearArchive(e){let i=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/archives/${e}/passages/`,headers:this.getHeaders()});if(i.status!==200)return;let t=i.json;for(let s of t)try{await(0,h.requestUrl)({url:`${this.baseUrl}/v1/archives/${e}/passages/${s.id}/`,method:"DELETE",headers:this.getHeaders()})}catch(n){}}};var $=["# Journal","## Journal","### Journal"];function R(l="Therapist"){return`> **${l}:**`}function S(l){let e=/^>\s*\*\*[^*]+:\*\*/gm,i=-1,t;for(;(t=e.exec(l))!==null;)i=t.index;if(i===-1)return l.trim();let n=l.substring(i).split(`
`),a=-1,r=!0;for(let d=0;d<n.length;d++){let u=n[d].trim();if(r){if(u===""||u.startsWith(">"))continue;a=d;break}}return a===-1?"":n.slice(a).join(`
`).trim()}function T(l){let e=l.trim();return/^>\s*\*\*[^*]+:\*\*/.test(e)}function k(l,e="Therapist"){let i=R(e);return`

${l.split(`
`).map((n,a)=>a===0?`${i} ${n}`:n.trim()===""?">":`> ${n}`).join(`
`)}

`}function w(l){let e=-1,i=0;for(let a of $){let r=l.indexOf(a);r!==-1&&(e===-1||r<e)&&(e=r,i=a.split(" ")[0].length)}if(e===-1)return null;let s=l.substring(e).split(`
`),n=s.length;for(let a=1;a<s.length;a++){let d=s[a].match(/^(#{1,6})\s/);if(d&&d[1].length<=i){n=a;break}}return s.slice(1,n).join(`
`).trim()}function x(l){let e=l.toLowerCase();return l.includes("?")?!0:["you know","right?","what do you think","any thoughts","help me","i need","should i","could i","what should","what would","advice","suggest","opinion","perspective","thoughts?","ideas?"].some(t=>e.includes(t))}var y=class extends g.Plugin{constructor(){super(...arguments);this.isProcessing=!1;this.statusBarEl=null;this.pendingResponse=null;this.indicatorEl=null}async onload(){await this.loadSettings(),this.lettaService=new m(this.settings.lettaUrl,this.settings.apiKey),this.addSettingTab(new p(this.app,this));let i=(0,g.debounce)((t,s)=>this.handleEditorChange(t,s),this.settings.debounceMs,!0);this.registerEvent(this.app.workspace.on("editor-change",(t,s)=>{this.settings.enabled&&this.settings.agentId&&i(t,s)})),this.addCommand({id:"trigger-therapist",name:"Ask therapist to respond",editorCallback:(t,s)=>{this.handleEditorChange(t,s,!0)}}),this.addCommand({id:"insert-response",name:"Insert therapist thought",editorCallback:t=>{this.pendingResponse?this.insertPendingResponse():new g.Notice("No thought ready")}}),this.addCommand({id:"toggle-therapist",name:"Toggle therapist on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.settings.enabled||(this.pendingResponse=null,this.updateIndicator("hidden")),this.saveSettings(),this.updateStatusBar();let t=this.settings.enabled?"enabled":"disabled";new g.Notice(`Therapist ${t}`)}}),this.statusBarEl=this.addStatusBarItem(),this.statusBarEl.addClass("mod-clickable"),this.statusBarEl.onClickEvent(()=>{this.pendingResponse&&this.insertPendingResponse()}),this.updateStatusBar(),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.checkCurrentNote()})),this.registerEvent(this.app.workspace.on("file-open",()=>{this.checkCurrentNote()})),this.checkCurrentNote(),console.log("Therapist plugin loaded")}checkCurrentNote(){if(this.pendingResponse=null,this.updateIndicator("hidden"),!this.settings.enabled||!this.settings.agentId){this.updateStatusBar();return}let i=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(!i){this.updateStatusBar("no-journal");return}let t=i.editor.getValue(),s=w(t)!==null;this.updateStatusBar(s?"listening":"no-journal")}updateStatusBar(i){if(this.statusBarEl){if(!this.settings.enabled){this.statusBarEl.setText("\u25CB Therapist off"),this.statusBarEl.setAttribute("aria-label","Therapist is disabled");return}if(!this.settings.agentId){this.statusBarEl.setText("\u25CB No agent"),this.statusBarEl.setAttribute("aria-label","No therapist agent configured");return}switch(i){case"thinking":this.statusBarEl.setText("\u25C9 Thinking..."),this.statusBarEl.setAttribute("aria-label","Therapist is processing");break;case"ready":this.statusBarEl.setText("\u{1F4AD} Ready"),this.statusBarEl.setAttribute("aria-label","Click to insert response");break;case"no-journal":this.statusBarEl.setText("\u25E6 No journal section"),this.statusBarEl.setAttribute("aria-label","Add a ## Journal header to enable");break;case"off":this.statusBarEl.setText("\u25CB Therapist off"),this.statusBarEl.setAttribute("aria-label","Therapist is disabled");break;default:this.statusBarEl.setText("\u25CF Listening"),this.statusBarEl.setAttribute("aria-label","Therapist is monitoring")}}}async handleEditorChange(i,t,s=!1){if(this.isProcessing)return;if(!this.settings.agentId){console.error("No agent configured - create one in settings");return}let n=i.getValue(),a=w(n);if(!a){this.updateStatusBar("no-journal");return}this.updateStatusBar("listening");let r=S(a);if(!r||T(r))return;let d=x(r);this.isProcessing=!0,this.updateStatusBar("thinking"),this.updateIndicator("thinking");try{let c=d||s?`[User is asking for your input]

`:`[User is journaling - respond only if you have something valuable to add]

`,u=await this.lettaService.sendMessage(this.settings.agentId,c+r),v=(u==null?void 0:u.trim())||"";v&&v!=="[listening]"?(this.pendingResponse=u,this.updateStatusBar("ready"),this.updateIndicator("ready")):(this.updateStatusBar("listening"),this.updateIndicator("hidden"))}catch(c){console.error("Error getting therapist response:",c),this.updateStatusBar("listening"),this.updateIndicator("hidden")}finally{this.isProcessing=!1}}insertPendingResponse(){if(!this.pendingResponse)return;let i=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(!i){new g.Notice("No active editor");return}let t=i.editor,n=t.getCursor().line;t.setCursor({line:n,ch:t.getLine(n).length}),t.replaceSelection(k(this.pendingResponse,this.settings.therapistName)),this.pendingResponse=null,this.updateStatusBar("listening"),this.updateIndicator("hidden")}updateIndicator(i){let t=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(i==="hidden"||!t){this.indicatorEl&&(this.indicatorEl.remove(),this.indicatorEl=null);return}let s=t.contentEl;if(!this.indicatorEl){this.indicatorEl=document.createElement("div"),this.indicatorEl.className="therapist-indicator";let a=document.createElement("div");a.className="therapist-orb",a.addEventListener("click",()=>{this.pendingResponse&&this.insertPendingResponse()}),this.indicatorEl.appendChild(a)}let n=this.indicatorEl.querySelector(".therapist-orb");n&&n.classList.toggle("is-thinking",i==="thinking"),s.contains(this.indicatorEl)||s.appendChild(this.indicatorEl),this.indicatorEl.classList.add("is-visible")}onunload(){this.updateIndicator("hidden"),console.log("Therapist plugin unloaded")}async loadSettings(){this.settings=Object.assign({},b,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
