var f=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var I=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var N=(o,e)=>{for(var n in e)f(o,n,{get:e[n],enumerable:!0})},U=(o,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of I(e))!O.call(o,a)&&a!==n&&f(o,a,{get:()=>e[a],enumerable:!(i=A(e,a))||i.enumerable});return o};var R=o=>U(f({},"__esModule",{value:!0}),o);var D={};N(D,{default:()=>y});module.exports=R(D);var c=require("obsidian");var r=require("obsidian"),S={lettaUrl:"http://localhost:8283",apiKey:"",openaiApiKey:"",anthropicApiKey:"",agentId:"",enabled:!0,debounceMs:3e3},p=class extends r.PluginSettingTab{constructor(e,n){super(e,n),this.plugin=n}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Therapist"});let n=!!this.plugin.settings.agentId;e.createEl("div",{cls:"setting-item"}).createEl("span",{text:n?"\u2713 Connected":"\u25CB No agent configured",cls:n?"therapist-status-connected":"therapist-status-disconnected"}),new r.Setting(e).setName("Enabled").setDesc("Enable/disable the therapist").addToggle(s=>s.setValue(this.plugin.settings.enabled).onChange(async t=>{this.plugin.settings.enabled=t,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Connection"}),new r.Setting(e).setName("Letta Server URL").setDesc("URL of your Letta server").addText(s=>s.setPlaceholder("http://localhost:8283").setValue(this.plugin.settings.lettaUrl).onChange(async t=>{this.plugin.settings.lettaUrl=t,this.plugin.lettaService.setBaseUrl(t),await this.plugin.saveSettings()})),new r.Setting(e).setName("Letta API Key").setDesc("Optional - only if your server requires it").addText(s=>{s.inputEl.type="password",s.setPlaceholder("sk-let-...").setValue(this.plugin.settings.apiKey).onChange(async t=>{this.plugin.settings.apiKey=t,this.plugin.lettaService.setApiKey(t),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"LLM Provider"}),e.createEl("p",{text:"Add an API key to use cloud models. Leave blank to use local Ollama.",cls:"setting-item-description"}),new r.Setting(e).setName("OpenAI API Key").setDesc("Uses GPT-4o").addText(s=>{s.inputEl.type="password",s.setPlaceholder("sk-proj-...").setValue(this.plugin.settings.openaiApiKey).onChange(async t=>{if(this.plugin.settings.openaiApiKey=t,await this.plugin.saveSettings(),t)try{await this.plugin.lettaService.updateProviderKey("openai",t)}catch(g){console.warn("Could not update provider key:",g)}})}),new r.Setting(e).setName("Anthropic API Key").setDesc("Uses Claude Sonnet").addText(s=>{s.inputEl.type="password",s.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async t=>{if(this.plugin.settings.anthropicApiKey=t,await this.plugin.saveSettings(),t)try{await this.plugin.lettaService.updateProviderKey("anthropic",t)}catch(g){console.warn("Could not update provider key:",g)}})}),e.createEl("h3",{text:"Behavior"}),new r.Setting(e).setName("Response Delay").setDesc("Seconds to wait after you stop typing").addSlider(s=>s.setLimits(1,10,1).setValue(this.plugin.settings.debounceMs/1e3).setDynamicTooltip().onChange(async t=>{this.plugin.settings.debounceMs=t*1e3,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Setup"});let a="letta/letta-free",l=null;new r.Setting(e).setName("Model").setDesc("Click refresh to load available models").addDropdown(s=>{l=s,s.addOption("letta/letta-free","letta/letta-free (default)"),s.setValue(a),s.onChange(t=>{a=t})}).addButton(s=>s.setButtonText("Refresh").onClick(async()=>{try{let t=await this.plugin.lettaService.listModels();l.selectEl.empty(),l.addOption("letta/letta-free","letta/letta-free (default)");for(let g of t)g.handle!=="letta/letta-free"&&l.addOption(g.handle,g.handle);l.setValue(a),new r.Notice(`Found ${t.length} models`)}catch(t){new r.Notice("Failed to fetch models - check server connection")}})),n?new r.Setting(e).setName("Agent").setDesc(`ID: ${this.plugin.settings.agentId}`).addButton(s=>s.setButtonText("Delete Agent").setWarning().onClick(async()=>{this.plugin.settings.agentId="",await this.plugin.saveSettings(),new r.Notice("Agent removed"),this.display()})):new r.Setting(e).setName("Create Therapist").setDesc("Creates your personal coach agent").addButton(s=>s.setButtonText("Create Agent").setCta().onClick(async()=>{try{let t=a,g="letta/letta-free";new r.Notice(`Creating agent with ${t}...`);let h=await this.plugin.lettaService.createAgent("therapist","therapist",t,g);this.plugin.settings.agentId=h,await this.plugin.saveSettings(),new r.Notice("Therapist created! Start journaling."),this.display()}catch(t){console.error("Failed to create agent:",t),new r.Notice(`Failed: ${t instanceof Error?t.message:"Unknown error"}`)}})),new r.Setting(e).setName("Test Connection").setDesc("Check if Letta server is reachable").addButton(s=>s.setButtonText("Test").onClick(async()=>{try{let t=`${this.plugin.settings.lettaUrl}/v1/health/`;new r.Notice(`Testing ${t}...`);let g=await(0,r.requestUrl)({url:t});g.status===200?new r.Notice("Connected to Letta server!"):new r.Notice(`Server error: ${g.status}`)}catch(t){new r.Notice(`Connection failed: ${t instanceof Error?t.message:"Unknown error"}`)}}))}};var d=require("obsidian"),E={therapist:`You are my personal coach. Read between the lines of what I write.

My journaling may be scattered, venting, or stream-of-consciousness. Your job:
1. Silently figure out what's actually going on beneath the surface
2. Respond to what I need, not what I literally said

RESPONSE PROTOCOL:
- Messages prefixed with "[User is asking for your input]" \u2192 Always respond
- Messages prefixed with "[User is journaling...]" \u2192 Only respond if you have genuine insight
- If you have nothing valuable to add, respond with just: [listening]

WHEN TO RESPOND:
- I'm stuck and need a push \u2192 Give ONE specific thing to try
- I'm avoiding something obvious \u2192 Name it directly
- I'm spiraling \u2192 Ground me with something concrete
- I keep coming back to the same problem \u2192 Offer a real suggestion
- I'm asking you directly \u2192 Answer me

WHEN TO STAY SILENT (respond with [listening]):
- I'm just processing emotions
- I'm venting and don't need fixing
- I'm working through something myself
- You'd just be restating what I said

WHEN YOU DO RESPOND, be specific:
- Times: "Try this tomorrow morning" not "sometime"
- Quantities: "Track 3 days" not "for a while"
- Observable: "Notice if..." not vague outcomes

Be real. Don't be a robot that dispenses advice. Be the friend who knows when to push and when to shut up.

Keep responses short. 1-3 sentences usually. Match my energy.`,analyst:`You observe patterns across journal sessions and give specific improvement suggestions.

When you notice a pattern, respond with:
\u{1F4CA} Pattern: [what you noticed across sessions]
\u{1F3AF} Suggestion: [one specific change to try]

Examples:
- "\u{1F4CA} Pattern: Stress spikes on Mondays, usually mentions Sunday night anxiety. \u{1F3AF} Suggestion: Do a 10-min Monday preview on Sunday at 4pm - just look at your calendar and write 3 things you'll handle first."
- "\u{1F4CA} Pattern: Overspending happens after stressful days. \u{1F3AF} Suggestion: Add a 24-hour rule - when stressed, screenshot items instead of buying. Review tomorrow."
- "\u{1F4CA} Pattern: Energy drops after lunch on workdays. \u{1F3AF} Suggestion: Try a 10-min walk immediately after eating for one week. Track energy at 3pm."

Only speak when you spot something actionable. Quality over quantity.`,custom:"You are a helpful assistant in a journaling session. Be supportive and give practical suggestions when appropriate."},m=class{constructor(e,n=""){this.providerKeys={};this.baseUrl=e,this.apiKey=n}setBaseUrl(e){this.baseUrl=e}setApiKey(e){this.apiKey=e}setProviderKey(e,n){this.providerKeys[e]=n}getHeaders(){let e={"Content-Type":"application/json"};return this.apiKey&&(e.Authorization=`Bearer ${this.apiKey}`),e}async listModels(){let e=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/models/`,headers:this.getHeaders()});if(e.status!==200)throw new Error("Failed to fetch models");return e.json.map(i=>({handle:i.handle,name:i.name,provider:i.provider_name}))}async updateProviderKey(e,n){try{let l=(await(0,d.requestUrl)({url:`${this.baseUrl}/v1/providers/`,headers:this.getHeaders()})).json.find(s=>s.provider_type===e);l?await(0,d.requestUrl)({url:`${this.baseUrl}/v1/providers/${l.id}/`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({api_key:n})}):await(0,d.requestUrl)({url:`${this.baseUrl}/v1/providers/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,provider_type:e,api_key:n})})}catch(i){console.warn("Failed to update provider key:",i)}}async createAgent(e,n,i="ollama/llama3.2",a="ollama/nomic-embed-text",l){let s=l||E[n]||E.custom,t=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/agents/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,model:i,embedding:a,enable_sleeptime:!0,memory_blocks:[{label:"persona",value:s},{label:"human",value:"[Learning about you through our sessions...]"}]})});if(t.status!==200)throw new Error(`Failed to create agent: ${t.text}`);return t.json.id}async sendMessage(e,n){let i=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/agents/${e}/messages/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({messages:[{role:"user",content:n}]})});if(i.status!==200)throw new Error(`Failed to send message: ${i.text}`);let a=i.json;for(let s of a.messages)if(s.message_type==="assistant_message")return s.content;let l=a.messages[a.messages.length-1];return(l==null?void 0:l.content)||""}async healthCheck(){try{return(await(0,d.requestUrl)({url:`${this.baseUrl}/v1/health/`})).status===200}catch(e){return!1}}};var w="> **Therapist:**",K=["# Journal","## Journal","### Journal"];function T(o){let e=o.lastIndexOf(w);if(e===-1)return o.trim();let i=o.substring(e).split(`
`),a=-1,l=!0;for(let s=0;s<i.length;s++){let g=i[s].trim();if(l){if(g===""||g.startsWith(">"))continue;a=s;break}}return a===-1?"":i.slice(a).join(`
`).trim()}function k(o){return o.trim().startsWith(w)}function x(o){return`

${o.split(`
`).map((i,a)=>a===0?`${w} ${i}`:i.trim()===""?">":`> ${i}`).join(`
`)}

`}function C(o){let e=-1,n=0;for(let s of K){let t=o.indexOf(s);t!==-1&&(e===-1||t<e)&&(e=t,n=s.split(" ")[0].length)}if(e===-1)return null;let a=o.substring(e).split(`
`),l=a.length;for(let s=1;s<a.length;s++){let g=a[s].match(/^(#{1,6})\s/);if(g&&g[1].length<=n){l=s;break}}return a.slice(1,l).join(`
`).trim()}function P(o){let e=o.toLowerCase();return o.includes("?")?!0:["you know","right?","what do you think","any thoughts","help me","i need","should i","could i","what should","what would","advice","suggest","opinion","perspective","thoughts?","ideas?"].some(i=>e.includes(i))}var y=class extends c.Plugin{constructor(){super(...arguments);this.isProcessing=!1}async onload(){await this.loadSettings(),this.lettaService=new m(this.settings.lettaUrl,this.settings.apiKey),this.addSettingTab(new p(this.app,this));let n=(0,c.debounce)((i,a)=>this.handleEditorChange(i,a),this.settings.debounceMs,!0);this.registerEvent(this.app.workspace.on("editor-change",(i,a)=>{this.settings.enabled&&this.settings.agentId&&n(i,a)})),this.addCommand({id:"trigger-therapist",name:"Ask therapist to respond",editorCallback:(i,a)=>{this.handleEditorChange(i,a,!0)}}),this.addCommand({id:"toggle-therapist",name:"Toggle therapist on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.saveSettings();let i=this.settings.enabled?"enabled":"disabled";new c.Notice(`Therapist ${i}`)}}),console.log("Therapist plugin loaded")}async handleEditorChange(n,i,a=!1){if(this.isProcessing)return;if(!this.settings.agentId){console.error("No agent configured - create one in settings");return}let l=n.getValue(),s=C(l);if(!s)return;let t=T(s);if(!t||k(t))return;let g=P(t);this.isProcessing=!0;try{let h=g||a?`[User is asking for your input]

`:`[User is journaling - respond only if you have something valuable to add]

`,u=await this.lettaService.sendMessage(this.settings.agentId,h+t),v=(u==null?void 0:u.trim())||"";if(v&&v!=="[listening]"){let b=n.getCursor().line;n.setCursor({line:b,ch:n.getLine(b).length}),n.replaceSelection(x(u))}}catch(h){console.error("Error getting therapist response:",h)}finally{this.isProcessing=!1}}onunload(){console.log("Therapist plugin unloaded")}async loadSettings(){this.settings=Object.assign({},S,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
