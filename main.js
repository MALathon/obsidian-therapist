var f=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var I=(l,e)=>{for(var n in e)f(l,n,{get:e[n],enumerable:!0})},C=(l,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of E(e))!k.call(l,a)&&a!==n&&f(l,a,{get:()=>e[a],enumerable:!(i=P(e,a))||i.enumerable});return l};var N=l=>C(f({},"__esModule",{value:!0}),l);var x={};I(x,{default:()=>u});module.exports=N(x);var m=require("obsidian");var g=require("obsidian"),b={lettaUrl:"http://localhost:8283",apiKey:"",openaiApiKey:"",anthropicApiKey:"",agents:[],multiAgentMode:"single",primaryAgentId:"",enabled:!0,debounceMs:3e3},h=class extends g.PluginSettingTab{constructor(e,n){super(e,n),this.plugin=n}display(){let{containerEl:e}=this;if(e.empty(),e.createEl("h2",{text:"Therapist Settings"}),new g.Setting(e).setName("Enabled").setDesc("Enable/disable the therapist").addToggle(s=>s.setValue(this.plugin.settings.enabled).onChange(async t=>{this.plugin.settings.enabled=t,await this.plugin.saveSettings()})),new g.Setting(e).setName("Letta Server URL").setDesc("URL of your Letta server").addText(s=>s.setPlaceholder("http://localhost:8283").setValue(this.plugin.settings.lettaUrl).onChange(async t=>{this.plugin.settings.lettaUrl=t,this.plugin.lettaService.setBaseUrl(t),await this.plugin.saveSettings()})),new g.Setting(e).setName("API Key").setDesc("Letta server API key (sk-let-...)").addText(s=>{s.inputEl.type="password",s.setPlaceholder("sk-let-...").setValue(this.plugin.settings.apiKey).onChange(async t=>{this.plugin.settings.apiKey=t,this.plugin.lettaService.setApiKey(t),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"Cloud Provider Keys"}),new g.Setting(e).setName("OpenAI API Key").setDesc("For GPT-4, GPT-4o models").addText(s=>{s.inputEl.type="password",s.setPlaceholder("sk-proj-...").setValue(this.plugin.settings.openaiApiKey).onChange(async t=>{this.plugin.settings.openaiApiKey=t,this.plugin.lettaService.setProviderKey("openai",t),await this.plugin.saveSettings()})}),new g.Setting(e).setName("Anthropic API Key").setDesc("For Claude models").addText(s=>{s.inputEl.type="password",s.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async t=>{this.plugin.settings.anthropicApiKey=t,this.plugin.lettaService.setProviderKey("anthropic",t),await this.plugin.saveSettings()})}),new g.Setting(e).setName("Response Delay").setDesc("Seconds to wait after you stop typing before therapist responds").addSlider(s=>s.setLimits(1,10,1).setValue(this.plugin.settings.debounceMs/1e3).setDynamicTooltip().onChange(async t=>{this.plugin.settings.debounceMs=t*1e3,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Multi-Agent Configuration"}),new g.Setting(e).setName("Agent Mode").setDesc("How agents work together").addDropdown(s=>s.addOption("single","Single Agent").addOption("sequential","Sequential (agents respond in order)").addOption("parallel","Parallel (all agents respond)").setValue(this.plugin.settings.multiAgentMode).onChange(async t=>{this.plugin.settings.multiAgentMode=t,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.multiAgentMode==="single"&&this.plugin.settings.agents.length>0&&new g.Setting(e).setName("Primary Agent").setDesc("Which agent responds to your journal").addDropdown(s=>{for(let t of this.plugin.settings.agents)s.addOption(t.id,`${t.name} (${t.role})`);s.setValue(this.plugin.settings.primaryAgentId),s.onChange(async t=>{this.plugin.settings.primaryAgentId=t,await this.plugin.saveSettings()})}),this.plugin.settings.agents.length>0){e.createEl("h4",{text:"Your Agents"});for(let s of this.plugin.settings.agents){let t=new g.Setting(e).setName(`${s.name} (${s.role})`).setDesc(`Model: ${s.model}`);this.plugin.settings.multiAgentMode!=="single"&&t.addToggle(o=>o.setValue(s.enabled).setTooltip("Enable this agent").onChange(async d=>{s.enabled=d,await this.plugin.saveSettings()})),t.addButton(o=>o.setButtonText("Delete").setWarning().onClick(async()=>{var d;this.plugin.settings.agents=this.plugin.settings.agents.filter(p=>p.id!==s.id),this.plugin.settings.primaryAgentId===s.id&&(this.plugin.settings.primaryAgentId=((d=this.plugin.settings.agents[0])==null?void 0:d.id)||""),await this.plugin.saveSettings(),this.display()}))}}e.createEl("h4",{text:"Create New Agent"});let n="ollama/llama3.2",i="therapist",a="therapist";new g.Setting(e).setName("Agent Name").addText(s=>s.setPlaceholder("therapist").setValue(i).onChange(t=>{i=t})),new g.Setting(e).setName("Role").setDesc("Agent's specialized function").addDropdown(s=>s.addOption("therapist","Therapist - primary responder").addOption("analyst","Analyst - pattern recognition").addOption("custom","Custom").setValue(a).onChange(t=>{a=t,this.display()}));let r="";new g.Setting(e).setName("Persona").setDesc("Customize how this agent behaves (optional - leave blank for default)").addTextArea(s=>s.setPlaceholder("You are my therapist...").setValue(r).onChange(t=>{r=t})),new g.Setting(e).setName("Model").setDesc("LLM to power this agent").addText(s=>s.setPlaceholder("ollama/llama3.2 or openai/gpt-4o").setValue(n).onChange(t=>{n=t})),new g.Setting(e).setName("").addButton(s=>s.setButtonText("Create Agent").setCta().onClick(async()=>{try{let t=await this.plugin.lettaService.createAgent(i||a,a,n,void 0,r||void 0),o={id:t,model:n,name:i||a,role:a,customPersona:r||void 0,enabled:!0,order:this.plugin.settings.agents.length};this.plugin.settings.agents.push(o),this.plugin.settings.primaryAgentId||(this.plugin.settings.primaryAgentId=t),await this.plugin.saveSettings(),this.display()}catch(t){console.error("Failed to create agent:",t)}})),new g.Setting(e).setName("Available Models").setDesc("Fetch list of models from server").addButton(s=>s.setButtonText("Refresh Models").onClick(async()=>{try{let o=(await this.plugin.lettaService.listModels()).map(d=>d.handle).join(`
`);console.log(`Available models:
`+o)}catch(t){console.error("Failed to fetch models:",t)}}))}};var A={therapist:`You are my personal coach. Read between the lines of what I write.

My journaling may be scattered, venting, or stream-of-consciousness. Your job:
1. Silently figure out what's actually going on beneath the surface
2. Respond to what I need, not what I literally said

WHEN TO GIVE ACTIONS (pick your moments):
- I'm stuck and need a push \u2192 Give ONE specific thing to try
- I'm avoiding something obvious \u2192 Name it directly
- I'm spiraling \u2192 Ground me with something concrete
- I keep coming back to the same problem \u2192 It's time for a real suggestion

WHEN TO JUST LISTEN:
- I'm processing emotions \u2192 Acknowledge, don't fix
- I'm venting \u2192 Let me get it out
- I'm celebrating something \u2192 Share the moment
- I'm figuring it out myself \u2192 Get out of the way

WHEN YOU DO SUGGEST ACTIONS, be specific:
- Times: "Try this tomorrow morning" not "sometime"
- Quantities: "Track 3 days" not "for a while"
- Observable: "Notice if..." not vague outcomes

Be real. Don't be a robot that dispenses advice. Be the friend who knows when to push and when to shut up.

Keep responses short. 1-3 sentences usually. Match my energy.`,analyst:`You observe patterns across journal sessions and give specific improvement suggestions.

When you notice a pattern, respond with:
\u{1F4CA} Pattern: [what you noticed across sessions]
\u{1F3AF} Suggestion: [one specific change to try]

Examples:
- "\u{1F4CA} Pattern: Stress spikes on Mondays, usually mentions Sunday night anxiety. \u{1F3AF} Suggestion: Do a 10-min Monday preview on Sunday at 4pm - just look at your calendar and write 3 things you'll handle first."
- "\u{1F4CA} Pattern: Overspending happens after stressful days. \u{1F3AF} Suggestion: Add a 24-hour rule - when stressed, screenshot items instead of buying. Review tomorrow."
- "\u{1F4CA} Pattern: Energy drops after lunch on workdays. \u{1F3AF} Suggestion: Try a 10-min walk immediately after eating for one week. Track energy at 3pm."

Only speak when you spot something actionable. Quality over quantity.`,custom:"You are a helpful assistant in a journaling session. Be supportive and give practical suggestions when appropriate."},c=class{constructor(e,n=""){this.providerKeys={};this.baseUrl=e,this.apiKey=n}setBaseUrl(e){this.baseUrl=e}setApiKey(e){this.apiKey=e}setProviderKey(e,n){this.providerKeys[e]=n}getHeaders(){let e={"Content-Type":"application/json"};return this.apiKey&&(e.Authorization=`Bearer ${this.apiKey}`),e}async listModels(){let e=await fetch(`${this.baseUrl}/v1/models/`,{headers:this.getHeaders()});if(!e.ok)throw new Error("Failed to fetch models");return(await e.json()).map(i=>({handle:i.handle,name:i.name,provider:i.provider_name}))}async updateProviderKey(e,n){let i=await fetch(`${this.baseUrl}/v1/providers/${e}`,{method:"PUT",headers:this.getHeaders(),body:JSON.stringify({api_key:n})});if(!i.ok){let a=await i.text();console.warn(`Failed to update provider key: ${a}`)}}async createAgent(e,n,i="ollama/llama3.2",a="ollama/nomic-embed-text",r){let s=r||A[n]||A.custom,t=await fetch(`${this.baseUrl}/v1/agents`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,model:i,embedding:a,enable_sleeptime:!0,memory_blocks:[{label:"persona",value:s},{label:"human",value:"[Learning about you through our sessions...]"}]})});if(!t.ok){let d=await t.text();throw new Error(`Failed to create agent: ${d}`)}return(await t.json()).id}async sendMessage(e,n){let i=await fetch(`${this.baseUrl}/v1/agents/${e}/messages`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({messages:[{role:"user",content:n}]})});if(!i.ok){let s=await i.text();throw new Error(`Failed to send message: ${s}`)}let a=await i.json();for(let s of a.messages)if(s.message_type==="assistant_message")return s.content;let r=a.messages[a.messages.length-1];return(r==null?void 0:r.content)||""}async healthCheck(){try{return(await fetch(`${this.baseUrl}/v1/health`)).ok}catch(e){return!1}}};var w="> **Therapist:**";function v(l){let e=l.lastIndexOf(w);if(e===-1)return l.trim();let i=l.substring(e).match(/\n\n(?!>)(.+)/s);return i?i[1].trim():""}function S(l){return l.trim().startsWith(w)}function T(l){return`

${w} ${l}

`}var u=class extends m.Plugin{constructor(){super(...arguments);this.isProcessing=!1}async onload(){await this.loadSettings(),this.lettaService=new c(this.settings.lettaUrl,this.settings.apiKey),this.addSettingTab(new h(this.app,this));let n=(0,m.debounce)((i,a)=>this.handleEditorChange(i,a),this.settings.debounceMs,!0);this.registerEvent(this.app.workspace.on("editor-change",(i,a)=>{this.settings.enabled&&n(i,a)})),this.addCommand({id:"trigger-therapist",name:"Ask therapist to respond",editorCallback:(i,a)=>{this.handleEditorChange(i,a)}}),this.addCommand({id:"toggle-therapist",name:"Toggle therapist on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.saveSettings();let i=this.settings.enabled?"enabled":"disabled";console.log(`Therapist ${i}`)}}),console.log("Therapist plugin loaded")}async handleEditorChange(n,i){if(this.isProcessing)return;let a=this.getEnabledAgents();if(a.length===0){console.error("No agents configured - create one in settings");return}let r=n.getValue(),s=v(r);if(s&&!S(s)){this.isProcessing=!0;try{let t=await this.getAgentResponses(a,s);if(t.length>0){let d=n.getCursor().line;n.setCursor({line:d,ch:n.getLine(d).length});let p=t.filter(y=>y.content.trim()).map(y=>y.content).join(`

`);p&&n.replaceSelection(T(p))}}catch(t){console.error("Error getting therapist response:",t)}finally{this.isProcessing=!1}}}getEnabledAgents(){let{agents:n,multiAgentMode:i,primaryAgentId:a}=this.settings;if(i==="single"){let r=n.find(s=>s.id===a);return r?[r]:n.slice(0,1)}return n.filter(r=>r.enabled).sort((r,s)=>r.order-s.order)}async getAgentResponses(n,i){let{multiAgentMode:a}=this.settings;if(a==="parallel"){let t=n.map(async o=>{try{let d=await this.lettaService.sendMessage(o.id,i);return{agentId:o.id,name:o.name,content:d}}catch(d){return console.error(`Agent ${o.name} failed:`,d),{agentId:o.id,name:o.name,content:""}}});return Promise.all(t)}let r=[],s=i;for(let t of n)try{let o=await this.lettaService.sendMessage(t.id,s);r.push({agentId:t.id,name:t.name,content:o}),o.trim()&&(s+=`

[${t.name}]: ${o}`)}catch(o){console.error(`Agent ${t.name} failed:`,o)}return r}onunload(){console.log("Therapist plugin unloaded")}async loadSettings(){this.settings=Object.assign({},b,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
