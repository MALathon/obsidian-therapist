var d=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var T=Object.prototype.hasOwnProperty;var v=(n,e)=>{for(var t in e)d(n,t,{get:e[t],enumerable:!0})},x=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of S(e))!T.call(n,i)&&i!==t&&d(n,i,{get:()=>e[i],enumerable:!(s=f(e,i))||s.enumerable});return n};var E=n=>x(d({},"__esModule",{value:!0}),n);var I={};v(I,{default:()=>h});module.exports=E(I);var c=require("obsidian");var a=require("obsidian"),m={lettaUrl:"http://localhost:8283",apiKey:"",agentId:"",enabled:!0,debounceMs:3e3,model:"ollama/llama3.2"},l=class extends a.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Therapist Settings"}),new a.Setting(e).setName("Enabled").setDesc("Enable/disable the therapist").addToggle(t=>t.setValue(this.plugin.settings.enabled).onChange(async s=>{this.plugin.settings.enabled=s,await this.plugin.saveSettings()})),new a.Setting(e).setName("Letta Server URL").setDesc("URL of your Letta server").addText(t=>t.setPlaceholder("http://localhost:8283").setValue(this.plugin.settings.lettaUrl).onChange(async s=>{this.plugin.settings.lettaUrl=s,this.plugin.lettaService.setBaseUrl(s),await this.plugin.saveSettings()})),new a.Setting(e).setName("API Key").setDesc("Letta server API key (sk-let-...)").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-let-...").setValue(this.plugin.settings.apiKey).onChange(async s=>{this.plugin.settings.apiKey=s,this.plugin.lettaService.setApiKey(s),await this.plugin.saveSettings()})}),new a.Setting(e).setName("Response Delay").setDesc("Seconds to wait after you stop typing before therapist responds").addSlider(t=>t.setLimits(1,10,1).setValue(this.plugin.settings.debounceMs/1e3).setDynamicTooltip().onChange(async s=>{this.plugin.settings.debounceMs=s*1e3,await this.plugin.saveSettings()})),new a.Setting(e).setName("Model").setDesc("LLM model to use (e.g., ollama/llama3.2)").addText(t=>t.setPlaceholder("ollama/llama3.2").setValue(this.plugin.settings.model).onChange(async s=>{this.plugin.settings.model=s,await this.plugin.saveSettings()})),new a.Setting(e).setName("Agent ID").setDesc("Letta agent ID (auto-generated on first run)").addText(t=>t.setPlaceholder("agent-xxx").setValue(this.plugin.settings.agentId).onChange(async s=>{this.plugin.settings.agentId=s,await this.plugin.saveSettings()})),new a.Setting(e).setName("Reset Agent").setDesc("Create a new therapist agent (loses memory)").addButton(t=>t.setButtonText("Reset").setWarning().onClick(async()=>{this.plugin.settings.agentId="",await this.plugin.saveSettings(),await this.plugin.initializeAgent(),this.display()}))}};var g=class{constructor(e,t=""){this.baseUrl=e,this.apiKey=t}setBaseUrl(e){this.baseUrl=e}setApiKey(e){this.apiKey=e}getHeaders(){let e={"Content-Type":"application/json"};return this.apiKey&&(e.Authorization=`Bearer ${this.apiKey}`),e}async createAgent(){let e=await fetch(`${this.baseUrl}/v1/agents`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:"therapist",model:"ollama/llama3.2",embedding:"ollama/nomic-embed-text",enable_sleeptime:!0,memory_blocks:[{label:"persona",value:`You are my therapist. We're in a journaling session.

As I write about my day, you:
- Ask questions to help me process what happened
- Point out patterns you've noticed from past sessions
- Give direct advice when it would be helpful
- Challenge my thinking when I'm distorting reality
- Help me understand myself better

Keep responses concise - 1-3 sentences usually. This is a conversation, not a lecture.
Be warm but direct. Don't just reflect - actually help me.`},{label:"human",value:"[Learning about you through our sessions...]"}]})});if(!e.ok){let s=await e.text();throw new Error(`Failed to create agent: ${s}`)}return(await e.json()).id}async sendMessage(e,t){let s=await fetch(`${this.baseUrl}/v1/agents/${e}/messages`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({messages:[{role:"user",content:t}]})});if(!s.ok){let r=await s.text();throw new Error(`Failed to send message: ${r}`)}let i=await s.json();for(let r of i.messages)if(r.message_type==="assistant_message")return r.content;let o=i.messages[i.messages.length-1];return(o==null?void 0:o.content)||""}async healthCheck(){try{return(await fetch(`${this.baseUrl}/v1/health`)).ok}catch(e){return!1}}};var p="> **Therapist:**";function y(n){let e=n.lastIndexOf(p);if(e===-1)return n.trim();let s=n.substring(e).match(/\n\n(?!>)(.+)/s);return s?s[1].trim():""}function w(n){return n.trim().startsWith(p)}function b(n){return`

${p} ${n}

`}var h=class extends c.Plugin{constructor(){super(...arguments);this.isProcessing=!1}async onload(){await this.loadSettings(),this.lettaService=new g(this.settings.lettaUrl,this.settings.apiKey),this.addSettingTab(new l(this.app,this));let t=(0,c.debounce)((s,i)=>this.handleEditorChange(s,i),this.settings.debounceMs,!0);this.registerEvent(this.app.workspace.on("editor-change",(s,i)=>{this.settings.enabled&&t(s,i)})),this.addCommand({id:"trigger-therapist",name:"Ask therapist to respond",editorCallback:(s,i)=>{this.handleEditorChange(s,i)}}),this.addCommand({id:"toggle-therapist",name:"Toggle therapist on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.saveSettings();let s=this.settings.enabled?"enabled":"disabled";console.log(`Therapist ${s}`)}}),this.settings.agentId||await this.initializeAgent(),console.log("Therapist plugin loaded")}async handleEditorChange(t,s){if(this.isProcessing)return;if(!this.settings.agentId){console.error("No agent configured");return}let i=t.getValue(),o=y(i);if(o&&!w(o)){this.isProcessing=!0;try{let r=await this.lettaService.sendMessage(this.settings.agentId,o);if(r){let u=t.getCursor().line;t.setCursor({line:u,ch:t.getLine(u).length}),t.replaceSelection(b(r))}}catch(r){console.error("Error getting therapist response:",r)}finally{this.isProcessing=!1}}}async initializeAgent(){try{console.log("Creating therapist agent...");let t=await this.lettaService.createAgent();this.settings.agentId=t,await this.saveSettings(),console.log("Therapist agent created:",t)}catch(t){console.error("Failed to create agent:",t)}}onunload(){console.log("Therapist plugin unloaded")}async loadSettings(){this.settings=Object.assign({},m,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
