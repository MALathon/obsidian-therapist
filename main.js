var c=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var T=(a,e)=>{for(var i in e)c(a,i,{get:e[i],enumerable:!0})},P=(a,e,i,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of A(e))!S.call(a,t)&&t!==i&&c(a,t,{get:()=>e[t],enumerable:!(n=b(e,t))||n.enumerable});return a};var C=a=>P(c({},"__esModule",{value:!0}),a);var K={};T(K,{default:()=>h});module.exports=C(K);var p=require("obsidian");var o=require("obsidian"),y={lettaUrl:"http://localhost:8283",apiKey:"",openaiApiKey:"",anthropicApiKey:"",agents:[],activeAgentId:"",enabled:!0,debounceMs:3e3},g=class extends o.PluginSettingTab{constructor(e,i){super(e,i),this.plugin=i}display(){let{containerEl:e}=this;if(e.empty(),e.createEl("h2",{text:"Therapist Settings"}),new o.Setting(e).setName("Enabled").setDesc("Enable/disable the therapist").addToggle(t=>t.setValue(this.plugin.settings.enabled).onChange(async s=>{this.plugin.settings.enabled=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Letta Server URL").setDesc("URL of your Letta server").addText(t=>t.setPlaceholder("http://localhost:8283").setValue(this.plugin.settings.lettaUrl).onChange(async s=>{this.plugin.settings.lettaUrl=s,this.plugin.lettaService.setBaseUrl(s),await this.plugin.saveSettings()})),new o.Setting(e).setName("API Key").setDesc("Letta server API key (sk-let-...)").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-let-...").setValue(this.plugin.settings.apiKey).onChange(async s=>{this.plugin.settings.apiKey=s,this.plugin.lettaService.setApiKey(s),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"Cloud Provider Keys"}),new o.Setting(e).setName("OpenAI API Key").setDesc("For GPT-4, GPT-4o models").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-proj-...").setValue(this.plugin.settings.openaiApiKey).onChange(async s=>{this.plugin.settings.openaiApiKey=s,this.plugin.lettaService.setProviderKey("openai",s),await this.plugin.saveSettings()})}),new o.Setting(e).setName("Anthropic API Key").setDesc("For Claude models").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async s=>{this.plugin.settings.anthropicApiKey=s,this.plugin.lettaService.setProviderKey("anthropic",s),await this.plugin.saveSettings()})}),new o.Setting(e).setName("Response Delay").setDesc("Seconds to wait after you stop typing before therapist responds").addSlider(t=>t.setLimits(1,10,1).setValue(this.plugin.settings.debounceMs/1e3).setDynamicTooltip().onChange(async s=>{this.plugin.settings.debounceMs=s*1e3,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Agents"}),this.plugin.settings.agents.length>0){new o.Setting(e).setName("Active Agent").setDesc("Select which agent to use").addDropdown(t=>{for(let s of this.plugin.settings.agents)t.addOption(s.id,`${s.name} (${s.model})`);t.setValue(this.plugin.settings.activeAgentId),t.onChange(async s=>{this.plugin.settings.activeAgentId=s,await this.plugin.saveSettings()})});for(let t of this.plugin.settings.agents)new o.Setting(e).setName(t.name).setDesc(`Model: ${t.model} | ID: ${t.id}`).addButton(s=>s.setButtonText("Delete").setWarning().onClick(async()=>{var r;this.plugin.settings.agents=this.plugin.settings.agents.filter(l=>l.id!==t.id),this.plugin.settings.activeAgentId===t.id&&(this.plugin.settings.activeAgentId=((r=this.plugin.settings.agents[0])==null?void 0:r.id)||""),await this.plugin.saveSettings(),this.display()}))}e.createEl("h4",{text:"Create New Agent"});let i="ollama/llama3.2",n="therapist";new o.Setting(e).setName("Agent Name").addText(t=>t.setPlaceholder("therapist").setValue(n).onChange(s=>{n=s})),new o.Setting(e).setName("Model").setDesc("Select model for the agent").addText(t=>t.setPlaceholder("ollama/llama3.2 or openai/gpt-4o").setValue(i).onChange(s=>{i=s})),new o.Setting(e).setName("").addButton(t=>t.setButtonText("Create Agent").setCta().onClick(async()=>{try{let s=await this.plugin.lettaService.createAgent(i),r={id:s,model:i,name:n||"therapist"};this.plugin.settings.agents.push(r),this.plugin.settings.activeAgentId=s,await this.plugin.saveSettings(),this.display()}catch(s){console.error("Failed to create agent:",s)}})),new o.Setting(e).setName("Available Models").setDesc("Fetch list of models from server").addButton(t=>t.setButtonText("Refresh Models").onClick(async()=>{try{let r=(await this.plugin.lettaService.listModels()).map(l=>l.handle).join(`
`);console.log(`Available models:
`+r)}catch(s){console.error("Failed to fetch models:",s)}}))}};var d=class{constructor(e,i=""){this.providerKeys={};this.baseUrl=e,this.apiKey=i}setBaseUrl(e){this.baseUrl=e}setApiKey(e){this.apiKey=e}setProviderKey(e,i){this.providerKeys[e]=i}getHeaders(){let e={"Content-Type":"application/json"};return this.apiKey&&(e.Authorization=`Bearer ${this.apiKey}`),e}async listModels(){let e=await fetch(`${this.baseUrl}/v1/models/`,{headers:this.getHeaders()});if(!e.ok)throw new Error("Failed to fetch models");return(await e.json()).map(n=>({handle:n.handle,name:n.name,provider:n.provider_name}))}async updateProviderKey(e,i){let n=await fetch(`${this.baseUrl}/v1/providers/${e}`,{method:"PUT",headers:this.getHeaders(),body:JSON.stringify({api_key:i})});if(!n.ok){let t=await n.text();console.warn(`Failed to update provider key: ${t}`)}}async createAgent(e="ollama/llama3.2",i="ollama/nomic-embed-text"){let n=await fetch(`${this.baseUrl}/v1/agents`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:"therapist",model:e,embedding:i,enable_sleeptime:!0,memory_blocks:[{label:"persona",value:`You are my therapist. We're in a journaling session.

As I write about my day, you:
- Ask questions to help me process what happened
- Point out patterns you've noticed from past sessions
- Give direct advice when it would be helpful
- Challenge my thinking when I'm distorting reality
- Help me understand myself better

Keep responses concise - 1-3 sentences usually. This is a conversation, not a lecture.
Be warm but direct. Don't just reflect - actually help me.`},{label:"human",value:"[Learning about you through our sessions...]"}]})});if(!n.ok){let s=await n.text();throw new Error(`Failed to create agent: ${s}`)}return(await n.json()).id}async sendMessage(e,i){let n=await fetch(`${this.baseUrl}/v1/agents/${e}/messages`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({messages:[{role:"user",content:i}]})});if(!n.ok){let r=await n.text();throw new Error(`Failed to send message: ${r}`)}let t=await n.json();for(let r of t.messages)if(r.message_type==="assistant_message")return r.content;let s=t.messages[t.messages.length-1];return(s==null?void 0:s.content)||""}async healthCheck(){try{return(await fetch(`${this.baseUrl}/v1/health`)).ok}catch(e){return!1}}};var u="> **Therapist:**";function w(a){let e=a.lastIndexOf(u);if(e===-1)return a.trim();let n=a.substring(e).match(/\n\n(?!>)(.+)/s);return n?n[1].trim():""}function f(a){return a.trim().startsWith(u)}function v(a){return`

${u} ${a}

`}var h=class extends p.Plugin{constructor(){super(...arguments);this.isProcessing=!1}async onload(){await this.loadSettings(),this.lettaService=new d(this.settings.lettaUrl,this.settings.apiKey),this.addSettingTab(new g(this.app,this));let i=(0,p.debounce)((n,t)=>this.handleEditorChange(n,t),this.settings.debounceMs,!0);this.registerEvent(this.app.workspace.on("editor-change",(n,t)=>{this.settings.enabled&&i(n,t)})),this.addCommand({id:"trigger-therapist",name:"Ask therapist to respond",editorCallback:(n,t)=>{this.handleEditorChange(n,t)}}),this.addCommand({id:"toggle-therapist",name:"Toggle therapist on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.saveSettings();let n=this.settings.enabled?"enabled":"disabled";console.log(`Therapist ${n}`)}}),console.log("Therapist plugin loaded")}async handleEditorChange(i,n){if(this.isProcessing)return;if(!this.settings.activeAgentId){console.error("No agent configured - create one in settings");return}let t=i.getValue(),s=w(t);if(s&&!f(s)){this.isProcessing=!0;try{let r=await this.lettaService.sendMessage(this.settings.activeAgentId,s);if(r){let m=i.getCursor().line;i.setCursor({line:m,ch:i.getLine(m).length}),i.replaceSelection(v(r))}}catch(r){console.error("Error getting therapist response:",r)}finally{this.isProcessing=!1}}}onunload(){console.log("Therapist plugin unloaded")}async loadSettings(){this.settings=Object.assign({},y,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
