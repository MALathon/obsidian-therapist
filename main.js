var y=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var x=(h,t)=>{for(var s in t)y(h,s,{get:t[s],enumerable:!0})},N=(h,t,s,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of k(t))!I.call(h,i)&&i!==s&&y(h,i,{get:()=>t[i],enumerable:!(e=P(t,i))||e.enumerable});return h};var C=h=>N(y({},"__esModule",{value:!0}),h);var $={};x($,{default:()=>v});module.exports=C($);var g=require("obsidian"),T=require("obsidian");var o=require("obsidian"),w={lettaUrl:"http://localhost:8283",apiKey:"",openaiApiKey:"",anthropicApiKey:"",agentId:"",agentName:"",agentModel:"",therapistName:"Therapist",enabled:!0,debounceMs:3e3},u=class extends o.PluginSettingTab{constructor(t,s){super(t,s),this.plugin=s}async display(){let{containerEl:t}=this;t.empty();let s=!!this.plugin.settings.agentId;if(s&&!this.plugin.settings.agentName){let e=await this.plugin.lettaService.getAgent(this.plugin.settings.agentId);e&&(this.plugin.settings.agentName=e.name,this.plugin.settings.agentModel=e.model,await this.plugin.saveSettings())}if(s){t.createEl("h2",{text:"Your Therapist"}),new o.Setting(t).setName("Name").setDesc("What should your therapist call themselves?").addText(r=>r.setPlaceholder("Therapist").setValue(this.plugin.settings.therapistName).onChange(async l=>{this.plugin.settings.therapistName=l||"Therapist",await this.plugin.saveSettings()})),new o.Setting(t).setName("Model").descEl.createSpan({text:this.plugin.settings.agentModel||"unknown",cls:"therapist-model-badge"}),new o.Setting(t).setName("Active").setDesc("Turn the therapist on or off").addToggle(r=>r.setValue(this.plugin.settings.enabled).onChange(async l=>{this.plugin.settings.enabled=l,await this.plugin.saveSettings(),this.plugin.updateStatusBar()}));let a=new o.Setting(t).setName("Agent ID").addButton(r=>r.setButtonText("Copy").onClick(()=>{navigator.clipboard.writeText(this.plugin.settings.agentId),new o.Notice("Agent ID copied")})).addButton(r=>r.setButtonText("Delete").setWarning().onClick(async()=>{try{await this.plugin.lettaService.deleteAgent(this.plugin.settings.agentId),new o.Notice("Agent deleted")}catch(l){console.warn("Could not delete from server:",l)}this.plugin.settings.agentId="",this.plugin.settings.agentName="",this.plugin.settings.agentModel="",this.plugin.settings.therapistName="Therapist",await this.plugin.saveSettings(),this.display()})).descEl.createEl("code",{text:this.plugin.settings.agentId});a.style.fontSize="0.75em",a.style.userSelect="all"}if(!s){t.createEl("h2",{text:"Create Therapist"});let e="letta/letta-free",i=null;new o.Setting(t).setName("Model").setDesc("Select which AI model to use").addDropdown(n=>{i=n,n.addOption("letta/letta-free","letta/letta-free (free)"),n.setValue(e),n.onChange(a=>{e=a})}).addButton(n=>n.setButtonText("Refresh Models").onClick(async()=>{try{let a=await this.plugin.lettaService.listModels();i.selectEl.empty(),i.addOption("letta/letta-free","letta/letta-free (free)");for(let r of a)r.handle!=="letta/letta-free"&&i.addOption(r.handle,r.handle);i.setValue(e),new o.Notice(`Found ${a.length} models`)}catch(a){new o.Notice("Failed to fetch models")}})),new o.Setting(t).setName("").addButton(n=>n.setButtonText("Create Therapist").setCta().onClick(async()=>{try{new o.Notice(`Creating agent with ${e}...`);let a=await this.plugin.lettaService.createAgent("therapist","therapist",e,"letta/letta-free");this.plugin.settings.agentId=a,this.plugin.settings.agentModel=e,this.plugin.settings.agentName="therapist",await this.plugin.saveSettings(),new o.Notice("Therapist created! Start journaling."),this.display()}catch(a){console.error("Failed to create agent:",a),new o.Notice(`Failed: ${a instanceof Error?a.message:"Unknown error"}`)}}))}t.createEl("h3",{text:"Behavior"}),new o.Setting(t).setName("Response delay").setDesc("Seconds to wait after you stop typing before responding").addSlider(e=>e.setLimits(1,10,1).setValue(this.plugin.settings.debounceMs/1e3).setDynamicTooltip().onChange(async i=>{this.plugin.settings.debounceMs=i*1e3,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Server"}),new o.Setting(t).setName("Letta URL").setDesc("Your Letta server address").addText(e=>e.setPlaceholder("http://localhost:8283").setValue(this.plugin.settings.lettaUrl).onChange(async i=>{this.plugin.settings.lettaUrl=i,this.plugin.lettaService.setBaseUrl(i),await this.plugin.saveSettings()})).addButton(e=>e.setButtonText("Test").onClick(async()=>{try{let i=`${this.plugin.settings.lettaUrl}/v1/health/`,n=await(0,o.requestUrl)({url:i});n.status===200?new o.Notice("Connected!"):new o.Notice(`Error: ${n.status}`)}catch(i){new o.Notice("Connection failed")}})),new o.Setting(t).setName("Letta API Key").setDesc("Only needed if your server requires authentication").addText(e=>e.setPlaceholder("sk-let-...").setValue(this.plugin.settings.apiKey).onChange(async i=>{this.plugin.settings.apiKey=i,this.plugin.lettaService.setApiKey(i),await this.plugin.saveSettings()})),t.createEl("h3",{text:"LLM API Keys"}),t.createEl("p",{text:"Required for cloud models. Leave blank if using letta-free or local Ollama.",cls:"setting-item-description"}),new o.Setting(t).setName("Anthropic").setDesc("For Claude models").addText(e=>e.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async i=>{if(this.plugin.settings.anthropicApiKey=i,await this.plugin.saveSettings(),i)try{await this.plugin.lettaService.updateProviderKey("anthropic",i)}catch(n){console.warn("Could not update provider key:",n)}})),new o.Setting(t).setName("OpenAI").setDesc("For GPT models").addText(e=>e.setPlaceholder("sk-proj-...").setValue(this.plugin.settings.openaiApiKey).onChange(async i=>{if(this.plugin.settings.openaiApiKey=i,await this.plugin.saveSettings(),i)try{await this.plugin.lettaService.updateProviderKey("openai",i)}catch(n){console.warn("Could not update provider key:",n)}}))}};var d=require("obsidian"),b={therapist:`You are my personal coach. Read between the lines of what I write.

My journaling may be scattered, venting, or stream-of-consciousness. Your job:
1. Silently figure out what's actually going on beneath the surface
2. Respond to what I need, not what I literally said

RESPONSE PROTOCOL:
- Messages prefixed with "[User is asking for your input]" \u2192 Always respond
- Messages prefixed with "[User is journaling...]" \u2192 Only respond if you have genuine insight
- If you have nothing valuable to add, respond with just: [listening]

WHEN TO RESPOND:
- I'm stuck and need a push \u2192 Give ONE specific thing to try
- I'm avoiding something obvious \u2192 Name it directly
- I'm spiraling \u2192 Ground me with something concrete
- I keep coming back to the same problem \u2192 Offer a real suggestion
- I'm asking you directly \u2192 Answer me

WHEN TO STAY SILENT (respond with [listening]):
- I'm just processing emotions
- I'm venting and don't need fixing
- I'm working through something myself
- You'd just be restating what I said

WHEN YOU DO RESPOND, be specific:
- Times: "Try this tomorrow morning" not "sometime"
- Quantities: "Track 3 days" not "for a while"
- Observable: "Notice if..." not vague outcomes

Be real. Don't be a robot that dispenses advice. Be the friend who knows when to push and when to shut up.

Keep responses short. 1-3 sentences usually. Match my energy.`,analyst:`You observe patterns across journal sessions and give specific improvement suggestions.

When you notice a pattern, respond with:
\u{1F4CA} Pattern: [what you noticed across sessions]
\u{1F3AF} Suggestion: [one specific change to try]

Examples:
- "\u{1F4CA} Pattern: Stress spikes on Mondays, usually mentions Sunday night anxiety. \u{1F3AF} Suggestion: Do a 10-min Monday preview on Sunday at 4pm - just look at your calendar and write 3 things you'll handle first."
- "\u{1F4CA} Pattern: Overspending happens after stressful days. \u{1F3AF} Suggestion: Add a 24-hour rule - when stressed, screenshot items instead of buying. Review tomorrow."
- "\u{1F4CA} Pattern: Energy drops after lunch on workdays. \u{1F3AF} Suggestion: Try a 10-min walk immediately after eating for one week. Track energy at 3pm."

Only speak when you spot something actionable. Quality over quantity.`,custom:"You are a helpful assistant in a journaling session. Be supportive and give practical suggestions when appropriate."},m=class{constructor(t,s=""){this.providerKeys={};this.baseUrl=t,this.apiKey=s}setBaseUrl(t){this.baseUrl=t}setApiKey(t){this.apiKey=t}setProviderKey(t,s){this.providerKeys[t]=s}getHeaders(){let t={"Content-Type":"application/json"};return this.apiKey&&(t.Authorization=`Bearer ${this.apiKey}`),t}async listModels(){let t=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/models`,headers:this.getHeaders()});if(t.status!==200)throw new Error("Failed to fetch models");return t.json.map(e=>({handle:e.handle,name:e.name,provider:e.provider_name}))}async updateProviderKey(t,s){try{let n=(await(0,d.requestUrl)({url:`${this.baseUrl}/v1/providers/`,headers:this.getHeaders()})).json.find(a=>a.provider_type===t);if(n)await(0,d.requestUrl)({url:`${this.baseUrl}/v1/providers/${n.id}`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({api_key:s})}),console.log(`Updated ${t} provider`);else try{await(0,d.requestUrl)({url:`${this.baseUrl}/v1/providers/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:t,provider_type:t,api_key:s})}),console.log(`Created ${t} provider`)}catch(a){console.warn(`Provider ${t} may already exist (409), trying alternate approach`);let l=(await(0,d.requestUrl)({url:`${this.baseUrl}/v1/providers/`,headers:this.getHeaders()})).json.find(c=>c.provider_type===t||c.name===t);l?(await(0,d.requestUrl)({url:`${this.baseUrl}/v1/providers/${l.id}`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({api_key:s})}),console.log(`Updated ${t} provider on retry`)):console.error(`Provider ${t} exists in database but not retrievable. May need to reset Letta.`)}}catch(e){console.warn("Failed to update provider key:",e)}}async createAgent(t,s,e="ollama/llama3.2",i="ollama/nomic-embed-text",n){let a=n||b[s]||b.custom,r=e.includes("/")?e.split("/")[0]:null,l={name:t,model:e,embedding:i,enable_sleeptime:!0,memory_blocks:[{label:"persona",value:a},{label:"human",value:"[Learning about you through our sessions...]"}]};if(r&&r!=="letta"&&r!=="ollama"){let p=e.includes("/")?e.split("/").slice(1).join("/"):e;l.llm_config={model:p,model_endpoint_type:r,provider_name:r,context_window:2e5}}let c=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/agents/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify(l)});if(c.status!==200)throw new Error(`Failed to create agent: ${c.text}`);return c.json.id}async sendMessage(t,s){let e=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/agents/${t}/messages`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({messages:[{role:"user",content:s}]})});if(e.status!==200)throw new Error(`Failed to send message: ${e.text}`);let i=e.json;for(let a of i.messages)if(a.message_type==="assistant_message")return a.content;let n=i.messages[i.messages.length-1];return(n==null?void 0:n.content)||""}async getAgent(t){var s;try{let e=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/agents/${t}`,headers:this.getHeaders()});if(e.status!==200)return null;let i=e.json;return{id:i.id,name:i.name,model:i.model||((s=i.llm_config)==null?void 0:s.model)||"unknown"}}catch(e){return null}}async deleteAgent(t){let s=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/agents/${t}`,method:"DELETE",headers:this.getHeaders()});if(s.status!==200&&s.status!==204)throw new Error(`Failed to delete agent: ${s.text}`)}async healthCheck(){try{return(await(0,d.requestUrl)({url:`${this.baseUrl}/v1/health`})).status===200}catch(t){return!1}}async createArchive(t,s="letta/letta-free"){let e=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/archives/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:t,description:"Obsidian vault content for therapist context",embedding:s})});if(e.status!==200)throw new Error(`Failed to create archive: ${e.text}`);return e.json.id}async listArchives(){let t=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/archives/`,headers:this.getHeaders()});if(t.status!==200)throw new Error("Failed to list archives");return t.json.map(s=>({id:s.id,name:s.name}))}async addPassage(t,s,e={}){let i=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/archives/${t}/passages/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({text:s,metadata:e})});if(i.status!==200)throw new Error(`Failed to add passage: ${i.text}`)}async attachArchive(t,s){let e=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/agents/${t}/archives/attach/${s}/`,method:"POST",headers:this.getHeaders()});if(e.status!==200)throw new Error(`Failed to attach archive: ${e.text}`)}async clearArchive(t){let s=await(0,d.requestUrl)({url:`${this.baseUrl}/v1/archives/${t}/passages/`,headers:this.getHeaders()});if(s.status!==200)return;let e=s.json;for(let i of e)try{await(0,d.requestUrl)({url:`${this.baseUrl}/v1/archives/${t}/passages/${i.id}/`,method:"DELETE",headers:this.getHeaders()})}catch(n){}}};function A(h="Therapist"){return`> **${h}:**`}function f(h){let t=/^>\s*\*\*[^*]+:\*\*/gm,s=-1,e;for(;(e=t.exec(h))!==null;)s=e.index;if(s===-1)return h.trim();let n=h.substring(s).split(`
`),a=-1,r=!0;for(let l=0;l<n.length;l++){let p=n[l].trim();if(r){if(p===""||p.startsWith(">"))continue;a=l;break}}return a===-1?"":n.slice(a).join(`
`).trim()}function E(h){let t=h.trim();return/^>\s*\*\*[^*]+:\*\*/.test(t)}function S(h,t="Therapist"){let s=A(t);return`

${h.split(`
`).map((n,a)=>a===0?`${s} ${n}`:n.trim()===""?">":`> ${n}`).join(`
`)}

`}var v=class extends g.Plugin{constructor(){super(...arguments);this.isProcessing=!1;this.statusBarEl=null;this.pendingInsight=null;this.indicatorEl=null;this.popoverEl=null;this.popoverVisible=!1}async onload(){await this.loadSettings(),this.lettaService=new m(this.settings.lettaUrl,this.settings.apiKey),this.addSettingTab(new u(this.app,this));let s=(0,g.debounce)((e,i)=>this.observeContent(e,i),this.settings.debounceMs,!0);this.registerEvent(this.app.workspace.on("editor-change",(e,i)=>{this.settings.enabled&&this.settings.agentId&&s(e,i)})),this.addCommand({id:"trigger-therapist",name:"Talk to therapist (inline response)",editorCallback:async(e,i)=>{await this.triggerConversation(e,i)}}),this.addCommand({id:"copy-insight",name:"Copy insight to daily note",callback:()=>{this.pendingInsight?this.copyToDailyNote():new g.Notice("No insight available")}}),this.addCommand({id:"toggle-therapist",name:"Toggle therapist on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.settings.enabled?this.checkCurrentNote():(this.pendingInsight=null,this.hideIndicator()),this.saveSettings(),this.updateStatusBar(),new g.Notice(`Therapist ${this.settings.enabled?"enabled":"disabled"}`)}}),this.statusBarEl=this.addStatusBarItem(),this.updateStatusBar(),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.checkCurrentNote()})),this.registerEvent(this.app.workspace.on("file-open",()=>{this.checkCurrentNote()})),this.registerDomEvent(document,"click",e=>{this.popoverVisible&&this.indicatorEl&&(this.indicatorEl.contains(e.target)||this.hidePopover())}),this.checkCurrentNote(),console.log("Therapist plugin loaded")}checkCurrentNote(){if(this.pendingInsight=null,this.hidePopover(),!this.settings.enabled||!this.settings.agentId){this.hideIndicator(),this.updateStatusBar();return}if(!this.app.workspace.getActiveViewOfType(g.MarkdownView)){this.hideIndicator(),this.updateStatusBar("off");return}this.showIndicator("observing"),this.updateStatusBar("listening")}updateStatusBar(s){if(this.statusBarEl){if(!this.settings.enabled){this.statusBarEl.setText("\u25CB Therapist off");return}if(!this.settings.agentId){this.statusBarEl.setText("\u25CB No agent");return}switch(s){case"thinking":this.statusBarEl.setText("\u25C9 Observing...");break;case"insight":this.statusBarEl.setText("\u{1F4AD} Has insight");break;case"off":this.statusBarEl.setText("\u25CB Therapist off");break;default:this.statusBarEl.setText("\u25CF Observing")}}}async observeContent(s,e){if(this.isProcessing||!this.settings.agentId)return;let i=s.getValue(),n=f(i);if(n&&!E(n)){this.isProcessing=!0,this.showIndicator("thinking"),this.updateStatusBar("thinking");try{let a=`[OBSERVER MODE - You are passively watching the user write. Only respond if you notice something genuinely insightful - a pattern, a reframe, a question worth asking, or an observation that could help. If nothing stands out, respond with just: [listening]]

${n}`,r=await this.lettaService.sendMessage(this.settings.agentId,a),l=(r==null?void 0:r.trim())||"";l&&l!=="[listening]"?(this.pendingInsight=r,this.showIndicator("insight"),this.updateStatusBar("insight")):(this.showIndicator("observing"),this.updateStatusBar("listening"))}catch(a){console.error("Error observing:",a),this.showIndicator("observing"),this.updateStatusBar("listening")}finally{this.isProcessing=!1}}}async triggerConversation(s,e){if(this.isProcessing)return;if(!this.settings.agentId){new g.Notice("No therapist agent configured");return}let i=s.getValue(),n=f(i);if(!n){new g.Notice("Nothing new to discuss");return}this.isProcessing=!0,this.showIndicator("thinking"),this.updateStatusBar("thinking");try{let a=`[CONVERSATION MODE - The user wants to talk. Respond directly and helpfully.]

${n}`,r=await this.lettaService.sendMessage(this.settings.agentId,a),l=(r==null?void 0:r.trim())||"";if(l&&l!=="[listening]"){let p=s.getCursor().line;s.setCursor({line:p,ch:s.getLine(p).length}),s.replaceSelection(S(r,this.settings.therapistName))}this.showIndicator("observing"),this.updateStatusBar("listening")}catch(a){console.error("Error in conversation:",a),new g.Notice("Failed to get response"),this.showIndicator("observing"),this.updateStatusBar("listening")}finally{this.isProcessing=!1}}showIndicator(s){let e=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(!e){this.hideIndicator();return}let i=e.contentEl;if(!this.indicatorEl){this.indicatorEl=document.createElement("div"),this.indicatorEl.className="therapist-indicator is-visible";let a=document.createElement("div");a.className="therapist-orb",a.addEventListener("click",r=>{r.stopPropagation(),this.pendingInsight&&this.togglePopover()}),this.indicatorEl.appendChild(a)}let n=this.indicatorEl.querySelector(".therapist-orb");n&&(n.classList.remove("is-thinking","has-insight"),s==="thinking"?n.classList.add("is-thinking"):s==="insight"&&n.classList.add("has-insight")),i.contains(this.indicatorEl)||i.appendChild(this.indicatorEl)}hideIndicator(){this.indicatorEl&&(this.indicatorEl.remove(),this.indicatorEl=null),this.hidePopover()}togglePopover(){this.popoverVisible?this.hidePopover():this.showPopover()}showPopover(){var e,i,n;if(!this.pendingInsight||!this.indicatorEl)return;this.popoverEl||(this.popoverEl=document.createElement("div"),this.popoverEl.className="therapist-popover",this.popoverEl.innerHTML=`
        <div class="therapist-popover-header">
          <span class="therapist-popover-title">Therapist Insight</span>
          <button class="therapist-popover-dismiss">\xD7</button>
        </div>
        <div class="therapist-popover-content"></div>
        <div class="therapist-popover-actions">
          <button class="therapist-popover-btn secondary dismiss-btn">Dismiss</button>
          <button class="therapist-popover-btn primary copy-btn">Copy to Daily Note</button>
        </div>
      `,(e=this.popoverEl.querySelector(".therapist-popover-dismiss"))==null||e.addEventListener("click",a=>{a.stopPropagation(),this.hidePopover()}),(i=this.popoverEl.querySelector(".dismiss-btn"))==null||i.addEventListener("click",a=>{a.stopPropagation(),this.dismissInsight()}),(n=this.popoverEl.querySelector(".copy-btn"))==null||n.addEventListener("click",a=>{a.stopPropagation(),this.copyToDailyNote()}),this.indicatorEl.appendChild(this.popoverEl));let s=this.popoverEl.querySelector(".therapist-popover-content");s&&(s.textContent=this.pendingInsight),this.popoverEl.classList.add("is-visible"),this.popoverVisible=!0}hidePopover(){this.popoverEl&&this.popoverEl.classList.remove("is-visible"),this.popoverVisible=!1}dismissInsight(){this.pendingInsight=null,this.hidePopover(),this.showIndicator("observing"),this.updateStatusBar("listening")}async copyToDailyNote(){if(this.pendingInsight)try{let s=(0,T.moment)().format("YYYY-MM-DD"),e=`${s}.md`,i=this.app.vault.getAbstractFileByPath(e);if(!i)i=await this.app.vault.create(e,`# ${s}

## Journal

### Therapist Insight

${this.pendingInsight}
`),new g.Notice("Created daily note with insight");else if(i instanceof g.TFile){let n=await this.app.vault.read(i);n.includes("## Journal")||(n+=`

## Journal
`);let a=n.indexOf("## Journal"),l=n.substring(a).substring(11).match(/\n## /),c=`
### Therapist Insight

${this.pendingInsight}
`;if(l){let p=a+11+l.index;n=n.substring(0,p)+c+n.substring(p)}else n+=c;await this.app.vault.modify(i,n),new g.Notice("Insight copied to daily note")}this.dismissInsight()}catch(s){console.error("Error copying to daily note:",s),new g.Notice("Failed to copy to daily note")}}onunload(){this.hideIndicator(),console.log("Therapist plugin unloaded")}async loadSettings(){this.settings=Object.assign({},w,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
