var v=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var U=(d,e)=>{for(var t in e)v(d,t,{get:e[t],enumerable:!0})},D=(d,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of O(e))!R.call(d,n)&&n!==t&&v(d,n,{get:()=>e[n],enumerable:!(i=B(e,n))||i.enumerable});return d};var L=d=>D(v({},"__esModule",{value:!0}),d);var j={};U(j,{default:()=>y});module.exports=L(j);var h=require("obsidian");var l=require("obsidian"),T={lettaUrl:"http://localhost:8283",apiKey:"",openaiApiKey:"",anthropicApiKey:"",agentId:"",enabled:!0,debounceMs:3e3,autoIndex:!0,indexMode:"blacklist",indexFolders:""},p=class extends l.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Therapist"});let t=!!this.plugin.settings.agentId;e.createEl("div",{cls:"setting-item"}).createEl("span",{text:t?"\u2713 Connected":"\u25CB No agent configured",cls:t?"therapist-status-connected":"therapist-status-disconnected"}),new l.Setting(e).setName("Enabled").setDesc("Enable/disable the therapist").addToggle(s=>s.setValue(this.plugin.settings.enabled).onChange(async a=>{this.plugin.settings.enabled=a,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Connection"}),new l.Setting(e).setName("Letta Server URL").setDesc("URL of your Letta server").addText(s=>s.setPlaceholder("http://localhost:8283").setValue(this.plugin.settings.lettaUrl).onChange(async a=>{this.plugin.settings.lettaUrl=a,this.plugin.lettaService.setBaseUrl(a),await this.plugin.saveSettings()})),new l.Setting(e).setName("Letta API Key").setDesc("Optional - only if your server requires it").addText(s=>{s.setPlaceholder("sk-let-...").setValue(this.plugin.settings.apiKey).onChange(async a=>{this.plugin.settings.apiKey=a,this.plugin.lettaService.setApiKey(a),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"LLM Provider"}),e.createEl("p",{text:"Add an API key to use cloud models. Leave blank to use local Ollama.",cls:"setting-item-description"}),new l.Setting(e).setName("OpenAI API Key").setDesc("Uses GPT-4o").addText(s=>{s.setPlaceholder("sk-proj-...").setValue(this.plugin.settings.openaiApiKey).onChange(async a=>{if(this.plugin.settings.openaiApiKey=a,await this.plugin.saveSettings(),a)try{await this.plugin.lettaService.updateProviderKey("openai",a)}catch(o){console.warn("Could not update provider key:",o)}})}),new l.Setting(e).setName("Anthropic API Key").setDesc("Uses Claude Sonnet").addText(s=>{s.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async a=>{if(this.plugin.settings.anthropicApiKey=a,await this.plugin.saveSettings(),a)try{await this.plugin.lettaService.updateProviderKey("anthropic",a)}catch(o){console.warn("Could not update provider key:",o)}})}),e.createEl("h3",{text:"Behavior"}),new l.Setting(e).setName("Response Delay").setDesc("Seconds to wait after you stop typing").addSlider(s=>s.setLimits(1,10,1).setValue(this.plugin.settings.debounceMs/1e3).setDynamicTooltip().onChange(async a=>{this.plugin.settings.debounceMs=a*1e3,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Setup"});let n="letta/letta-free",r=null;if(new l.Setting(e).setName("Model").setDesc("Click refresh to load available models").addDropdown(s=>{r=s,s.addOption("letta/letta-free","letta/letta-free (default)"),s.setValue(n),s.onChange(a=>{n=a})}).addButton(s=>s.setButtonText("Refresh").onClick(async()=>{try{let a=await this.plugin.lettaService.listModels();r.selectEl.empty(),r.addOption("letta/letta-free","letta/letta-free (default)");for(let o of a)o.handle!=="letta/letta-free"&&r.addOption(o.handle,o.handle);r.setValue(n),new l.Notice(`Found ${a.length} models`)}catch(a){new l.Notice("Failed to fetch models - check server connection")}})),t){let a=new l.Setting(e).setName("Agent").setDesc(`ID: ${this.plugin.settings.agentId}`).addButton(g=>g.setButtonText("Copy ID").onClick(()=>{navigator.clipboard.writeText(this.plugin.settings.agentId),new l.Notice("Agent ID copied")})).addButton(g=>g.setButtonText("Delete Agent").setWarning().onClick(async()=>{try{await this.plugin.lettaService.deleteAgent(this.plugin.settings.agentId),new l.Notice("Agent deleted from Letta")}catch(u){console.warn("Could not delete agent from Letta:",u),new l.Notice("Agent removed locally (could not delete from server)")}this.plugin.settings.agentId="",await this.plugin.saveSettings(),this.display()})).descEl;a.empty();let o=a.createEl("code",{text:this.plugin.settings.agentId,cls:"therapist-agent-id"});o.style.userSelect="all",o.style.fontSize="0.85em"}else new l.Setting(e).setName("Create Therapist").setDesc("Creates your personal coach agent").addButton(s=>s.setButtonText("Create Agent").setCta().onClick(async()=>{try{let a=n,o="letta/letta-free";new l.Notice(`Creating agent with ${a}...`);let g=await this.plugin.lettaService.createAgent("therapist","therapist",a,o);this.plugin.settings.agentId=g,await this.plugin.saveSettings(),new l.Notice("Therapist created! Start journaling."),this.display()}catch(a){console.error("Failed to create agent:",a),new l.Notice(`Failed: ${a instanceof Error?a.message:"Unknown error"}`)}}));t&&(e.createEl("h3",{text:"Vault Context"}),e.createEl("p",{text:"Notes with ## Journal headers are always indexed. Configure which other folders to include.",cls:"setting-item-description"}),new l.Setting(e).setName("Auto-index").setDesc("Automatically index files when they change").addToggle(s=>s.setValue(this.plugin.settings.autoIndex).onChange(async a=>{this.plugin.settings.autoIndex=a,await this.plugin.saveSettings(),a?this.plugin.startAutoIndexing():this.plugin.stopAutoIndexing()})),new l.Setting(e).setName("Folder mode").setDesc("Whitelist: only index listed folders. Blacklist: index all except listed.").addDropdown(s=>s.addOption("blacklist","Blacklist (exclude folders)").addOption("whitelist","Whitelist (only these folders)").setValue(this.plugin.settings.indexMode).onChange(async a=>{this.plugin.settings.indexMode=a,await this.plugin.saveSettings()})),new l.Setting(e).setName("Folders").setDesc('Comma-separated folder paths (e.g., "private, drafts, templates")').addText(s=>s.setPlaceholder("folder1, folder2").setValue(this.plugin.settings.indexFolders).onChange(async a=>{this.plugin.settings.indexFolders=a,await this.plugin.saveSettings()})),new l.Setting(e).setName("Reindex Vault").setDesc("Full reindex of all matching files").addButton(s=>s.setButtonText("Reindex Now").onClick(async()=>{if(this.plugin.isIndexing){new l.Notice("Indexing already in progress");return}s.setDisabled(!0),s.setButtonText("Indexing...");try{let a=this.plugin.getIndexFilter(),o=await this.plugin.vaultIndexer.indexVault(this.plugin.settings.agentId,a);new l.Notice(`Indexed ${o.files} files (${o.passages} passages)`)}catch(a){console.error("Indexing failed:",a),new l.Notice(`Indexing failed: ${a instanceof Error?a.message:"Unknown error"}`)}finally{s.setDisabled(!1),s.setButtonText("Reindex Now")}}))),new l.Setting(e).setName("Test Connection").setDesc("Check if Letta server is reachable").addButton(s=>s.setButtonText("Test").onClick(async()=>{try{let a=`${this.plugin.settings.lettaUrl}/v1/health/`;new l.Notice(`Testing ${a}...`);let o=await(0,l.requestUrl)({url:a});o.status===200?new l.Notice("Connected to Letta server!"):new l.Notice(`Server error: ${o.status}`)}catch(a){new l.Notice(`Connection failed: ${a instanceof Error?a.message:"Unknown error"}`)}}))}};var c=require("obsidian"),E={therapist:`You are my personal coach. Read between the lines of what I write.

My journaling may be scattered, venting, or stream-of-consciousness. Your job:
1. Silently figure out what's actually going on beneath the surface
2. Respond to what I need, not what I literally said

RESPONSE PROTOCOL:
- Messages prefixed with "[User is asking for your input]" \u2192 Always respond
- Messages prefixed with "[User is journaling...]" \u2192 Only respond if you have genuine insight
- If you have nothing valuable to add, respond with just: [listening]

WHEN TO RESPOND:
- I'm stuck and need a push \u2192 Give ONE specific thing to try
- I'm avoiding something obvious \u2192 Name it directly
- I'm spiraling \u2192 Ground me with something concrete
- I keep coming back to the same problem \u2192 Offer a real suggestion
- I'm asking you directly \u2192 Answer me

WHEN TO STAY SILENT (respond with [listening]):
- I'm just processing emotions
- I'm venting and don't need fixing
- I'm working through something myself
- You'd just be restating what I said

WHEN YOU DO RESPOND, be specific:
- Times: "Try this tomorrow morning" not "sometime"
- Quantities: "Track 3 days" not "for a while"
- Observable: "Notice if..." not vague outcomes

Be real. Don't be a robot that dispenses advice. Be the friend who knows when to push and when to shut up.

Keep responses short. 1-3 sentences usually. Match my energy.`,analyst:`You observe patterns across journal sessions and give specific improvement suggestions.

When you notice a pattern, respond with:
\u{1F4CA} Pattern: [what you noticed across sessions]
\u{1F3AF} Suggestion: [one specific change to try]

Examples:
- "\u{1F4CA} Pattern: Stress spikes on Mondays, usually mentions Sunday night anxiety. \u{1F3AF} Suggestion: Do a 10-min Monday preview on Sunday at 4pm - just look at your calendar and write 3 things you'll handle first."
- "\u{1F4CA} Pattern: Overspending happens after stressful days. \u{1F3AF} Suggestion: Add a 24-hour rule - when stressed, screenshot items instead of buying. Review tomorrow."
- "\u{1F4CA} Pattern: Energy drops after lunch on workdays. \u{1F3AF} Suggestion: Try a 10-min walk immediately after eating for one week. Track energy at 3pm."

Only speak when you spot something actionable. Quality over quantity.`,custom:"You are a helpful assistant in a journaling session. Be supportive and give practical suggestions when appropriate."},m=class{constructor(e,t=""){this.providerKeys={};this.baseUrl=e,this.apiKey=t}setBaseUrl(e){this.baseUrl=e}setApiKey(e){this.apiKey=e}setProviderKey(e,t){this.providerKeys[e]=t}getHeaders(){let e={"Content-Type":"application/json"};return this.apiKey&&(e.Authorization=`Bearer ${this.apiKey}`),e}async listModels(){let e=await(0,c.requestUrl)({url:`${this.baseUrl}/v1/models/`,headers:this.getHeaders()});if(e.status!==200)throw new Error("Failed to fetch models");return e.json.map(i=>({handle:i.handle,name:i.name,provider:i.provider_name}))}async updateProviderKey(e,t){try{let r=(await(0,c.requestUrl)({url:`${this.baseUrl}/v1/providers/`,headers:this.getHeaders()})).json.find(s=>s.provider_type===e);r?await(0,c.requestUrl)({url:`${this.baseUrl}/v1/providers/${r.id}/`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({api_key:t})}):await(0,c.requestUrl)({url:`${this.baseUrl}/v1/providers/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,provider_type:e,api_key:t})})}catch(i){console.warn("Failed to update provider key:",i)}}async createAgent(e,t,i="ollama/llama3.2",n="ollama/nomic-embed-text",r){let s=r||E[t]||E.custom,a=await(0,c.requestUrl)({url:`${this.baseUrl}/v1/agents/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,model:i,embedding:n,enable_sleeptime:!0,memory_blocks:[{label:"persona",value:s},{label:"human",value:"[Learning about you through our sessions...]"}]})});if(a.status!==200)throw new Error(`Failed to create agent: ${a.text}`);return a.json.id}async sendMessage(e,t){let i=await(0,c.requestUrl)({url:`${this.baseUrl}/v1/agents/${e}/messages/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({messages:[{role:"user",content:t}]})});if(i.status!==200)throw new Error(`Failed to send message: ${i.text}`);let n=i.json;for(let s of n.messages)if(s.message_type==="assistant_message")return s.content;let r=n.messages[n.messages.length-1];return(r==null?void 0:r.content)||""}async deleteAgent(e){let t=await(0,c.requestUrl)({url:`${this.baseUrl}/v1/agents/${e}`,method:"DELETE",headers:this.getHeaders()});if(t.status!==200&&t.status!==204)throw new Error(`Failed to delete agent: ${t.text}`)}async healthCheck(){try{return(await(0,c.requestUrl)({url:`${this.baseUrl}/v1/health/`})).status===200}catch(e){return!1}}async createArchive(e,t="letta/letta-free"){let i=await(0,c.requestUrl)({url:`${this.baseUrl}/v1/archives/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,description:"Obsidian vault content for therapist context",embedding:t})});if(i.status!==200)throw new Error(`Failed to create archive: ${i.text}`);return i.json.id}async listArchives(){let e=await(0,c.requestUrl)({url:`${this.baseUrl}/v1/archives/`,headers:this.getHeaders()});if(e.status!==200)throw new Error("Failed to list archives");return e.json.map(t=>({id:t.id,name:t.name}))}async addPassage(e,t,i={}){let n=await(0,c.requestUrl)({url:`${this.baseUrl}/v1/archives/${e}/passages/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({text:t,metadata:i})});if(n.status!==200)throw new Error(`Failed to add passage: ${n.text}`)}async attachArchive(e,t){let i=await(0,c.requestUrl)({url:`${this.baseUrl}/v1/agents/${e}/archives/attach/${t}/`,method:"POST",headers:this.getHeaders()});if(i.status!==200)throw new Error(`Failed to attach archive: ${i.text}`)}async clearArchive(e){let t=await(0,c.requestUrl)({url:`${this.baseUrl}/v1/archives/${e}/passages/`,headers:this.getHeaders()});if(t.status!==200)return;let i=t.json;for(let n of i)try{await(0,c.requestUrl)({url:`${this.baseUrl}/v1/archives/${e}/passages/${n.id}/`,method:"DELETE",headers:this.getHeaders()})}catch(r){}}};var f=require("obsidian"),k="obsidian-vault",A=1e3,C=100,w=class{constructor(e,t){this.archiveId=null;this.app=e,this.lettaService=t}async hasJournalHeader(e){let t=await this.app.vault.cachedRead(e);return/^##\s+Journal\s*$/m.test(t)}async shouldIndexFile(e,t){if(await this.hasJournalHeader(e))return!0;let i=e.path.toLowerCase(),n=t.folders.map(s=>s.trim().toLowerCase()).filter(s=>s);if(n.length===0)return t.mode==="blacklist";let r=n.some(s=>i.startsWith(s+"/")||i===s);return t.mode==="whitelist"?r:!r}async getOrCreateArchive(){if(this.archiveId)return this.archiveId;let t=(await this.lettaService.listArchives()).find(i=>i.name===k);return t?(this.archiveId=t.id,t.id):(this.archiveId=await this.lettaService.createArchive(k),this.archiveId)}chunkText(e,t){let i=[];if(e.length<=A)return i.push({text:`[${t}]

${e}`,metadata:{file:t,chunk:"0"}}),i;let n=0,r=0;for(;n<e.length;){let s=Math.min(n+A,e.length),a=e.substring(n,s);if(i.push({text:`[${t} - Part ${r+1}]

${a}`,metadata:{file:t,chunk:String(r)}}),n=s-C,n>=e.length-C)break;r++}return i}async indexFile(e,t){let i=await this.app.vault.cachedRead(e);if(i.length<50)return 0;let n=this.chunkText(i,e.path);for(let r of n)await this.lettaService.addPassage(t,r.text,r.metadata);return n.length}async indexVault(e,t,i){let n=await this.getOrCreateArchive();new f.Notice("Clearing old index..."),await this.lettaService.clearArchive(n);let r=this.app.vault.getMarkdownFiles(),s=[];if(t)for(let o of r)await this.shouldIndexFile(o,t)&&s.push(o);else s.push(...r);let a=0;new f.Notice(`Indexing ${s.length} files...`);for(let o=0;o<s.length;o++){let g=s[o];i&&i(o+1,s.length,g.path);try{let u=await this.indexFile(g,n);a+=u}catch(u){console.warn(`Failed to index ${g.path}:`,u)}}try{await this.lettaService.attachArchive(e,n)}catch(o){console.warn("Archive attachment:",o)}return new f.Notice(`Indexed ${s.length} files (${a} passages)`),{files:s.length,passages:a}}async indexSingleFile(e,t,i){if(i&&!await this.shouldIndexFile(e,i))return!1;let n=await this.getOrCreateArchive();try{await this.indexFile(e,n);try{await this.lettaService.attachArchive(t,n)}catch(r){}return!0}catch(r){return console.warn(`Failed to index ${e.path}:`,r),!1}}async indexChanged(e,t){let i=await this.getOrCreateArchive(),n=this.app.vault.getMarkdownFiles().filter(s=>s.stat.mtime>t),r=0;for(let s of n)try{let a=await this.indexFile(s,i);r+=a}catch(a){console.warn(`Failed to index ${s.path}:`,a)}return{files:n.length,passages:r}}};var x="> **Therapist:**",M=["# Journal","## Journal","### Journal"];function P(d){let e=d.lastIndexOf(x);if(e===-1)return d.trim();let i=d.substring(e).split(`
`),n=-1,r=!0;for(let s=0;s<i.length;s++){let o=i[s].trim();if(r){if(o===""||o.startsWith(">"))continue;n=s;break}}return n===-1?"":i.slice(n).join(`
`).trim()}function F(d){return d.trim().startsWith(x)}function $(d){return`

${d.split(`
`).map((i,n)=>n===0?`${x} ${i}`:i.trim()===""?">":`> ${i}`).join(`
`)}

`}function b(d){let e=-1,t=0;for(let s of M){let a=d.indexOf(s);a!==-1&&(e===-1||a<e)&&(e=a,t=s.split(" ")[0].length)}if(e===-1)return null;let n=d.substring(e).split(`
`),r=n.length;for(let s=1;s<n.length;s++){let o=n[s].match(/^(#{1,6})\s/);if(o&&o[1].length<=t){r=s;break}}return n.slice(1,r).join(`
`).trim()}function N(d){let e=d.toLowerCase();return d.includes("?")?!0:["you know","right?","what do you think","any thoughts","help me","i need","should i","could i","what should","what would","advice","suggest","opinion","perspective","thoughts?","ideas?"].some(i=>e.includes(i))}var y=class extends h.Plugin{constructor(){super(...arguments);this.isProcessing=!1;this.isIndexing=!1;this.statusBarEl=null;this.autoIndexEvents=[];this.indexQueue=new Set;this.indexDebounceTimer=null}async onload(){await this.loadSettings(),this.lettaService=new m(this.settings.lettaUrl,this.settings.apiKey),this.vaultIndexer=new w(this.app,this.lettaService),this.addSettingTab(new p(this.app,this));let t=(0,h.debounce)((i,n)=>this.handleEditorChange(i,n),this.settings.debounceMs,!0);this.registerEvent(this.app.workspace.on("editor-change",(i,n)=>{this.settings.enabled&&this.settings.agentId&&t(i,n)})),this.addCommand({id:"trigger-therapist",name:"Ask therapist to respond",editorCallback:(i,n)=>{this.handleEditorChange(i,n,!0)}}),this.addCommand({id:"toggle-therapist",name:"Toggle therapist on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.saveSettings(),this.updateStatusBar();let i=this.settings.enabled?"enabled":"disabled";new h.Notice(`Therapist ${i}`)}}),this.addCommand({id:"index-vault",name:"Reindex vault for therapist context",callback:async()=>{if(!this.settings.agentId){new h.Notice("Create an agent first in settings");return}if(this.isIndexing){new h.Notice("Indexing already in progress");return}this.isIndexing=!0;try{let i=this.getIndexFilter(),n=await this.vaultIndexer.indexVault(this.settings.agentId,i);new h.Notice(`Indexed ${n.files} files (${n.passages} passages)`)}catch(i){console.error("Indexing failed:",i),new h.Notice(`Indexing failed: ${i instanceof Error?i.message:"Unknown error"}`)}finally{this.isIndexing=!1}}}),this.statusBarEl=this.addStatusBarItem(),this.updateStatusBar(),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.checkCurrentNote()})),this.registerEvent(this.app.workspace.on("file-open",()=>{this.checkCurrentNote()})),this.checkCurrentNote(),this.settings.autoIndex&&this.settings.agentId&&this.startAutoIndexing(),console.log("Therapist plugin loaded")}getIndexFilter(){return{mode:this.settings.indexMode,folders:this.settings.indexFolders.split(",").map(t=>t.trim()).filter(t=>t)}}startAutoIndexing(){if(this.stopAutoIndexing(),!this.settings.agentId)return;let t=this.app.vault.on("modify",n=>{n instanceof h.TFile&&n.extension==="md"&&this.queueFileForIndexing(n)});this.autoIndexEvents.push(t),this.registerEvent(t);let i=this.app.vault.on("create",n=>{n instanceof h.TFile&&n.extension==="md"&&this.queueFileForIndexing(n)});this.autoIndexEvents.push(i),this.registerEvent(i),console.log("Auto-indexing started")}stopAutoIndexing(){this.autoIndexEvents=[],this.indexDebounceTimer&&(clearTimeout(this.indexDebounceTimer),this.indexDebounceTimer=null),this.indexQueue.clear(),console.log("Auto-indexing stopped")}queueFileForIndexing(t){this.indexQueue.add(t.path),this.indexDebounceTimer&&clearTimeout(this.indexDebounceTimer),this.indexDebounceTimer=setTimeout(()=>{this.processIndexQueue()},5e3)}async processIndexQueue(){if(this.indexQueue.size===0||!this.settings.agentId)return;let t=[...this.indexQueue];this.indexQueue.clear();let i=this.getIndexFilter();for(let n of t){let r=this.app.vault.getAbstractFileByPath(n);r instanceof h.TFile&&await this.vaultIndexer.indexSingleFile(r,this.settings.agentId,i)}}checkCurrentNote(){if(!this.settings.enabled||!this.settings.agentId){this.updateStatusBar();return}let t=this.app.workspace.getActiveViewOfType(h.MarkdownView);if(!t){this.updateStatusBar("no-journal");return}let i=t.editor.getValue(),n=b(i)!==null;this.updateStatusBar(n?"listening":"no-journal")}updateStatusBar(t){if(this.statusBarEl){if(!this.settings.enabled){this.statusBarEl.setText("\u25CB Therapist off"),this.statusBarEl.setAttribute("aria-label","Therapist is disabled");return}if(!this.settings.agentId){this.statusBarEl.setText("\u25CB No agent"),this.statusBarEl.setAttribute("aria-label","No therapist agent configured");return}switch(t){case"thinking":this.statusBarEl.setText("\u25C9 Thinking..."),this.statusBarEl.setAttribute("aria-label","Therapist is processing");break;case"no-journal":this.statusBarEl.setText("\u25E6 No journal section"),this.statusBarEl.setAttribute("aria-label","Add a ## Journal header to enable");break;case"off":this.statusBarEl.setText("\u25CB Therapist off"),this.statusBarEl.setAttribute("aria-label","Therapist is disabled");break;default:this.statusBarEl.setText("\u25CF Listening"),this.statusBarEl.setAttribute("aria-label","Therapist is monitoring")}}}async handleEditorChange(t,i,n=!1){if(this.isProcessing)return;if(!this.settings.agentId){console.error("No agent configured - create one in settings");return}let r=t.getValue(),s=b(r);if(!s){this.updateStatusBar("no-journal");return}this.updateStatusBar("listening");let a=P(s);if(!a||F(a))return;let o=N(a);this.isProcessing=!0,this.updateStatusBar("thinking");try{let g=o||n?`[User is asking for your input]

`:`[User is journaling - respond only if you have something valuable to add]

`,u=await this.lettaService.sendMessage(this.settings.agentId,g+a),I=(u==null?void 0:u.trim())||"";if(I&&I!=="[listening]"){let S=t.getCursor().line;t.setCursor({line:S,ch:t.getLine(S).length}),t.replaceSelection($(u))}}catch(g){console.error("Error getting therapist response:",g)}finally{this.isProcessing=!1,this.updateStatusBar("listening")}}onunload(){this.stopAutoIndexing(),console.log("Therapist plugin unloaded")}async loadSettings(){this.settings=Object.assign({},T,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
