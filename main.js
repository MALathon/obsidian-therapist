var x=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var A=(h,s)=>{for(var t in s)x(h,t,{get:s[t],enumerable:!0})},$=(h,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of N(s))!B.call(h,i)&&i!==t&&x(h,i,{get:()=>s[i],enumerable:!(e=M(s,i))||e.enumerable});return h};var D=h=>$(x({},"__esModule",{value:!0}),h);var L={};A(L,{default:()=>b});module.exports=D(L);var c=require("obsidian"),P=require("obsidian");var l=require("obsidian"),k={lettaUrl:"http://localhost:8283",apiKey:"",openaiApiKey:"",anthropicApiKey:"",agentId:"",agentName:"",agentModel:"",therapistName:"Therapist",enabled:!0,debounceMs:3e3,indexVault:!1,includedFolders:[],excludedFolders:[],archiveId:"",lastIndexed:0},v=class extends l.FuzzySuggestModal{constructor(s,t){super(s),this.onChoose=t}getItems(){let s=[],t=this.app.vault.getRoot(),e=i=>{s.push(i);for(let n of i.children)n instanceof l.TFolder&&e(n)};return e(t),s}getItemText(s){return s.path||"/"}onChooseItem(s){this.onChoose(s)}},y=class extends l.PluginSettingTab{constructor(s,t){super(s,t),this.plugin=t}async display(){let{containerEl:s}=this;s.empty();let t=!!this.plugin.settings.agentId;if(t&&!this.plugin.settings.agentName){let e=await this.plugin.lettaService.getAgent(this.plugin.settings.agentId);e&&(this.plugin.settings.agentName=e.name,this.plugin.settings.agentModel=e.model,await this.plugin.saveSettings())}if(t){s.createEl("h2",{text:"Your Therapist"}),new l.Setting(s).setName("Name").setDesc("What should your therapist call themselves?").addText(a=>a.setPlaceholder("Therapist").setValue(this.plugin.settings.therapistName).onChange(async o=>{this.plugin.settings.therapistName=o||"Therapist",await this.plugin.saveSettings()})),new l.Setting(s).setName("Model").descEl.createSpan({text:this.plugin.settings.agentModel||"unknown",cls:"therapist-model-badge"}),new l.Setting(s).setName("Active").setDesc("Turn the therapist on or off").addToggle(a=>a.setValue(this.plugin.settings.enabled).onChange(async o=>{this.plugin.settings.enabled=o,await this.plugin.saveSettings(),this.plugin.updateStatusBar()})),new l.Setting(s).setName("Memory").setDesc("View what your therapist remembers about you").addButton(a=>a.setButtonText("View Memory").onClick(()=>{this.plugin.openMemoryViewer()}));let r=new l.Setting(s).setName("Agent ID").addButton(a=>a.setButtonText("Copy").onClick(()=>{navigator.clipboard.writeText(this.plugin.settings.agentId),new l.Notice("Agent ID copied")})).addButton(a=>a.setButtonText("Delete").setWarning().onClick(async()=>{try{await this.plugin.lettaService.deleteAgent(this.plugin.settings.agentId),new l.Notice("Agent deleted")}catch(o){console.warn("Could not delete from server:",o)}this.plugin.settings.agentId="",this.plugin.settings.agentName="",this.plugin.settings.agentModel="",this.plugin.settings.therapistName="Therapist",await this.plugin.saveSettings(),this.display()})).descEl.createEl("code",{text:this.plugin.settings.agentId});r.style.fontSize="0.75em",r.style.userSelect="all"}if(!t){s.createEl("h2",{text:"Create Therapist"});let e="letta/letta-free",i=null;new l.Setting(s).setName("Model").setDesc("Select which AI model to use").addDropdown(n=>{i=n,n.addOption("letta/letta-free","letta/letta-free (free)"),n.setValue(e),n.onChange(r=>{e=r})}).addButton(n=>n.setButtonText("Refresh Models").onClick(async()=>{try{let r=await this.plugin.lettaService.listModels();i.selectEl.empty(),i.addOption("letta/letta-free","letta/letta-free (free)");for(let a of r)a.handle!=="letta/letta-free"&&i.addOption(a.handle,a.handle);i.setValue(e),new l.Notice(`Found ${r.length} models`)}catch(r){new l.Notice("Failed to fetch models")}})),new l.Setting(s).setName("").addButton(n=>n.setButtonText("Create Therapist").setCta().onClick(async()=>{try{new l.Notice(`Creating agent with ${e}...`);let r=await this.plugin.lettaService.createAgent("therapist","therapist",e,"letta/letta-free");this.plugin.settings.agentId=r,this.plugin.settings.agentModel=e,this.plugin.settings.agentName="therapist",await this.plugin.saveSettings(),new l.Notice("Therapist created! Start journaling."),this.display()}catch(r){console.error("Failed to create agent:",r),new l.Notice(`Failed: ${r instanceof Error?r.message:"Unknown error"}`)}}))}if(s.createEl("h3",{text:"Behavior"}),new l.Setting(s).setName("Response delay").setDesc("Seconds to wait after you stop typing before responding").addSlider(e=>e.setLimits(1,10,1).setValue(this.plugin.settings.debounceMs/1e3).setDynamicTooltip().onChange(async i=>{this.plugin.settings.debounceMs=i*1e3,await this.plugin.saveSettings()})),t&&(s.createEl("h3",{text:"Vault Memory"}),s.createEl("p",{text:"Index your vault so your therapist can reference your notes during sessions.",cls:"setting-item-description"}),new l.Setting(s).setName("Enable vault indexing").setDesc("Automatically index notes for the therapist to reference").addToggle(e=>e.setValue(this.plugin.settings.indexVault).onChange(async i=>{this.plugin.settings.indexVault=i,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.indexVault)){let e=new l.Setting(s).setName("Included folders").setDesc("Only index notes in these folders. Leave empty to include all.").addButton(a=>a.setButtonText("Add folder").onClick(()=>{new v(this.app,async o=>{let d=o.path||"/";this.plugin.settings.includedFolders.includes(d)||(this.plugin.settings.includedFolders.push(d),await this.plugin.saveSettings(),this.display())}).open()}));if(this.plugin.settings.includedFolders.length>0){let a=e.settingEl.createDiv({cls:"therapist-folder-list"});for(let o of this.plugin.settings.includedFolders){let d=a.createDiv({cls:"therapist-folder-item"});d.createSpan({text:o||"/",cls:"therapist-folder-path"}),d.createEl("button",{text:"\xD7",cls:"therapist-folder-remove"}).addEventListener("click",async()=>{this.plugin.settings.includedFolders=this.plugin.settings.includedFolders.filter(m=>m!==o),await this.plugin.saveSettings(),this.display()})}}let i=new l.Setting(s).setName("Excluded folders").setDesc("Never index notes in these folders").addButton(a=>a.setButtonText("Add folder").onClick(()=>{new v(this.app,async o=>{let d=o.path||"/";this.plugin.settings.excludedFolders.includes(d)||(this.plugin.settings.excludedFolders.push(d),await this.plugin.saveSettings(),this.display())}).open()}));if(this.plugin.settings.excludedFolders.length>0){let a=i.settingEl.createDiv({cls:"therapist-folder-list"});for(let o of this.plugin.settings.excludedFolders){let d=a.createDiv({cls:"therapist-folder-item"});d.createSpan({text:o||"/",cls:"therapist-folder-path"}),d.createEl("button",{text:"\xD7",cls:"therapist-folder-remove"}).addEventListener("click",async()=>{this.plugin.settings.excludedFolders=this.plugin.settings.excludedFolders.filter(m=>m!==o),await this.plugin.saveSettings(),this.display()})}}let n=this.plugin.settings.lastIndexed,r=n>0?`Last indexed: ${new Date(n).toLocaleString()}`:"Not yet indexed";new l.Setting(s).setName("Index status").setDesc(r).addButton(a=>a.setButtonText("Reindex Now").onClick(async()=>{a.setButtonText("Indexing..."),a.setDisabled(!0);try{await this.plugin.indexVault(),new l.Notice("Vault indexed successfully"),this.display()}catch(o){console.error("Indexing failed:",o),new l.Notice(`Indexing failed: ${o instanceof Error?o.message:"Unknown error"}`),a.setButtonText("Reindex Now"),a.setDisabled(!1)}})).addButton(a=>a.setButtonText("View Memory").onClick(()=>{this.plugin.openMemoryViewer()}))}s.createEl("h3",{text:"Server"}),new l.Setting(s).setName("Letta URL").setDesc("Your Letta server address").addText(e=>e.setPlaceholder("http://localhost:8283").setValue(this.plugin.settings.lettaUrl).onChange(async i=>{this.plugin.settings.lettaUrl=i,this.plugin.lettaService.setBaseUrl(i),await this.plugin.saveSettings()})).addButton(e=>e.setButtonText("Test").onClick(async()=>{try{let i=`${this.plugin.settings.lettaUrl}/v1/health/`,n=await(0,l.requestUrl)({url:i});n.status===200?new l.Notice("Connected!"):new l.Notice(`Error: ${n.status}`)}catch(i){new l.Notice("Connection failed")}})),new l.Setting(s).setName("Letta API Key").setDesc("Only needed if your server requires authentication").addText(e=>e.setPlaceholder("sk-let-...").setValue(this.plugin.settings.apiKey).onChange(async i=>{this.plugin.settings.apiKey=i,this.plugin.lettaService.setApiKey(i),await this.plugin.saveSettings()})),s.createEl("h3",{text:"LLM API Keys"}),s.createEl("p",{text:"Required for cloud models. Leave blank if using letta-free or local Ollama.",cls:"setting-item-description"}),new l.Setting(s).setName("Anthropic").setDesc("For Claude models").addText(e=>e.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async i=>{if(this.plugin.settings.anthropicApiKey=i,await this.plugin.saveSettings(),i)try{await this.plugin.lettaService.updateProviderKey("anthropic",i)}catch(n){console.warn("Could not update provider key:",n)}})),new l.Setting(s).setName("OpenAI").setDesc("For GPT models").addText(e=>e.setPlaceholder("sk-proj-...").setValue(this.plugin.settings.openaiApiKey).onChange(async i=>{if(this.plugin.settings.openaiApiKey=i,await this.plugin.saveSettings(),i)try{await this.plugin.lettaService.updateProviderKey("openai",i)}catch(n){console.warn("Could not update provider key:",n)}}))}};var g=require("obsidian"),T={therapist:`You are my personal coach. Read between the lines of what I write.

My journaling may be scattered, venting, or stream-of-consciousness. Your job:
1. Silently figure out what's actually going on beneath the surface
2. Respond to what I need, not what I literally said

RESPONSE PROTOCOL:
- Messages prefixed with "[User is asking for your input]" \u2192 Always respond
- Messages prefixed with "[User is journaling...]" \u2192 Only respond if you have genuine insight
- If you have nothing valuable to add, respond with just: [listening]

WHEN TO RESPOND:
- I'm stuck and need a push \u2192 Give ONE specific thing to try
- I'm avoiding something obvious \u2192 Name it directly
- I'm spiraling \u2192 Ground me with something concrete
- I keep coming back to the same problem \u2192 Offer a real suggestion
- I'm asking you directly \u2192 Answer me

WHEN TO STAY SILENT (respond with [listening]):
- I'm just processing emotions
- I'm venting and don't need fixing
- I'm working through something myself
- You'd just be restating what I said

WHEN YOU DO RESPOND, be specific:
- Times: "Try this tomorrow morning" not "sometime"
- Quantities: "Track 3 days" not "for a while"
- Observable: "Notice if..." not vague outcomes

Be real. Don't be a robot that dispenses advice. Be the friend who knows when to push and when to shut up.

Keep responses short. 1-3 sentences usually. Match my energy.`,analyst:`You observe patterns across journal sessions and give specific improvement suggestions.

When you notice a pattern, respond with:
\u{1F4CA} Pattern: [what you noticed across sessions]
\u{1F3AF} Suggestion: [one specific change to try]

Examples:
- "\u{1F4CA} Pattern: Stress spikes on Mondays, usually mentions Sunday night anxiety. \u{1F3AF} Suggestion: Do a 10-min Monday preview on Sunday at 4pm - just look at your calendar and write 3 things you'll handle first."
- "\u{1F4CA} Pattern: Overspending happens after stressful days. \u{1F3AF} Suggestion: Add a 24-hour rule - when stressed, screenshot items instead of buying. Review tomorrow."
- "\u{1F4CA} Pattern: Energy drops after lunch on workdays. \u{1F3AF} Suggestion: Try a 10-min walk immediately after eating for one week. Track energy at 3pm."

Only speak when you spot something actionable. Quality over quantity.`,custom:"You are a helpful assistant in a journaling session. Be supportive and give practical suggestions when appropriate."},f=class{constructor(s,t=""){this.providerKeys={};this.baseUrl=s,this.apiKey=t}setBaseUrl(s){this.baseUrl=s}setApiKey(s){this.apiKey=s}setProviderKey(s,t){this.providerKeys[s]=t}getHeaders(){let s={"Content-Type":"application/json"};return this.apiKey&&(s.Authorization=`Bearer ${this.apiKey}`),s}async listModels(){let s=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/models`,headers:this.getHeaders()});if(s.status!==200)throw new Error("Failed to fetch models");return s.json.map(e=>({handle:e.handle,name:e.name,provider:e.provider_name}))}async updateProviderKey(s,t){try{let n=(await(0,g.requestUrl)({url:`${this.baseUrl}/v1/providers/`,headers:this.getHeaders()})).json.find(r=>r.provider_type===s);if(n)await(0,g.requestUrl)({url:`${this.baseUrl}/v1/providers/${n.id}`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({api_key:t})}),console.log(`Updated ${s} provider`);else try{await(0,g.requestUrl)({url:`${this.baseUrl}/v1/providers/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:s,provider_type:s,api_key:t})}),console.log(`Created ${s} provider`)}catch(r){console.warn(`Provider ${s} may already exist (409), trying alternate approach`);let o=(await(0,g.requestUrl)({url:`${this.baseUrl}/v1/providers/`,headers:this.getHeaders()})).json.find(d=>d.provider_type===s||d.name===s);o?(await(0,g.requestUrl)({url:`${this.baseUrl}/v1/providers/${o.id}`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({api_key:t})}),console.log(`Updated ${s} provider on retry`)):console.error(`Provider ${s} exists in database but not retrievable. May need to reset Letta.`)}}catch(e){console.warn("Failed to update provider key:",e)}}async createAgent(s,t,e="ollama/llama3.2",i="ollama/nomic-embed-text",n){let r=n||T[t]||T.custom,a=e.includes("/")?e.split("/")[0]:null,o={name:s,model:e,embedding:i,enable_sleeptime:!0,memory_blocks:[{label:"persona",value:r},{label:"human",value:"[Learning about you through our sessions...]"}]};if(a&&a!=="letta"&&a!=="ollama"){let p=e.includes("/")?e.split("/").slice(1).join("/"):e;o.llm_config={model:p,model_endpoint_type:a,provider_name:a,context_window:2e5}}let d=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify(o)});if(d.status!==200)throw new Error(`Failed to create agent: ${d.text}`);return d.json.id}async sendMessage(s,t){let e=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${s}/messages`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({messages:[{role:"user",content:t}]})});if(e.status!==200)throw new Error(`Failed to send message: ${e.text}`);let i=e.json;for(let r of i.messages)if(r.message_type==="assistant_message")return r.content;let n=i.messages[i.messages.length-1];return(n==null?void 0:n.content)||""}async getAgent(s){var t;try{let e=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${s}`,headers:this.getHeaders()});if(e.status!==200)return null;let i=e.json;return{id:i.id,name:i.name,model:i.model||((t=i.llm_config)==null?void 0:t.model)||"unknown"}}catch(e){return null}}async deleteAgent(s){let t=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${s}`,method:"DELETE",headers:this.getHeaders()});if(t.status!==200&&t.status!==204)throw new Error(`Failed to delete agent: ${t.text}`)}async healthCheck(){try{return(await(0,g.requestUrl)({url:`${this.baseUrl}/v1/health`})).status===200}catch(s){return!1}}async createArchive(s,t="letta/letta-free"){let e=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/archives/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:s,description:"Obsidian vault content for therapist context",embedding:t})});if(e.status!==200)throw new Error(`Failed to create archive: ${e.text}`);return e.json.id}async listArchives(){let s=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/archives/`,headers:this.getHeaders()});if(s.status!==200)throw new Error("Failed to list archives");return s.json.map(t=>({id:t.id,name:t.name}))}async addPassage(s,t,e={}){let i=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/archives/${s}/passages/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({text:t,metadata:e})});if(i.status!==200)throw new Error(`Failed to add passage: ${i.text}`)}async attachArchive(s,t){let e=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${s}/archives/attach/${t}/`,method:"POST",headers:this.getHeaders()});if(e.status!==200)throw new Error(`Failed to attach archive: ${e.text}`)}async clearArchive(s){let t=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/archives/${s}/passages/`,headers:this.getHeaders()});if(t.status!==200)return;let e=t.json;for(let i of e)try{await(0,g.requestUrl)({url:`${this.baseUrl}/v1/archives/${s}/passages/${i.id}/`,method:"DELETE",headers:this.getHeaders()})}catch(n){}}async getMemoryBlocks(s){let t=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${s}/memory/blocks/`,headers:this.getHeaders()});if(t.status!==200)throw new Error("Failed to get memory blocks");return t.json.map(e=>({id:e.id,label:e.label,value:e.value}))}async updateMemoryBlock(s,t,e){if((await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${s}/memory/blocks/${t}/`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({value:e})})).status!==200)throw new Error("Failed to update memory block")}async getArchivalMemory(s,t=100){let e=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${s}/archival/?limit=${t}`,headers:this.getHeaders()});if(e.status!==200)throw new Error("Failed to get archival memory");return e.json.map(i=>({id:i.id,text:i.text,created_at:i.created_at}))}async deleteArchivalMemory(s,t){let e=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${s}/archival/${t}/`,method:"DELETE",headers:this.getHeaders()});if(e.status!==200&&e.status!==204)throw new Error("Failed to delete archival memory")}async getRecallMemory(s,t=50){let e=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${s}/recall/?limit=${t}`,headers:this.getHeaders()});return e.status!==200?[]:e.json.map(i=>({id:i.id,text:i.text,created_at:i.created_at}))}};function F(h="Therapist"){return`> **${h}:**`}function E(h){let s=/^>\s*\*\*[^*]+:\*\*/gm,t=-1,e;for(;(e=s.exec(h))!==null;)t=e.index;if(t===-1)return h.trim();let n=h.substring(t).split(`
`),r=-1,a=!0;for(let o=0;o<n.length;o++){let p=n[o].trim();if(a){if(p===""||p.startsWith(">"))continue;r=o;break}}return r===-1?"":n.slice(r).join(`
`).trim()}function I(h){let s=h.trim();return/^>\s*\*\*[^*]+:\*\*/.test(s)}function C(h,s="Therapist"){let t=F(s);return`

${h.split(`
`).map((n,r)=>r===0?`${t} ${n}`:n.trim()===""?">":`> ${n}`).join(`
`)}

`}var u=require("obsidian"),w=class extends u.Modal{constructor(t,e,i){super(t);this.activeTab="blocks";this.memoryBlocks=[];this.archivalMemories=[];this.isLoading=!0;this.lettaService=e,this.agentId=i}async onOpen(){let{contentEl:t}=this;t.addClass("therapist-memory-modal"),t.empty(),t.createEl("h2",{text:"Therapist Memory"});let e=t.createDiv({cls:"therapist-memory-tabs"}),i=e.createEl("button",{text:"Core Memory",cls:"therapist-memory-tab is-active"}),n=e.createEl("button",{text:"Archival Memory",cls:"therapist-memory-tab"});i.addEventListener("click",()=>{this.activeTab="blocks",i.addClass("is-active"),n.removeClass("is-active"),this.renderContent()}),n.addEventListener("click",()=>{this.activeTab="archival",n.addClass("is-active"),i.removeClass("is-active"),this.renderContent()}),t.createDiv({cls:"therapist-memory-content"}),await this.loadData(),this.renderContent()}async loadData(){this.isLoading=!0;try{let[t,e]=await Promise.all([this.lettaService.getMemoryBlocks(this.agentId),this.lettaService.getArchivalMemory(this.agentId,100)]);this.memoryBlocks=t,this.archivalMemories=e}catch(t){console.error("Failed to load memory:",t),new u.Notice("Failed to load memory")}this.isLoading=!1}renderContent(){let t=this.contentEl.querySelector(".therapist-memory-content");if(t){if(t.empty(),this.isLoading){t.createDiv({text:"Loading...",cls:"therapist-memory-empty"});return}this.activeTab==="blocks"?this.renderMemoryBlocks(t):this.renderArchivalMemory(t)}}renderMemoryBlocks(t){let e=t.createDiv({cls:"therapist-memory-section"});if(e.createEl("h3",{text:"Core Memory Blocks"}),e.createEl("p",{text:"These are the core memories your therapist maintains about you and their persona.",cls:"setting-item-description"}),this.memoryBlocks.length===0){e.createDiv({text:"No memory blocks found",cls:"therapist-memory-empty"});return}for(let i of this.memoryBlocks){let n=e.createDiv({cls:"therapist-memory-block"}),r=n.createDiv({cls:"therapist-memory-block-header"});r.createSpan({text:i.label,cls:"therapist-memory-block-label"}),n.createDiv({cls:"therapist-memory-block-content"}).setText(i.value),i.label==="human"&&r.createEl("button",{text:"Edit",cls:"therapist-memory-delete"}).addEventListener("click",()=>this.editMemoryBlock(i))}}renderArchivalMemory(t){let e=t.createDiv({cls:"therapist-memory-section"});if(e.createEl("h3",{text:"Archival Memories"}),e.createEl("p",{text:"Long-term memories your therapist has stored. These are facts and observations the agent has explicitly chosen to remember.",cls:"setting-item-description"}),this.archivalMemories.length===0){e.createDiv({text:"No archival memories yet. Your therapist will build memories as you interact.",cls:"therapist-memory-empty"});return}let i=[...this.archivalMemories].sort((n,r)=>new Date(r.created_at).getTime()-new Date(n.created_at).getTime());for(let n of i){let r=e.createDiv({cls:"therapist-memory-item"}),a=r.createDiv({cls:"therapist-memory-item-content"});a.createDiv({text:n.text});let o=new Date(n.created_at);a.createDiv({text:o.toLocaleDateString()+" "+o.toLocaleTimeString(),cls:"therapist-memory-item-date"}),r.createDiv({cls:"therapist-memory-item-actions"}).createEl("button",{text:"Delete",cls:"therapist-memory-delete"}).addEventListener("click",async()=>{try{await this.lettaService.deleteArchivalMemory(this.agentId,n.id),this.archivalMemories=this.archivalMemories.filter(m=>m.id!==n.id),this.renderContent(),new u.Notice("Memory deleted")}catch(m){console.error("Failed to delete memory:",m),new u.Notice("Failed to delete memory")}})}}async editMemoryBlock(t){new S(this.app,t.value,async i=>{try{await this.lettaService.updateMemoryBlock(this.agentId,t.id,i),t.value=i,this.renderContent(),new u.Notice("Memory updated")}catch(n){console.error("Failed to update memory:",n),new u.Notice("Failed to update memory")}}).open()}onClose(){let{contentEl:t}=this;t.empty()}},S=class extends u.Modal{constructor(s,t,e){super(s),this.value=t,this.onSave=e}onOpen(){let{contentEl:s}=this;s.createEl("h2",{text:"Edit Memory"});let t=s.createEl("textarea",{cls:"therapist-memory-edit-textarea"});t.value=this.value,t.style.width="100%",t.style.height="300px",t.style.resize="vertical",t.style.fontFamily="var(--font-monospace)",t.style.fontSize="13px",t.style.padding="12px",t.style.marginBottom="16px";let e=s.createDiv({cls:"therapist-memory-edit-buttons"});e.style.display="flex",e.style.gap="8px",e.style.justifyContent="flex-end",e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let n=e.createEl("button",{text:"Save",cls:"mod-cta"});n.addEventListener("click",async()=>{n.setAttr("disabled","true"),n.setText("Saving..."),await this.onSave(t.value),this.close()})}onClose(){let{contentEl:s}=this;s.empty()}};var b=class extends c.Plugin{constructor(){super(...arguments);this.isProcessing=!1;this.statusBarEl=null;this.pendingInsight=null;this.indicatorEl=null;this.popoverEl=null;this.popoverVisible=!1}async onload(){await this.loadSettings(),this.lettaService=new f(this.settings.lettaUrl,this.settings.apiKey),this.addSettingTab(new y(this.app,this));let t=(0,c.debounce)((e,i)=>this.observeContent(e,i),this.settings.debounceMs,!0);this.registerEvent(this.app.workspace.on("editor-change",(e,i)=>{this.settings.enabled&&this.settings.agentId&&t(e,i)})),this.addCommand({id:"trigger-therapist",name:"Talk to therapist (inline response)",editorCallback:async(e,i)=>{await this.triggerConversation(e,i)}}),this.addCommand({id:"copy-insight",name:"Copy insight to daily note",callback:()=>{this.pendingInsight?this.copyToDailyNote():new c.Notice("No insight available")}}),this.addCommand({id:"toggle-therapist",name:"Toggle therapist on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.settings.enabled?this.checkCurrentNote():(this.pendingInsight=null,this.hideIndicator()),this.saveSettings(),this.updateStatusBar(),new c.Notice(`Therapist ${this.settings.enabled?"enabled":"disabled"}`)}}),this.addCommand({id:"view-memory",name:"View therapist memory",callback:()=>{this.openMemoryViewer()}}),this.addCommand({id:"reindex-vault",name:"Reindex vault for therapist",callback:async()=>{if(!this.settings.agentId){new c.Notice("No therapist agent configured");return}if(!this.settings.indexVault){new c.Notice("Vault indexing is not enabled");return}new c.Notice("Starting vault indexing...");try{await this.indexVault(),new c.Notice("Vault indexed successfully")}catch(e){console.error("Indexing failed:",e),new c.Notice(`Indexing failed: ${e instanceof Error?e.message:"Unknown error"}`)}}}),this.statusBarEl=this.addStatusBarItem(),this.updateStatusBar(),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.checkCurrentNote()})),this.registerEvent(this.app.workspace.on("file-open",()=>{this.checkCurrentNote()})),this.registerDomEvent(document,"click",e=>{this.popoverVisible&&this.indicatorEl&&(this.indicatorEl.contains(e.target)||this.hidePopover())}),this.checkCurrentNote(),console.log("Therapist plugin loaded")}checkCurrentNote(){if(this.pendingInsight=null,this.hidePopover(),!this.settings.enabled||!this.settings.agentId){this.hideIndicator(),this.updateStatusBar();return}if(!this.app.workspace.getActiveViewOfType(c.MarkdownView)){this.hideIndicator(),this.updateStatusBar("off");return}this.showIndicator("observing"),this.updateStatusBar("listening")}updateStatusBar(t){if(this.statusBarEl){if(!this.settings.enabled){this.statusBarEl.setText("\u25CB Therapist off");return}if(!this.settings.agentId){this.statusBarEl.setText("\u25CB No agent");return}switch(t){case"thinking":this.statusBarEl.setText("\u25C9 Observing...");break;case"insight":this.statusBarEl.setText("\u{1F4AD} Has insight");break;case"off":this.statusBarEl.setText("\u25CB Therapist off");break;default:this.statusBarEl.setText("\u25CF Observing")}}}async observeContent(t,e){if(this.isProcessing||!this.settings.agentId||this.pendingInsight)return;let i=t.getValue(),n=E(i);if(n&&!I(n)){this.isProcessing=!0,this.showIndicator("thinking"),this.updateStatusBar("thinking");try{let r=`[OBSERVER MODE - You are passively watching the user write. Only respond if you notice something genuinely insightful - a pattern, a reframe, a question worth asking, or an observation that could help. If nothing stands out, respond with just: [listening]]

${n}`,a=await this.lettaService.sendMessage(this.settings.agentId,r),o=(a==null?void 0:a.trim())||"";o&&o!=="[listening]"?(this.pendingInsight=a,this.showIndicator("insight"),this.updateStatusBar("insight")):(this.showIndicator("observing"),this.updateStatusBar("listening"))}catch(r){console.error("Error observing:",r),this.showIndicator("observing"),this.updateStatusBar("listening")}finally{this.isProcessing=!1}}}async triggerConversation(t,e){if(this.isProcessing)return;if(!this.settings.agentId){new c.Notice("No therapist agent configured");return}let i=t.getValue(),n=E(i);if(!n){new c.Notice("Nothing new to discuss");return}this.isProcessing=!0,this.showIndicator("thinking"),this.updateStatusBar("thinking");try{let r=`[CONVERSATION MODE - The user wants to talk. Respond directly and helpfully.]

${n}`,a=await this.lettaService.sendMessage(this.settings.agentId,r),o=(a==null?void 0:a.trim())||"";if(o&&o!=="[listening]"){let p=t.getCursor().line;t.setCursor({line:p,ch:t.getLine(p).length}),t.replaceSelection(C(a,this.settings.therapistName))}this.showIndicator("observing"),this.updateStatusBar("listening")}catch(r){console.error("Error in conversation:",r),new c.Notice("Failed to get response"),this.showIndicator("observing"),this.updateStatusBar("listening")}finally{this.isProcessing=!1}}showIndicator(t){let e=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(!e){this.hideIndicator();return}let i=e.contentEl;if(!this.indicatorEl){this.indicatorEl=document.createElement("div"),this.indicatorEl.className="therapist-indicator is-visible";let r=document.createElement("div");r.className="therapist-orb",r.addEventListener("click",a=>{a.stopPropagation(),this.pendingInsight&&this.togglePopover()}),this.indicatorEl.appendChild(r)}let n=this.indicatorEl.querySelector(".therapist-orb");n&&(n.classList.remove("is-thinking","has-insight"),t==="thinking"?n.classList.add("is-thinking"):t==="insight"&&n.classList.add("has-insight")),i.contains(this.indicatorEl)||i.appendChild(this.indicatorEl)}hideIndicator(){this.indicatorEl&&(this.indicatorEl.remove(),this.indicatorEl=null),this.hidePopover()}togglePopover(){this.popoverVisible?this.hidePopover():this.showPopover()}showPopover(){var e,i,n;if(!this.pendingInsight||!this.indicatorEl)return;this.popoverEl||(this.popoverEl=document.createElement("div"),this.popoverEl.className="therapist-popover",this.popoverEl.innerHTML=`
        <div class="therapist-popover-header">
          <span class="therapist-popover-title">Therapist Insight</span>
          <button class="therapist-popover-dismiss">\xD7</button>
        </div>
        <div class="therapist-popover-content"></div>
        <div class="therapist-popover-actions">
          <button class="therapist-popover-btn secondary dismiss-btn">Dismiss</button>
          <button class="therapist-popover-btn primary copy-btn">Copy to Daily Note</button>
        </div>
      `,(e=this.popoverEl.querySelector(".therapist-popover-dismiss"))==null||e.addEventListener("click",r=>{r.stopPropagation(),this.hidePopover()}),(i=this.popoverEl.querySelector(".dismiss-btn"))==null||i.addEventListener("click",r=>{r.stopPropagation(),this.dismissInsight()}),(n=this.popoverEl.querySelector(".copy-btn"))==null||n.addEventListener("click",r=>{r.stopPropagation(),this.copyToDailyNote()}),this.indicatorEl.appendChild(this.popoverEl));let t=this.popoverEl.querySelector(".therapist-popover-content");t&&(t.textContent=this.pendingInsight),this.popoverEl.classList.add("is-visible"),this.popoverVisible=!0}hidePopover(){this.popoverEl&&this.popoverEl.classList.remove("is-visible"),this.popoverVisible=!1}dismissInsight(){this.pendingInsight=null,this.hidePopover(),this.showIndicator("observing"),this.updateStatusBar("listening")}async copyToDailyNote(){if(this.pendingInsight)try{let t=(0,P.moment)().format("YYYY-MM-DD"),e=`${t}.md`,i=this.app.vault.getAbstractFileByPath(e);if(!i)i=await this.app.vault.create(e,`# ${t}

## Journal

### Therapist Insight

${this.pendingInsight}
`),new c.Notice("Created daily note with insight");else if(i instanceof c.TFile){let n=await this.app.vault.read(i);n.includes("## Journal")||(n+=`

## Journal
`);let r=n.indexOf("## Journal"),o=n.substring(r).substring(11).match(/\n## /),d=`
### Therapist Insight

${this.pendingInsight}
`;if(o){let p=r+11+o.index;n=n.substring(0,p)+d+n.substring(p)}else n+=d;await this.app.vault.modify(i,n),new c.Notice("Insight copied to daily note")}this.dismissInsight()}catch(t){console.error("Error copying to daily note:",t),new c.Notice("Failed to copy to daily note")}}onunload(){this.hideIndicator(),console.log("Therapist plugin unloaded")}async loadSettings(){this.settings=Object.assign({},k,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}openMemoryViewer(){if(!this.settings.agentId){new c.Notice("No therapist agent configured");return}new w(this.app,this.lettaService,this.settings.agentId).open()}async indexVault(){if(!this.settings.agentId)throw new Error("No agent configured");let t=this.settings.archiveId;if(!t){let r=(await this.lettaService.listArchives()).find(a=>a.name==="obsidian-vault");r?t=r.id:(t=await this.lettaService.createArchive("obsidian-vault"),await this.lettaService.attachArchive(this.settings.agentId,t)),this.settings.archiveId=t,await this.saveSettings()}await this.lettaService.clearArchive(t);let e=this.app.vault.getMarkdownFiles(),i=0;for(let n of e)if(this.shouldIndexFile(n))try{let r=await this.app.vault.read(n);if(r.trim().length<50)continue;let a=this.chunkContent(r,n.path);for(let o of a)await this.lettaService.addPassage(t,o.text,{source:n.path,title:n.basename});i++}catch(r){console.warn(`Failed to index ${n.path}:`,r)}this.settings.lastIndexed=Date.now(),await this.saveSettings(),console.log(`Indexed ${i} files`)}shouldIndexFile(t){let e=t.path;for(let i of this.settings.excludedFolders)if(!(i===""||i==="/")&&(e.startsWith(i+"/")||e===i))return!1;if(this.settings.includedFolders.length>0){if(this.settings.includedFolders.includes("")||this.settings.includedFolders.includes("/"))return!0;for(let n of this.settings.includedFolders)if(e.startsWith(n+"/")||e===n)return!0;return!1}return!0}chunkContent(t,e){let i=[],r=t.split(/\n\n+/),a=`[${e}]

`;for(let o of r){let d=o.trim();if(d){if(d.length<20&&d.startsWith("#")){a+=d+`

`;continue}a.length+d.length>1500&&a.length>100&&(i.push({text:a.trim()}),a=`[${e}]

`),a+=d+`

`}}return a.trim().length>50&&i.push({text:a.trim()}),i}};
