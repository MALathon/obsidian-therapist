var y=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var k=(l,t)=>{for(var n in t)y(l,n,{get:t[n],enumerable:!0})},x=(l,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of C(t))!E.call(l,a)&&a!==n&&y(l,a,{get:()=>t[a],enumerable:!(i=P(t,a))||i.enumerable});return l};var K=l=>x(y({},"__esModule",{value:!0}),l);var R={};k(R,{default:()=>c});module.exports=K(R);var u=require("obsidian");var g=require("obsidian"),v={lettaUrl:"http://localhost:8283",apiKey:"",openaiApiKey:"",anthropicApiKey:"",agents:[],multiAgentMode:"single",primaryAgentId:"",enabled:!0,debounceMs:3e3},p=class extends g.PluginSettingTab{constructor(t,n){super(t,n),this.plugin=n}display(){let{containerEl:t}=this;if(t.empty(),t.createEl("h2",{text:"Therapist Settings"}),new g.Setting(t).setName("Enabled").setDesc("Enable/disable the therapist").addToggle(s=>s.setValue(this.plugin.settings.enabled).onChange(async e=>{this.plugin.settings.enabled=e,await this.plugin.saveSettings()})),new g.Setting(t).setName("Letta Server URL").setDesc("URL of your Letta server").addText(s=>s.setPlaceholder("http://localhost:8283").setValue(this.plugin.settings.lettaUrl).onChange(async e=>{this.plugin.settings.lettaUrl=e,this.plugin.lettaService.setBaseUrl(e),await this.plugin.saveSettings()})),new g.Setting(t).setName("API Key").setDesc("Letta server API key (sk-let-...)").addText(s=>{s.inputEl.type="password",s.setPlaceholder("sk-let-...").setValue(this.plugin.settings.apiKey).onChange(async e=>{this.plugin.settings.apiKey=e,this.plugin.lettaService.setApiKey(e),await this.plugin.saveSettings()})}),t.createEl("h3",{text:"Cloud Provider Keys"}),new g.Setting(t).setName("OpenAI API Key").setDesc("For GPT-4, GPT-4o models").addText(s=>{s.inputEl.type="password",s.setPlaceholder("sk-proj-...").setValue(this.plugin.settings.openaiApiKey).onChange(async e=>{this.plugin.settings.openaiApiKey=e,this.plugin.lettaService.setProviderKey("openai",e),await this.plugin.saveSettings()})}),new g.Setting(t).setName("Anthropic API Key").setDesc("For Claude models").addText(s=>{s.inputEl.type="password",s.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async e=>{this.plugin.settings.anthropicApiKey=e,this.plugin.lettaService.setProviderKey("anthropic",e),await this.plugin.saveSettings()})}),new g.Setting(t).setName("Response Delay").setDesc("Seconds to wait after you stop typing before therapist responds").addSlider(s=>s.setLimits(1,10,1).setValue(this.plugin.settings.debounceMs/1e3).setDynamicTooltip().onChange(async e=>{this.plugin.settings.debounceMs=e*1e3,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Multi-Agent Configuration"}),new g.Setting(t).setName("Agent Mode").setDesc("How agents work together").addDropdown(s=>s.addOption("single","Single Agent").addOption("sequential","Sequential (agents respond in order)").addOption("parallel","Parallel (all agents respond)").setValue(this.plugin.settings.multiAgentMode).onChange(async e=>{this.plugin.settings.multiAgentMode=e,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.multiAgentMode==="single"&&this.plugin.settings.agents.length>0&&new g.Setting(t).setName("Primary Agent").setDesc("Which agent responds to your journal").addDropdown(s=>{for(let e of this.plugin.settings.agents)s.addOption(e.id,`${e.name} (${e.role})`);s.setValue(this.plugin.settings.primaryAgentId),s.onChange(async e=>{this.plugin.settings.primaryAgentId=e,await this.plugin.saveSettings()})}),this.plugin.settings.agents.length>0){t.createEl("h4",{text:"Your Agents"});for(let s of this.plugin.settings.agents){let e=new g.Setting(t).setName(`${s.name} (${s.role})`).setDesc(`Model: ${s.model}`);this.plugin.settings.multiAgentMode!=="single"&&e.addToggle(o=>o.setValue(s.enabled).setTooltip("Enable this agent").onChange(async r=>{s.enabled=r,await this.plugin.saveSettings()})),e.addButton(o=>o.setButtonText("Delete").setWarning().onClick(async()=>{var r;this.plugin.settings.agents=this.plugin.settings.agents.filter(d=>d.id!==s.id),this.plugin.settings.primaryAgentId===s.id&&(this.plugin.settings.primaryAgentId=((r=this.plugin.settings.agents[0])==null?void 0:r.id)||""),await this.plugin.saveSettings(),this.display()}))}}t.createEl("h4",{text:"Create New Agent"});let n="ollama/llama3.2",i="therapist",a="therapist";new g.Setting(t).setName("Agent Name").addText(s=>s.setPlaceholder("therapist").setValue(i).onChange(e=>{i=e})),new g.Setting(t).setName("Role").setDesc("Agent's specialized function").addDropdown(s=>s.addOption("therapist","Therapist - primary responder").addOption("analyst","Analyst - pattern recognition").addOption("memory","Memory - recalls past sessions").addOption("safety","Safety - monitors for concerns").addOption("custom","Custom").setValue(a).onChange(e=>{a=e})),new g.Setting(t).setName("Model").setDesc("LLM to power this agent").addText(s=>s.setPlaceholder("ollama/llama3.2 or openai/gpt-4o").setValue(n).onChange(e=>{n=e})),new g.Setting(t).setName("").addButton(s=>s.setButtonText("Create Agent").setCta().onClick(async()=>{try{let e=await this.plugin.lettaService.createAgent(i||a,a,n),o={id:e,model:n,name:i||a,role:a,enabled:!0,order:this.plugin.settings.agents.length};this.plugin.settings.agents.push(o),this.plugin.settings.primaryAgentId||(this.plugin.settings.primaryAgentId=e),await this.plugin.saveSettings(),this.display()}catch(e){console.error("Failed to create agent:",e)}})),new g.Setting(t).setName("Available Models").setDesc("Fetch list of models from server").addButton(s=>s.setButtonText("Refresh Models").onClick(async()=>{try{let o=(await this.plugin.lettaService.listModels()).map(r=>r.handle).join(`
`);console.log(`Available models:
`+o)}catch(e){console.error("Failed to fetch models:",e)}}))}};var b={therapist:`You are my therapist. We're in a journaling session.

As I write about my day, you:
- Ask questions to help me process what happened
- Point out patterns you've noticed from past sessions
- Give direct advice when it would be helpful
- Challenge my thinking when I'm distorting reality
- Help me understand myself better

Keep responses concise - 1-3 sentences usually. This is a conversation, not a lecture.
Be warm but direct. Don't just reflect - actually help me.`,analyst:`You are a pattern analyst observing therapy sessions.

Your role:
- Notice recurring themes, behaviors, and emotional patterns
- Connect current experiences to past sessions
- Identify cognitive distortions or unhelpful thought patterns
- Surface insights the primary therapist might miss

Keep observations brief and actionable. Only speak when you notice something significant.
Format: "\u{1F4CA} Pattern: [observation]"`,memory:`You are the memory keeper for therapy sessions.

Your role:
- Synthesize and consolidate insights from conversations
- Remember key events, breakthroughs, and recurring themes
- Surface relevant memories when they connect to current discussion
- Build a coherent narrative of the person's growth journey

During active sessions, briefly note when past memories are relevant.
Format: "\u{1F4AD} I remember: [relevant memory or connection]"

During sleep/idle time, consolidate learnings into lasting memories.`,safety:`You are a safety monitor for therapy sessions.

Your role:
- Watch for signs of crisis, self-harm ideation, or severe distress
- Flag when professional help might be needed
- Ensure conversations stay supportive and constructive

Only respond if you detect a safety concern. Stay silent otherwise.
Format: "\u26A0\uFE0F Safety note: [concern and suggestion]"`,custom:"You are an assistant in a journaling session. Be helpful and supportive."},h=class{constructor(t,n=""){this.providerKeys={};this.baseUrl=t,this.apiKey=n}setBaseUrl(t){this.baseUrl=t}setApiKey(t){this.apiKey=t}setProviderKey(t,n){this.providerKeys[t]=n}getHeaders(){let t={"Content-Type":"application/json"};return this.apiKey&&(t.Authorization=`Bearer ${this.apiKey}`),t}async listModels(){let t=await fetch(`${this.baseUrl}/v1/models/`,{headers:this.getHeaders()});if(!t.ok)throw new Error("Failed to fetch models");return(await t.json()).map(i=>({handle:i.handle,name:i.name,provider:i.provider_name}))}async updateProviderKey(t,n){let i=await fetch(`${this.baseUrl}/v1/providers/${t}`,{method:"PUT",headers:this.getHeaders(),body:JSON.stringify({api_key:n})});if(!i.ok){let a=await i.text();console.warn(`Failed to update provider key: ${a}`)}}async createAgent(t,n,i="ollama/llama3.2",a="ollama/nomic-embed-text"){let s=b[n]||b.custom,e=await fetch(`${this.baseUrl}/v1/agents`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:t,model:i,embedding:a,enable_sleeptime:!0,memory_blocks:[{label:"persona",value:s},{label:"human",value:"[Learning about you through our sessions...]"}]})});if(!e.ok){let r=await e.text();throw new Error(`Failed to create agent: ${r}`)}return(await e.json()).id}async sendMessage(t,n){let i=await fetch(`${this.baseUrl}/v1/agents/${t}/messages`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({messages:[{role:"user",content:n}]})});if(!i.ok){let e=await i.text();throw new Error(`Failed to send message: ${e}`)}let a=await i.json();for(let e of a.messages)if(e.message_type==="assistant_message")return e.content;let s=a.messages[a.messages.length-1];return(s==null?void 0:s.content)||""}async healthCheck(){try{return(await fetch(`${this.baseUrl}/v1/health`)).ok}catch(t){return!1}}};var f="> **Therapist:**";function A(l){let t=l.lastIndexOf(f);if(t===-1)return l.trim();let i=l.substring(t).match(/\n\n(?!>)(.+)/s);return i?i[1].trim():""}function S(l){return l.trim().startsWith(f)}function T(l){return`

${f} ${l}

`}var c=class extends u.Plugin{constructor(){super(...arguments);this.isProcessing=!1}async onload(){await this.loadSettings(),this.lettaService=new h(this.settings.lettaUrl,this.settings.apiKey),this.addSettingTab(new p(this.app,this));let n=(0,u.debounce)((i,a)=>this.handleEditorChange(i,a),this.settings.debounceMs,!0);this.registerEvent(this.app.workspace.on("editor-change",(i,a)=>{this.settings.enabled&&n(i,a)})),this.addCommand({id:"trigger-therapist",name:"Ask therapist to respond",editorCallback:(i,a)=>{this.handleEditorChange(i,a)}}),this.addCommand({id:"toggle-therapist",name:"Toggle therapist on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.saveSettings();let i=this.settings.enabled?"enabled":"disabled";console.log(`Therapist ${i}`)}}),console.log("Therapist plugin loaded")}async handleEditorChange(n,i){if(this.isProcessing)return;let a=this.getEnabledAgents();if(a.length===0){console.error("No agents configured - create one in settings");return}let s=n.getValue(),e=A(s);if(e&&!S(e)){this.isProcessing=!0;try{let o=await this.getAgentResponses(a,e);if(o.length>0){let d=n.getCursor().line;n.setCursor({line:d,ch:n.getLine(d).length});let w=o.filter(m=>m.content.trim()).map(m=>m.content).join(`

`);w&&n.replaceSelection(T(w))}}catch(o){console.error("Error getting therapist response:",o)}finally{this.isProcessing=!1}}}getEnabledAgents(){let{agents:n,multiAgentMode:i,primaryAgentId:a}=this.settings;if(i==="single"){let s=n.find(e=>e.id===a);return s?[s]:n.slice(0,1)}return n.filter(s=>s.enabled).sort((s,e)=>s.order-e.order)}async getAgentResponses(n,i){let{multiAgentMode:a}=this.settings;if(a==="parallel"){let o=n.map(async r=>{try{let d=await this.lettaService.sendMessage(r.id,i);return{agentId:r.id,name:r.name,content:d}}catch(d){return console.error(`Agent ${r.name} failed:`,d),{agentId:r.id,name:r.name,content:""}}});return Promise.all(o)}let s=[],e=i;for(let o of n)try{let r=await this.lettaService.sendMessage(o.id,e);s.push({agentId:o.id,name:o.name,content:r}),r.trim()&&(e+=`

[${o.name}]: ${r}`)}catch(r){console.error(`Agent ${o.name} failed:`,r)}return s}onunload(){console.log("Therapist plugin unloaded")}async loadSettings(){this.settings=Object.assign({},v,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
