var v=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var K=(l,e)=>{for(var s in e)v(l,s,{get:e[s],enumerable:!0})},j=(l,e,s,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of B(e))!R.call(l,a)&&a!==s&&v(l,a,{get:()=>e[a],enumerable:!(n=U(e,a))||n.enumerable});return l};var D=l=>j(v({},"__esModule",{value:!0}),l);var M={};K(M,{default:()=>w});module.exports=D(M);var g=require("obsidian");var o=require("obsidian"),E={lettaUrl:"http://localhost:8283",apiKey:"",openaiApiKey:"",anthropicApiKey:"",agentId:"",enabled:!0,debounceMs:3e3},p=class extends o.PluginSettingTab{constructor(e,s){super(e,s),this.plugin=s}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Therapist"});let s=!!this.plugin.settings.agentId;e.createEl("div",{cls:"setting-item"}).createEl("span",{text:s?"\u2713 Connected":"\u25CB No agent configured",cls:s?"therapist-status-connected":"therapist-status-disconnected"}),new o.Setting(e).setName("Enabled").setDesc("Enable/disable the therapist").addToggle(t=>t.setValue(this.plugin.settings.enabled).onChange(async i=>{this.plugin.settings.enabled=i,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Connection"}),new o.Setting(e).setName("Letta Server URL").setDesc("URL of your Letta server").addText(t=>t.setPlaceholder("http://localhost:8283").setValue(this.plugin.settings.lettaUrl).onChange(async i=>{this.plugin.settings.lettaUrl=i,this.plugin.lettaService.setBaseUrl(i),await this.plugin.saveSettings()})),new o.Setting(e).setName("Letta API Key").setDesc("Optional - only if your server requires it").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-let-...").setValue(this.plugin.settings.apiKey).onChange(async i=>{this.plugin.settings.apiKey=i,this.plugin.lettaService.setApiKey(i),await this.plugin.saveSettings()})}),e.createEl("h3",{text:"LLM Provider"}),e.createEl("p",{text:"Add an API key to use cloud models. Leave blank to use local Ollama.",cls:"setting-item-description"}),new o.Setting(e).setName("OpenAI API Key").setDesc("Uses GPT-4o").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-proj-...").setValue(this.plugin.settings.openaiApiKey).onChange(async i=>{if(this.plugin.settings.openaiApiKey=i,await this.plugin.saveSettings(),i)try{await this.plugin.lettaService.updateProviderKey("openai",i)}catch(d){console.warn("Could not update provider key:",d)}})}),new o.Setting(e).setName("Anthropic API Key").setDesc("Uses Claude Sonnet").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async i=>{if(this.plugin.settings.anthropicApiKey=i,await this.plugin.saveSettings(),i)try{await this.plugin.lettaService.updateProviderKey("anthropic",i)}catch(d){console.warn("Could not update provider key:",d)}})}),e.createEl("h3",{text:"Behavior"}),new o.Setting(e).setName("Response Delay").setDesc("Seconds to wait after you stop typing").addSlider(t=>t.setLimits(1,10,1).setValue(this.plugin.settings.debounceMs/1e3).setDynamicTooltip().onChange(async i=>{this.plugin.settings.debounceMs=i*1e3,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Setup"});let a="letta/letta-free",r=null;new o.Setting(e).setName("Model").setDesc("Click refresh to load available models").addDropdown(t=>{r=t,t.addOption("letta/letta-free","letta/letta-free (default)"),t.setValue(a),t.onChange(i=>{a=i})}).addButton(t=>t.setButtonText("Refresh").onClick(async()=>{try{let i=await this.plugin.lettaService.listModels();r.selectEl.empty(),r.addOption("letta/letta-free","letta/letta-free (default)");for(let d of i)d.handle!=="letta/letta-free"&&r.addOption(d.handle,d.handle);r.setValue(a),new o.Notice(`Found ${i.length} models`)}catch(i){new o.Notice("Failed to fetch models - check server connection")}})),s?new o.Setting(e).setName("Agent").setDesc(`ID: ${this.plugin.settings.agentId}`).addButton(t=>t.setButtonText("Delete Agent").setWarning().onClick(async()=>{this.plugin.settings.agentId="",await this.plugin.saveSettings(),new o.Notice("Agent removed"),this.display()})):new o.Setting(e).setName("Create Therapist").setDesc("Creates your personal coach agent").addButton(t=>t.setButtonText("Create Agent").setCta().onClick(async()=>{try{let i=a,d="letta/letta-free";new o.Notice(`Creating agent with ${i}...`);let c=await this.plugin.lettaService.createAgent("therapist","therapist",i,d);this.plugin.settings.agentId=c,await this.plugin.saveSettings(),new o.Notice("Therapist created! Start journaling."),this.display()}catch(i){console.error("Failed to create agent:",i),new o.Notice(`Failed: ${i instanceof Error?i.message:"Unknown error"}`)}})),s&&(e.createEl("h3",{text:"Vault Context"}),e.createEl("p",{text:"Index your vault to give the therapist context about your notes.",cls:"setting-item-description"}),new o.Setting(e).setName("Index Vault").setDesc("Indexes all markdown files for therapist context").addButton(t=>t.setButtonText("Index Now").onClick(async()=>{if(this.plugin.isIndexing){new o.Notice("Indexing already in progress");return}t.setDisabled(!0),t.setButtonText("Indexing...");try{let i=await this.plugin.vaultIndexer.indexVault(this.plugin.settings.agentId);new o.Notice(`Indexed ${i.files} files (${i.passages} passages)`)}catch(i){console.error("Indexing failed:",i),new o.Notice(`Indexing failed: ${i instanceof Error?i.message:"Unknown error"}`)}finally{t.setDisabled(!1),t.setButtonText("Index Now")}}))),new o.Setting(e).setName("Test Connection").setDesc("Check if Letta server is reachable").addButton(t=>t.setButtonText("Test").onClick(async()=>{try{let i=`${this.plugin.settings.lettaUrl}/v1/health/`;new o.Notice(`Testing ${i}...`);let d=await(0,o.requestUrl)({url:i});d.status===200?new o.Notice("Connected to Letta server!"):new o.Notice(`Server error: ${d.status}`)}catch(i){new o.Notice(`Connection failed: ${i instanceof Error?i.message:"Unknown error"}`)}}))}};var h=require("obsidian"),I={therapist:`You are my personal coach. Read between the lines of what I write.

My journaling may be scattered, venting, or stream-of-consciousness. Your job:
1. Silently figure out what's actually going on beneath the surface
2. Respond to what I need, not what I literally said

RESPONSE PROTOCOL:
- Messages prefixed with "[User is asking for your input]" \u2192 Always respond
- Messages prefixed with "[User is journaling...]" \u2192 Only respond if you have genuine insight
- If you have nothing valuable to add, respond with just: [listening]

WHEN TO RESPOND:
- I'm stuck and need a push \u2192 Give ONE specific thing to try
- I'm avoiding something obvious \u2192 Name it directly
- I'm spiraling \u2192 Ground me with something concrete
- I keep coming back to the same problem \u2192 Offer a real suggestion
- I'm asking you directly \u2192 Answer me

WHEN TO STAY SILENT (respond with [listening]):
- I'm just processing emotions
- I'm venting and don't need fixing
- I'm working through something myself
- You'd just be restating what I said

WHEN YOU DO RESPOND, be specific:
- Times: "Try this tomorrow morning" not "sometime"
- Quantities: "Track 3 days" not "for a while"
- Observable: "Notice if..." not vague outcomes

Be real. Don't be a robot that dispenses advice. Be the friend who knows when to push and when to shut up.

Keep responses short. 1-3 sentences usually. Match my energy.`,analyst:`You observe patterns across journal sessions and give specific improvement suggestions.

When you notice a pattern, respond with:
\u{1F4CA} Pattern: [what you noticed across sessions]
\u{1F3AF} Suggestion: [one specific change to try]

Examples:
- "\u{1F4CA} Pattern: Stress spikes on Mondays, usually mentions Sunday night anxiety. \u{1F3AF} Suggestion: Do a 10-min Monday preview on Sunday at 4pm - just look at your calendar and write 3 things you'll handle first."
- "\u{1F4CA} Pattern: Overspending happens after stressful days. \u{1F3AF} Suggestion: Add a 24-hour rule - when stressed, screenshot items instead of buying. Review tomorrow."
- "\u{1F4CA} Pattern: Energy drops after lunch on workdays. \u{1F3AF} Suggestion: Try a 10-min walk immediately after eating for one week. Track energy at 3pm."

Only speak when you spot something actionable. Quality over quantity.`,custom:"You are a helpful assistant in a journaling session. Be supportive and give practical suggestions when appropriate."},m=class{constructor(e,s=""){this.providerKeys={};this.baseUrl=e,this.apiKey=s}setBaseUrl(e){this.baseUrl=e}setApiKey(e){this.apiKey=e}setProviderKey(e,s){this.providerKeys[e]=s}getHeaders(){let e={"Content-Type":"application/json"};return this.apiKey&&(e.Authorization=`Bearer ${this.apiKey}`),e}async listModels(){let e=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/models/`,headers:this.getHeaders()});if(e.status!==200)throw new Error("Failed to fetch models");return e.json.map(n=>({handle:n.handle,name:n.name,provider:n.provider_name}))}async updateProviderKey(e,s){try{let r=(await(0,h.requestUrl)({url:`${this.baseUrl}/v1/providers/`,headers:this.getHeaders()})).json.find(t=>t.provider_type===e);r?await(0,h.requestUrl)({url:`${this.baseUrl}/v1/providers/${r.id}/`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({api_key:s})}):await(0,h.requestUrl)({url:`${this.baseUrl}/v1/providers/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,provider_type:e,api_key:s})})}catch(n){console.warn("Failed to update provider key:",n)}}async createAgent(e,s,n="ollama/llama3.2",a="ollama/nomic-embed-text",r){let t=r||I[s]||I.custom,i=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/agents/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,model:n,embedding:a,enable_sleeptime:!0,memory_blocks:[{label:"persona",value:t},{label:"human",value:"[Learning about you through our sessions...]"}]})});if(i.status!==200)throw new Error(`Failed to create agent: ${i.text}`);return i.json.id}async sendMessage(e,s){let n=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/agents/${e}/messages/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({messages:[{role:"user",content:s}]})});if(n.status!==200)throw new Error(`Failed to send message: ${n.text}`);let a=n.json;for(let t of a.messages)if(t.message_type==="assistant_message")return t.content;let r=a.messages[a.messages.length-1];return(r==null?void 0:r.content)||""}async healthCheck(){try{return(await(0,h.requestUrl)({url:`${this.baseUrl}/v1/health/`})).status===200}catch(e){return!1}}async createArchive(e,s="letta/letta-free"){let n=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/archives/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,description:"Obsidian vault content for therapist context",embedding:s})});if(n.status!==200)throw new Error(`Failed to create archive: ${n.text}`);return n.json.id}async listArchives(){let e=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/archives/`,headers:this.getHeaders()});if(e.status!==200)throw new Error("Failed to list archives");return e.json.map(s=>({id:s.id,name:s.name}))}async addPassage(e,s,n={}){let a=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/archives/${e}/passages/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({text:s,metadata:n})});if(a.status!==200)throw new Error(`Failed to add passage: ${a.text}`)}async attachArchive(e,s){let n=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/agents/${e}/archives/attach/${s}/`,method:"POST",headers:this.getHeaders()});if(n.status!==200)throw new Error(`Failed to attach archive: ${n.text}`)}async clearArchive(e){let s=await(0,h.requestUrl)({url:`${this.baseUrl}/v1/archives/${e}/passages/`,headers:this.getHeaders()});if(s.status!==200)return;let n=s.json;for(let a of n)try{await(0,h.requestUrl)({url:`${this.baseUrl}/v1/archives/${e}/passages/${a.id}/`,method:"DELETE",headers:this.getHeaders()})}catch(r){}}};var f=require("obsidian"),T="obsidian-vault",k=1e3,A=100,y=class{constructor(e,s){this.archiveId=null;this.app=e,this.lettaService=s}async getOrCreateArchive(){if(this.archiveId)return this.archiveId;let s=(await this.lettaService.listArchives()).find(n=>n.name===T);return s?(this.archiveId=s.id,s.id):(this.archiveId=await this.lettaService.createArchive(T),this.archiveId)}chunkText(e,s){let n=[];if(e.length<=k)return n.push({text:`[${s}]

${e}`,metadata:{file:s,chunk:"0"}}),n;let a=0,r=0;for(;a<e.length;){let t=Math.min(a+k,e.length),i=e.substring(a,t);if(n.push({text:`[${s} - Part ${r+1}]

${i}`,metadata:{file:s,chunk:String(r)}}),a=t-A,a>=e.length-A)break;r++}return n}async indexFile(e,s){let n=await this.app.vault.cachedRead(e);if(n.length<50)return 0;let a=this.chunkText(n,e.path);for(let r of a)await this.lettaService.addPassage(s,r.text,r.metadata);return a.length}async indexVault(e,s){let n=await this.getOrCreateArchive();new f.Notice("Clearing old index..."),await this.lettaService.clearArchive(n);let a=this.app.vault.getMarkdownFiles(),r=0;new f.Notice(`Indexing ${a.length} files...`);for(let t=0;t<a.length;t++){let i=a[t];s&&s(t+1,a.length,i.path);try{let d=await this.indexFile(i,n);r+=d}catch(d){console.warn(`Failed to index ${i.path}:`,d)}}try{await this.lettaService.attachArchive(e,n)}catch(t){console.warn("Archive attachment:",t)}return new f.Notice(`Indexed ${a.length} files (${r} passages)`),{files:a.length,passages:r}}async indexChanged(e,s){let n=await this.getOrCreateArchive(),a=this.app.vault.getMarkdownFiles().filter(t=>t.stat.mtime>s),r=0;for(let t of a)try{let i=await this.indexFile(t,n);r+=i}catch(i){console.warn(`Failed to index ${t.path}:`,i)}return{files:a.length,passages:r}}};var b="> **Therapist:**",L=["# Journal","## Journal","### Journal"];function P(l){let e=l.lastIndexOf(b);if(e===-1)return l.trim();let n=l.substring(e).split(`
`),a=-1,r=!0;for(let t=0;t<n.length;t++){let d=n[t].trim();if(r){if(d===""||d.startsWith(">"))continue;a=t;break}}return a===-1?"":n.slice(a).join(`
`).trim()}function C(l){return l.trim().startsWith(b)}function $(l){return`

${l.split(`
`).map((n,a)=>a===0?`${b} ${n}`:n.trim()===""?">":`> ${n}`).join(`
`)}

`}function O(l){let e=-1,s=0;for(let t of L){let i=l.indexOf(t);i!==-1&&(e===-1||i<e)&&(e=i,s=t.split(" ")[0].length)}if(e===-1)return null;let a=l.substring(e).split(`
`),r=a.length;for(let t=1;t<a.length;t++){let d=a[t].match(/^(#{1,6})\s/);if(d&&d[1].length<=s){r=t;break}}return a.slice(1,r).join(`
`).trim()}function N(l){let e=l.toLowerCase();return l.includes("?")?!0:["you know","right?","what do you think","any thoughts","help me","i need","should i","could i","what should","what would","advice","suggest","opinion","perspective","thoughts?","ideas?"].some(n=>e.includes(n))}var w=class extends g.Plugin{constructor(){super(...arguments);this.isProcessing=!1;this.isIndexing=!1;this.statusBarEl=null}async onload(){await this.loadSettings(),this.lettaService=new m(this.settings.lettaUrl,this.settings.apiKey),this.vaultIndexer=new y(this.app,this.lettaService),this.addSettingTab(new p(this.app,this));let s=(0,g.debounce)((n,a)=>this.handleEditorChange(n,a),this.settings.debounceMs,!0);this.registerEvent(this.app.workspace.on("editor-change",(n,a)=>{this.settings.enabled&&this.settings.agentId&&s(n,a)})),this.addCommand({id:"trigger-therapist",name:"Ask therapist to respond",editorCallback:(n,a)=>{this.handleEditorChange(n,a,!0)}}),this.addCommand({id:"toggle-therapist",name:"Toggle therapist on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.saveSettings(),this.updateStatusBar();let n=this.settings.enabled?"enabled":"disabled";new g.Notice(`Therapist ${n}`)}}),this.addCommand({id:"index-vault",name:"Index vault for therapist context",callback:async()=>{if(!this.settings.agentId){new g.Notice("Create an agent first in settings");return}if(this.isIndexing){new g.Notice("Indexing already in progress");return}this.isIndexing=!0;try{let n=await this.vaultIndexer.indexVault(this.settings.agentId);new g.Notice(`Indexed ${n.files} files (${n.passages} passages)`)}catch(n){console.error("Indexing failed:",n),new g.Notice(`Indexing failed: ${n instanceof Error?n.message:"Unknown error"}`)}finally{this.isIndexing=!1}}}),this.statusBarEl=this.addStatusBarItem(),this.updateStatusBar(),console.log("Therapist plugin loaded")}updateStatusBar(s){if(this.statusBarEl){if(!this.settings.enabled){this.statusBarEl.setText("\u25CB Therapist off"),this.statusBarEl.setAttribute("aria-label","Therapist is disabled");return}if(!this.settings.agentId){this.statusBarEl.setText("\u25CB No agent"),this.statusBarEl.setAttribute("aria-label","No therapist agent configured");return}switch(s){case"thinking":this.statusBarEl.setText("\u25C9 Thinking..."),this.statusBarEl.setAttribute("aria-label","Therapist is processing");break;case"no-journal":this.statusBarEl.setText("\u25E6 No journal section"),this.statusBarEl.setAttribute("aria-label","Add a ## Journal header to enable");break;case"off":this.statusBarEl.setText("\u25CB Therapist off"),this.statusBarEl.setAttribute("aria-label","Therapist is disabled");break;default:this.statusBarEl.setText("\u25CF Listening"),this.statusBarEl.setAttribute("aria-label","Therapist is monitoring")}}}async handleEditorChange(s,n,a=!1){if(this.isProcessing)return;if(!this.settings.agentId){console.error("No agent configured - create one in settings");return}let r=s.getValue(),t=O(r);if(!t){this.updateStatusBar("no-journal");return}this.updateStatusBar("listening");let i=P(t);if(!i||C(i))return;let d=N(i);this.isProcessing=!0,this.updateStatusBar("thinking");try{let c=d||a?`[User is asking for your input]

`:`[User is journaling - respond only if you have something valuable to add]

`,u=await this.lettaService.sendMessage(this.settings.agentId,c+i),x=(u==null?void 0:u.trim())||"";if(x&&x!=="[listening]"){let S=s.getCursor().line;s.setCursor({line:S,ch:s.getLine(S).length}),s.replaceSelection($(u))}}catch(c){console.error("Error getting therapist response:",c)}finally{this.isProcessing=!1,this.updateStatusBar("listening")}}onunload(){console.log("Therapist plugin unloaded")}async loadSettings(){this.settings=Object.assign({},E,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
