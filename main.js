var S=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var $=(h,i)=>{for(var e in i)S(h,e,{get:i[e],enumerable:!0})},D=(h,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of B(i))!N.call(h,s)&&s!==e&&S(h,s,{get:()=>i[s],enumerable:!(t=A(i,s))||t.enumerable});return h};var F=h=>D(S({},"__esModule",{value:!0}),h);var O={};$(O,{default:()=>x});module.exports=F(O);var c=require("obsidian"),P=require("obsidian");var l=require("obsidian"),T={lettaUrl:"http://localhost:8283",apiKey:"",openaiApiKey:"",anthropicApiKey:"",agentId:"",agentName:"",agentModel:"",therapistName:"Therapist",enabled:!0,debounceMs:3e3,indexVault:!1,includedFolders:[],excludedFolders:[],archiveId:"",lastIndexed:0},y=class extends l.FuzzySuggestModal{constructor(i,e){super(i),this.onChoose=e}getItems(){let i=[],e=this.app.vault.getRoot(),t=s=>{i.push(s);for(let n of s.children)n instanceof l.TFolder&&t(n)};return t(e),i}getItemText(i){return i.path||"/"}onChooseItem(i){this.onChoose(i)}},f=class extends l.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}async display(){let{containerEl:i}=this;i.empty();let e=!!this.plugin.settings.agentId;if(e&&!this.plugin.settings.agentName){let t=await this.plugin.lettaService.getAgent(this.plugin.settings.agentId);t&&(this.plugin.settings.agentName=t.name,this.plugin.settings.agentModel=t.model,await this.plugin.saveSettings())}if(e){i.createEl("h2",{text:"Your Therapist"}),new l.Setting(i).setName("Name").setDesc("What should your therapist call themselves?").addText(r=>r.setPlaceholder("Therapist").setValue(this.plugin.settings.therapistName).onChange(async o=>{this.plugin.settings.therapistName=o||"Therapist",await this.plugin.saveSettings()})),new l.Setting(i).setName("Model").descEl.createSpan({text:this.plugin.settings.agentModel||"unknown",cls:"therapist-model-badge"}),new l.Setting(i).setName("Active").setDesc("Turn the therapist on or off").addToggle(r=>r.setValue(this.plugin.settings.enabled).onChange(async o=>{this.plugin.settings.enabled=o,await this.plugin.saveSettings(),this.plugin.updateStatusBar()})),new l.Setting(i).setName("Memory").setDesc("View what your therapist remembers about you").addButton(r=>r.setButtonText("View Memory").onClick(()=>{this.plugin.openMemoryViewer()}));let a=new l.Setting(i).setName("Agent ID").addButton(r=>r.setButtonText("Copy").onClick(()=>{navigator.clipboard.writeText(this.plugin.settings.agentId),new l.Notice("Agent ID copied")})).addButton(r=>r.setButtonText("Delete").setWarning().onClick(async()=>{try{await this.plugin.lettaService.deleteAgent(this.plugin.settings.agentId),new l.Notice("Agent deleted")}catch(o){console.warn("Could not delete from server:",o)}this.plugin.settings.agentId="",this.plugin.settings.agentName="",this.plugin.settings.agentModel="",this.plugin.settings.therapistName="Therapist",await this.plugin.saveSettings(),this.display()})).descEl.createEl("code",{text:this.plugin.settings.agentId});a.style.fontSize="0.75em",a.style.userSelect="all"}if(!e){i.createEl("h2",{text:"Create Therapist"});let t="letta/letta-free",s=null;new l.Setting(i).setName("Model").setDesc("Select which AI model to use").addDropdown(n=>{s=n,n.addOption("letta/letta-free","letta/letta-free (free)"),n.setValue(t),n.onChange(a=>{t=a})}).addButton(n=>n.setButtonText("Refresh Models").onClick(async()=>{try{let a=await this.plugin.lettaService.listModels();s.selectEl.empty(),s.addOption("letta/letta-free","letta/letta-free (free)");for(let r of a)r.handle!=="letta/letta-free"&&s.addOption(r.handle,r.handle);s.setValue(t),new l.Notice(`Found ${a.length} models`)}catch(a){new l.Notice("Failed to fetch models")}})),new l.Setting(i).setName("").addButton(n=>n.setButtonText("Create Therapist").setCta().onClick(async()=>{try{new l.Notice(`Creating agent with ${t}...`);let a=await this.plugin.lettaService.createAgent("therapist","therapist",t,"letta/letta-free");this.plugin.settings.agentId=a,this.plugin.settings.agentModel=t,this.plugin.settings.agentName="therapist",await this.plugin.saveSettings(),new l.Notice("Therapist created! Start journaling."),this.display()}catch(a){console.error("Failed to create agent:",a),new l.Notice(`Failed: ${a instanceof Error?a.message:"Unknown error"}`)}}))}if(i.createEl("h3",{text:"Behavior"}),new l.Setting(i).setName("Observer delay").setDesc("Seconds to wait after you stop typing before the therapist reads your writing").addSlider(t=>t.setLimits(1,10,1).setValue(this.plugin.settings.debounceMs/1e3).setDynamicTooltip().onChange(async s=>{this.plugin.settings.debounceMs=s*1e3,await this.plugin.saveSettings()})),e&&(i.createEl("h3",{text:"Vault Memory"}),i.createEl("p",{text:"Index your vault so your therapist can reference your notes during sessions.",cls:"setting-item-description"}),new l.Setting(i).setName("Enable vault indexing").setDesc("Automatically index notes for the therapist to reference").addToggle(t=>t.setValue(this.plugin.settings.indexVault).onChange(async s=>{this.plugin.settings.indexVault=s,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.indexVault)){let t=new l.Setting(i).setName("Included folders").setDesc("Only index notes in these folders. Leave empty to include all.").addButton(r=>r.setButtonText("Add folder").onClick(()=>{new y(this.app,async o=>{let d=o.path||"/";this.plugin.settings.includedFolders.includes(d)||(this.plugin.settings.includedFolders.push(d),await this.plugin.saveSettings(),this.display())}).open()}));if(this.plugin.settings.includedFolders.length>0){let r=t.settingEl.createDiv({cls:"therapist-folder-list"});for(let o of this.plugin.settings.includedFolders){let d=r.createDiv({cls:"therapist-folder-item"});d.createSpan({text:o||"/",cls:"therapist-folder-path"}),d.createEl("button",{text:"\xD7",cls:"therapist-folder-remove"}).addEventListener("click",async()=>{this.plugin.settings.includedFolders=this.plugin.settings.includedFolders.filter(m=>m!==o),await this.plugin.saveSettings(),this.display()})}}let s=new l.Setting(i).setName("Excluded folders").setDesc("Never index notes in these folders").addButton(r=>r.setButtonText("Add folder").onClick(()=>{new y(this.app,async o=>{let d=o.path||"/";this.plugin.settings.excludedFolders.includes(d)||(this.plugin.settings.excludedFolders.push(d),await this.plugin.saveSettings(),this.display())}).open()}));if(this.plugin.settings.excludedFolders.length>0){let r=s.settingEl.createDiv({cls:"therapist-folder-list"});for(let o of this.plugin.settings.excludedFolders){let d=r.createDiv({cls:"therapist-folder-item"});d.createSpan({text:o||"/",cls:"therapist-folder-path"}),d.createEl("button",{text:"\xD7",cls:"therapist-folder-remove"}).addEventListener("click",async()=>{this.plugin.settings.excludedFolders=this.plugin.settings.excludedFolders.filter(m=>m!==o),await this.plugin.saveSettings(),this.display()})}}let n=this.plugin.settings.lastIndexed,a=n>0?`Last indexed: ${new Date(n).toLocaleString()}`:"Not yet indexed";new l.Setting(i).setName("Index status").setDesc(a).addButton(r=>r.setButtonText("Reindex Now").onClick(async()=>{r.setButtonText("Indexing..."),r.setDisabled(!0);try{await this.plugin.indexVault(),new l.Notice("Vault indexed successfully"),this.display()}catch(o){console.error("Indexing failed:",o),new l.Notice(`Indexing failed: ${o instanceof Error?o.message:"Unknown error"}`),r.setButtonText("Reindex Now"),r.setDisabled(!1)}})).addButton(r=>r.setButtonText("View Memory").onClick(()=>{this.plugin.openMemoryViewer()}))}i.createEl("h3",{text:"Server"}),new l.Setting(i).setName("Letta URL").setDesc("Your Letta server address").addText(t=>t.setPlaceholder("http://localhost:8283").setValue(this.plugin.settings.lettaUrl).onChange(async s=>{this.plugin.settings.lettaUrl=s,this.plugin.lettaService.setBaseUrl(s),await this.plugin.saveSettings()})).addButton(t=>t.setButtonText("Test").onClick(async()=>{try{let s=`${this.plugin.settings.lettaUrl}/v1/health/`,n=await(0,l.requestUrl)({url:s});n.status===200?new l.Notice("Connected!"):new l.Notice(`Error: ${n.status}`)}catch(s){new l.Notice("Connection failed")}})),new l.Setting(i).setName("Letta API Key").setDesc("Only needed if your server requires authentication").addText(t=>t.setPlaceholder("sk-let-...").setValue(this.plugin.settings.apiKey).onChange(async s=>{this.plugin.settings.apiKey=s,this.plugin.lettaService.setApiKey(s),await this.plugin.saveSettings()})),i.createEl("h3",{text:"LLM API Keys"}),i.createEl("p",{text:"Required for cloud models. Leave blank if using letta-free or local Ollama.",cls:"setting-item-description"}),new l.Setting(i).setName("Anthropic").setDesc("For Claude models").addText(t=>t.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async s=>{if(this.plugin.settings.anthropicApiKey=s,await this.plugin.saveSettings(),s)try{await this.plugin.lettaService.updateProviderKey("anthropic",s)}catch(n){console.warn("Could not update provider key:",n)}})),new l.Setting(i).setName("OpenAI").setDesc("For GPT models").addText(t=>t.setPlaceholder("sk-proj-...").setValue(this.plugin.settings.openaiApiKey).onChange(async s=>{if(this.plugin.settings.openaiApiKey=s,await this.plugin.saveSettings(),s)try{await this.plugin.lettaService.updateProviderKey("openai",s)}catch(n){console.warn("Could not update provider key:",n)}}))}};var g=require("obsidian"),I={therapist:`You are my personal coach. Read between the lines of what I write.

My journaling may be scattered, venting, or stream-of-consciousness. Your job:
1. Silently figure out what's actually going on beneath the surface
2. Respond to what I need, not what I literally said

RESPONSE PROTOCOL:
- Messages prefixed with "[User is asking for your input]" \u2192 Always respond
- Messages prefixed with "[User is journaling...]" \u2192 Only respond if you have genuine insight
- If you have nothing valuable to add, respond with just: [listening]

WHEN TO RESPOND:
- I'm stuck and need a push \u2192 Give ONE specific thing to try
- I'm avoiding something obvious \u2192 Name it directly
- I'm spiraling \u2192 Ground me with something concrete
- I keep coming back to the same problem \u2192 Offer a real suggestion
- I'm asking you directly \u2192 Answer me

WHEN TO STAY SILENT (respond with [listening]):
- I'm just processing emotions
- I'm venting and don't need fixing
- I'm working through something myself
- You'd just be restating what I said

WHEN YOU DO RESPOND, be specific:
- Times: "Try this tomorrow morning" not "sometime"
- Quantities: "Track 3 days" not "for a while"
- Observable: "Notice if..." not vague outcomes

Be real. Don't be a robot that dispenses advice. Be the friend who knows when to push and when to shut up.

Keep responses short. 1-3 sentences usually. Match my energy.`,analyst:`You observe patterns across journal sessions and give specific improvement suggestions.

When you notice a pattern, respond with:
\u{1F4CA} Pattern: [what you noticed across sessions]
\u{1F3AF} Suggestion: [one specific change to try]

Examples:
- "\u{1F4CA} Pattern: Stress spikes on Mondays, usually mentions Sunday night anxiety. \u{1F3AF} Suggestion: Do a 10-min Monday preview on Sunday at 4pm - just look at your calendar and write 3 things you'll handle first."
- "\u{1F4CA} Pattern: Overspending happens after stressful days. \u{1F3AF} Suggestion: Add a 24-hour rule - when stressed, screenshot items instead of buying. Review tomorrow."
- "\u{1F4CA} Pattern: Energy drops after lunch on workdays. \u{1F3AF} Suggestion: Try a 10-min walk immediately after eating for one week. Track energy at 3pm."

Only speak when you spot something actionable. Quality over quantity.`,custom:"You are a helpful assistant in a journaling session. Be supportive and give practical suggestions when appropriate."},w=class{constructor(i,e=""){this.providerKeys={};this.baseUrl=i,this.apiKey=e}setBaseUrl(i){this.baseUrl=i}setApiKey(i){this.apiKey=i}setProviderKey(i,e){this.providerKeys[i]=e}getHeaders(){let i={"Content-Type":"application/json"};return this.apiKey&&(i.Authorization=`Bearer ${this.apiKey}`),i}async listModels(){let i=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/models`,headers:this.getHeaders()});if(i.status!==200)throw new Error("Failed to fetch models");return i.json.map(t=>({handle:t.handle,name:t.name,provider:t.provider_name}))}async updateProviderKey(i,e){try{let n=(await(0,g.requestUrl)({url:`${this.baseUrl}/v1/providers/`,headers:this.getHeaders()})).json.find(a=>a.provider_type===i);if(n)await(0,g.requestUrl)({url:`${this.baseUrl}/v1/providers/${n.id}`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({api_key:e})}),console.log(`Updated ${i} provider`);else try{await(0,g.requestUrl)({url:`${this.baseUrl}/v1/providers/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:i,provider_type:i,api_key:e})}),console.log(`Created ${i} provider`)}catch(a){console.warn(`Provider ${i} may already exist (409), trying alternate approach`);let o=(await(0,g.requestUrl)({url:`${this.baseUrl}/v1/providers/`,headers:this.getHeaders()})).json.find(d=>d.provider_type===i||d.name===i);o?(await(0,g.requestUrl)({url:`${this.baseUrl}/v1/providers/${o.id}`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({api_key:e})}),console.log(`Updated ${i} provider on retry`)):console.error(`Provider ${i} exists in database but not retrievable. May need to reset Letta.`)}}catch(t){console.warn("Failed to update provider key:",t)}}async createAgent(i,e,t="ollama/llama3.2",s="ollama/nomic-embed-text",n){let a=n||I[e]||I.custom,r=t.includes("/")?t.split("/")[0]:null,o={name:i,model:t,embedding:s,enable_sleeptime:!0,memory_blocks:[{label:"persona",value:a},{label:"human",value:"[Learning about you through our sessions...]"}]};if(r&&r!=="letta"&&r!=="ollama"){let p=t.includes("/")?t.split("/").slice(1).join("/"):t;o.llm_config={model:p,model_endpoint_type:r,provider_name:r,context_window:2e5}}let d=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify(o)});if(d.status!==200)throw new Error(`Failed to create agent: ${d.text}`);return d.json.id}async sendMessage(i,e){let t=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${i}/messages`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({messages:[{role:"user",content:e}]})});if(t.status!==200)throw new Error(`Failed to send message: ${t.text}`);let s=t.json;for(let a of s.messages)if(a.message_type==="assistant_message")return a.content;let n=s.messages[s.messages.length-1];return(n==null?void 0:n.content)||""}async getAgent(i){var e;try{let t=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${i}`,headers:this.getHeaders()});if(t.status!==200)return null;let s=t.json;return{id:s.id,name:s.name,model:s.model||((e=s.llm_config)==null?void 0:e.model)||"unknown"}}catch(t){return null}}async deleteAgent(i){let e=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${i}`,method:"DELETE",headers:this.getHeaders()});if(e.status!==200&&e.status!==204)throw new Error(`Failed to delete agent: ${e.text}`)}async healthCheck(){try{return(await(0,g.requestUrl)({url:`${this.baseUrl}/v1/health`})).status===200}catch(i){return!1}}async createArchive(i,e="letta/letta-free"){let t=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/archives/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:i,description:"Obsidian vault content for therapist context",embedding:e})});if(t.status!==200)throw new Error(`Failed to create archive: ${t.text}`);return t.json.id}async listArchives(){let i=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/archives/`,headers:this.getHeaders()});if(i.status!==200)throw new Error("Failed to list archives");return i.json.map(e=>({id:e.id,name:e.name}))}async addPassage(i,e,t={}){let s=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/archives/${i}/passages/`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({text:e,metadata:t})});if(s.status!==200)throw new Error(`Failed to add passage: ${s.text}`)}async attachArchive(i,e){let t=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${i}/archives/attach/${e}/`,method:"POST",headers:this.getHeaders()});if(t.status!==200)throw new Error(`Failed to attach archive: ${t.text}`)}async clearArchive(i){let e=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/archives/${i}/passages/`,headers:this.getHeaders()});if(e.status!==200)return;let t=e.json;for(let s of t)try{await(0,g.requestUrl)({url:`${this.baseUrl}/v1/archives/${i}/passages/${s.id}/`,method:"DELETE",headers:this.getHeaders()})}catch(n){}}async getMemoryBlocks(i){let e=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${i}/core-memory/blocks`,headers:this.getHeaders()});if(e.status!==200)throw new Error("Failed to get memory blocks");return e.json.map(t=>({id:t.id,label:t.label,value:t.value}))}async updateMemoryBlock(i,e,t){if((await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${i}/core-memory/blocks/${e}`,method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({value:t})})).status!==200)throw new Error("Failed to update memory block")}async getArchivalMemory(i,e=100){let t=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${i}/archival-memory?limit=${e}`,headers:this.getHeaders()});if(t.status!==200)throw new Error("Failed to get archival memory");return t.json.map(s=>({id:s.id,text:s.text,created_at:s.created_at}))}async deleteArchivalMemory(i,e){let t=await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${i}/archival-memory/${e}`,method:"DELETE",headers:this.getHeaders()});if(t.status!==200&&t.status!==204)throw new Error("Failed to delete archival memory")}async addArchivalMemory(i,e){if((await(0,g.requestUrl)({url:`${this.baseUrl}/v1/agents/${i}/archival-memory`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({text:e})})).status!==200)throw new Error("Failed to add archival memory")}};function L(h="Therapist"){return`> **${h}:**`}function k(h){let i=/^>\s*\*\*[^*]+:\*\*/gm,e=-1,t;for(;(t=i.exec(h))!==null;)e=t.index;if(e===-1)return h.trim();let n=h.substring(e).split(`
`),a=-1,r=!0;for(let o=0;o<n.length;o++){let p=n[o].trim();if(r){if(p===""||p.startsWith(">"))continue;a=o;break}}return a===-1?"":n.slice(a).join(`
`).trim()}function M(h){let i=h.trim();return/^>\s*\*\*[^*]+:\*\*/.test(i)}function C(h,i="Therapist"){let e=L(i);return`

${h.split(`
`).map((n,a)=>a===0?`${e} ${n}`:n.trim()===""?">":`> ${n}`).join(`
`)}

`}var u=require("obsidian"),b=class extends u.Modal{constructor(e,t,s){super(e);this.activeTab="blocks";this.memoryBlocks=[];this.archivalMemories=[];this.isLoading=!0;this.lettaService=t,this.agentId=s}async onOpen(){let{contentEl:e}=this;e.addClass("therapist-memory-modal"),e.empty(),e.createEl("h2",{text:"Therapist Memory"});let t=e.createDiv({cls:"therapist-memory-tabs"}),s=t.createEl("button",{text:"Core Memory",cls:"therapist-memory-tab is-active"}),n=t.createEl("button",{text:"Archival Memory",cls:"therapist-memory-tab"});s.addEventListener("click",()=>{this.activeTab="blocks",s.addClass("is-active"),n.removeClass("is-active"),this.renderContent()}),n.addEventListener("click",()=>{this.activeTab="archival",n.addClass("is-active"),s.removeClass("is-active"),this.renderContent()}),e.createDiv({cls:"therapist-memory-content"}),await this.loadData(),this.renderContent()}async loadData(){this.isLoading=!0;try{let[e,t]=await Promise.all([this.lettaService.getMemoryBlocks(this.agentId),this.lettaService.getArchivalMemory(this.agentId,100)]);this.memoryBlocks=e,this.archivalMemories=t}catch(e){console.error("Failed to load memory:",e),new u.Notice("Failed to load memory")}this.isLoading=!1}renderContent(){let e=this.contentEl.querySelector(".therapist-memory-content");if(e){if(e.empty(),this.isLoading){e.createDiv({text:"Loading...",cls:"therapist-memory-empty"});return}this.activeTab==="blocks"?this.renderMemoryBlocks(e):this.renderArchivalMemory(e)}}renderMemoryBlocks(e){let t=e.createDiv({cls:"therapist-memory-section"});if(t.createEl("h3",{text:"Core Memory Blocks"}),t.createEl("p",{text:"These are the core memories your therapist maintains about you and their persona.",cls:"setting-item-description"}),this.memoryBlocks.length===0){t.createDiv({text:"No memory blocks found",cls:"therapist-memory-empty"});return}for(let s of this.memoryBlocks){let n=t.createDiv({cls:"therapist-memory-block"}),a=n.createDiv({cls:"therapist-memory-block-header"});a.createSpan({text:s.label,cls:"therapist-memory-block-label"}),a.createEl("button",{text:"Edit",cls:"therapist-memory-btn"}).addEventListener("click",()=>this.editMemoryBlock(s)),n.createDiv({cls:"therapist-memory-block-content"}).setText(s.value)}}renderArchivalMemory(e){let t=e.createDiv({cls:"therapist-memory-section"}),s=t.createDiv({cls:"therapist-memory-header"});if(s.createEl("h3",{text:"Archival Memories"}),s.createEl("button",{text:"+ Add Memory",cls:"therapist-memory-add"}).addEventListener("click",()=>this.addArchivalMemory()),t.createEl("p",{text:"Long-term memories your therapist has stored. These are facts and observations the agent has explicitly chosen to remember.",cls:"setting-item-description"}),this.archivalMemories.length===0){t.createDiv({text:"No archival memories yet. Your therapist will build memories as you interact.",cls:"therapist-memory-empty"});return}let a=[...this.archivalMemories].sort((r,o)=>new Date(o.created_at).getTime()-new Date(r.created_at).getTime());for(let r of a){let o=t.createDiv({cls:"therapist-memory-item"}),d=o.createDiv({cls:"therapist-memory-item-content"});d.createDiv({text:r.text});let p=new Date(r.created_at);d.createDiv({text:p.toLocaleDateString()+" "+p.toLocaleTimeString(),cls:"therapist-memory-item-date"});let m=o.createDiv({cls:"therapist-memory-item-actions"});m.createEl("button",{text:"Edit",cls:"therapist-memory-btn"}).addEventListener("click",()=>this.editArchivalMemory(r)),m.createEl("button",{text:"Delete",cls:"therapist-memory-delete"}).addEventListener("click",async()=>{try{await this.lettaService.deleteArchivalMemory(this.agentId,r.id),this.archivalMemories=this.archivalMemories.filter(E=>E.id!==r.id),this.renderContent(),new u.Notice("Memory deleted")}catch(E){console.error("Failed to delete memory:",E),new u.Notice("Failed to delete memory")}})}}async editMemoryBlock(e){new v(this.app,e.value,async s=>{try{await this.lettaService.updateMemoryBlock(this.agentId,e.label,s),e.value=s,this.renderContent(),new u.Notice("Memory updated")}catch(n){console.error("Failed to update memory:",n),new u.Notice("Failed to update memory")}}).open()}async addArchivalMemory(){new v(this.app,"",async t=>{if(t.trim())try{await this.lettaService.addArchivalMemory(this.agentId,t),await this.loadData(),this.renderContent(),new u.Notice("Memory added")}catch(s){console.error("Failed to add memory:",s),new u.Notice("Failed to add memory")}},"Add Memory").open()}async editArchivalMemory(e){new v(this.app,e.text,async s=>{if(s.trim()&&s!==e.text)try{await this.lettaService.deleteArchivalMemory(this.agentId,e.id),await this.lettaService.addArchivalMemory(this.agentId,s),await this.loadData(),this.renderContent(),new u.Notice("Memory updated")}catch(n){console.error("Failed to update memory:",n),new u.Notice("Failed to update memory")}},"Edit Memory").open()}onClose(){let{contentEl:e}=this;e.empty()}},v=class extends u.Modal{constructor(i,e,t,s="Edit Memory"){super(i),this.value=e,this.onSave=t,this.title=s}onOpen(){let{contentEl:i}=this;i.createEl("h2",{text:this.title});let e=i.createEl("textarea",{cls:"therapist-memory-edit-textarea"});e.value=this.value,e.style.width="100%",e.style.height="300px",e.style.resize="vertical",e.style.fontFamily="var(--font-monospace)",e.style.fontSize="13px",e.style.padding="12px",e.style.marginBottom="16px";let t=i.createDiv({cls:"therapist-memory-edit-buttons"});t.style.display="flex",t.style.gap="8px",t.style.justifyContent="flex-end",t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let n=t.createEl("button",{text:"Save",cls:"mod-cta"});n.addEventListener("click",async()=>{n.setAttr("disabled","true"),n.setText("Saving..."),await this.onSave(e.value),this.close()})}onClose(){let{contentEl:i}=this;i.empty()}};var x=class extends c.Plugin{constructor(){super(...arguments);this.isProcessing=!1;this.statusBarEl=null;this.pendingInsight=null;this.indicatorEl=null;this.popoverEl=null;this.popoverVisible=!1}async onload(){await this.loadSettings(),this.lettaService=new w(this.settings.lettaUrl,this.settings.apiKey),this.addSettingTab(new f(this.app,this));let e=(0,c.debounce)((t,s)=>this.observeContent(t,s),this.settings.debounceMs,!0);this.registerEvent(this.app.workspace.on("editor-change",(t,s)=>{this.settings.enabled&&this.settings.agentId&&e(t,s)})),this.addCommand({id:"trigger-therapist",name:"Talk to therapist (inline response)",editorCallback:async(t,s)=>{await this.triggerConversation(t,s)}}),this.addCommand({id:"copy-insight",name:"Copy insight to daily note",callback:()=>{this.pendingInsight?this.copyToDailyNote():new c.Notice("No insight available")}}),this.addCommand({id:"toggle-therapist",name:"Toggle therapist on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.settings.enabled?this.checkCurrentNote():(this.pendingInsight=null,this.hideIndicator()),this.saveSettings(),this.updateStatusBar(),new c.Notice(`Therapist ${this.settings.enabled?"enabled":"disabled"}`)}}),this.addCommand({id:"view-memory",name:"View therapist memory",callback:()=>{this.openMemoryViewer()}}),this.addCommand({id:"reindex-vault",name:"Reindex vault for therapist",callback:async()=>{if(!this.settings.agentId){new c.Notice("No therapist agent configured");return}if(!this.settings.indexVault){new c.Notice("Vault indexing is not enabled");return}new c.Notice("Starting vault indexing...");try{await this.indexVault(),new c.Notice("Vault indexed successfully")}catch(t){console.error("Indexing failed:",t),new c.Notice(`Indexing failed: ${t instanceof Error?t.message:"Unknown error"}`)}}}),this.statusBarEl=this.addStatusBarItem(),this.updateStatusBar(),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.checkCurrentNote()})),this.registerEvent(this.app.workspace.on("file-open",()=>{this.checkCurrentNote()})),this.registerDomEvent(document,"click",t=>{this.popoverVisible&&this.indicatorEl&&(this.indicatorEl.contains(t.target)||this.hidePopover())}),this.checkCurrentNote(),console.log("Therapist plugin loaded")}checkCurrentNote(){if(this.pendingInsight=null,this.hidePopover(),!this.settings.enabled||!this.settings.agentId){this.hideIndicator(),this.updateStatusBar();return}if(!this.app.workspace.getActiveViewOfType(c.MarkdownView)){this.hideIndicator(),this.updateStatusBar("off");return}this.showIndicator("observing"),this.updateStatusBar("listening")}updateStatusBar(e){if(this.statusBarEl){if(!this.settings.enabled){this.statusBarEl.setText("\u25CB Therapist off");return}if(!this.settings.agentId){this.statusBarEl.setText("\u25CB No agent");return}switch(e){case"thinking":this.statusBarEl.setText("\u25C9 Observing...");break;case"insight":this.statusBarEl.setText("\u{1F4AD} Has insight");break;case"off":this.statusBarEl.setText("\u25CB Therapist off");break;default:this.statusBarEl.setText("\u25CF Observing")}}}async observeContent(e,t){if(this.isProcessing||!this.settings.agentId||this.pendingInsight)return;let s=e.getValue(),n=k(s);if(n&&!M(n)){this.isProcessing=!0,this.showIndicator("thinking"),this.updateStatusBar("thinking");try{let a=`[OBSERVER MODE - You are passively watching the user write. Only respond if you notice something genuinely insightful - a pattern, a reframe, a question worth asking, or an observation that could help. If nothing stands out, respond with just: [listening]]

${n}`,r=await this.lettaService.sendMessage(this.settings.agentId,a),o=(r==null?void 0:r.trim())||"";o&&o!=="[listening]"?(this.pendingInsight=r,this.showIndicator("insight"),this.updateStatusBar("insight")):(this.showIndicator("observing"),this.updateStatusBar("listening"))}catch(a){console.error("Error observing:",a),this.showIndicator("observing"),this.updateStatusBar("listening")}finally{this.isProcessing=!1}}}async triggerConversation(e,t){if(this.isProcessing)return;if(!this.settings.agentId){new c.Notice("No therapist agent configured");return}let s=e.getValue(),n=k(s);if(!n){new c.Notice("Nothing new to discuss");return}this.isProcessing=!0,this.showIndicator("thinking"),this.updateStatusBar("thinking");try{let a=`[CONVERSATION MODE - The user wants to talk. Respond directly and helpfully.]

${n}`,r=await this.lettaService.sendMessage(this.settings.agentId,a),o=(r==null?void 0:r.trim())||"";if(o&&o!=="[listening]"){let p=e.getCursor().line;e.setCursor({line:p,ch:e.getLine(p).length}),e.replaceSelection(C(r,this.settings.therapistName))}this.showIndicator("observing"),this.updateStatusBar("listening")}catch(a){console.error("Error in conversation:",a),new c.Notice("Failed to get response"),this.showIndicator("observing"),this.updateStatusBar("listening")}finally{this.isProcessing=!1}}showIndicator(e){let t=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(!t){this.hideIndicator();return}let s=t.contentEl;if(!this.indicatorEl){this.indicatorEl=document.createElement("div"),this.indicatorEl.className="therapist-indicator is-visible";let a=document.createElement("div");a.className="therapist-orb",a.addEventListener("click",r=>{r.stopPropagation(),this.pendingInsight&&this.togglePopover()}),this.indicatorEl.appendChild(a)}let n=this.indicatorEl.querySelector(".therapist-orb");n&&(n.classList.remove("is-thinking","has-insight"),e==="thinking"?n.classList.add("is-thinking"):e==="insight"&&n.classList.add("has-insight")),s.contains(this.indicatorEl)||s.appendChild(this.indicatorEl)}hideIndicator(){this.indicatorEl&&(this.indicatorEl.remove(),this.indicatorEl=null),this.hidePopover()}togglePopover(){this.popoverVisible?this.hidePopover():this.showPopover()}showPopover(){var t,s,n;if(!this.pendingInsight||!this.indicatorEl)return;this.popoverEl||(this.popoverEl=document.createElement("div"),this.popoverEl.className="therapist-popover",this.popoverEl.innerHTML=`
        <div class="therapist-popover-header">
          <span class="therapist-popover-title">Therapist Insight</span>
          <button class="therapist-popover-dismiss">\xD7</button>
        </div>
        <div class="therapist-popover-content"></div>
        <div class="therapist-popover-actions">
          <button class="therapist-popover-btn secondary dismiss-btn">Dismiss</button>
          <button class="therapist-popover-btn primary copy-btn">Copy to Daily Note</button>
        </div>
      `,(t=this.popoverEl.querySelector(".therapist-popover-dismiss"))==null||t.addEventListener("click",a=>{a.stopPropagation(),this.hidePopover()}),(s=this.popoverEl.querySelector(".dismiss-btn"))==null||s.addEventListener("click",a=>{a.stopPropagation(),this.dismissInsight()}),(n=this.popoverEl.querySelector(".copy-btn"))==null||n.addEventListener("click",a=>{a.stopPropagation(),this.copyToDailyNote()}),this.indicatorEl.appendChild(this.popoverEl));let e=this.popoverEl.querySelector(".therapist-popover-content");e&&(e.textContent=this.pendingInsight),this.popoverEl.classList.add("is-visible"),this.popoverVisible=!0}hidePopover(){this.popoverEl&&this.popoverEl.classList.remove("is-visible"),this.popoverVisible=!1}dismissInsight(){this.pendingInsight=null,this.hidePopover(),this.showIndicator("observing"),this.updateStatusBar("listening")}async copyToDailyNote(){if(this.pendingInsight)try{let e=(0,P.moment)().format("YYYY-MM-DD"),t=`${e}.md`,s=this.app.vault.getAbstractFileByPath(t);if(!s)s=await this.app.vault.create(t,`# ${e}

## Journal

### Therapist Insight

${this.pendingInsight}
`),new c.Notice("Created daily note with insight");else if(s instanceof c.TFile){let n=await this.app.vault.read(s);n.includes("## Journal")||(n+=`

## Journal
`);let a=n.indexOf("## Journal"),o=n.substring(a).substring(11).match(/\n## /),d=`
### Therapist Insight

${this.pendingInsight}
`;if(o){let p=a+11+o.index;n=n.substring(0,p)+d+n.substring(p)}else n+=d;await this.app.vault.modify(s,n),new c.Notice("Insight copied to daily note")}this.dismissInsight()}catch(e){console.error("Error copying to daily note:",e),new c.Notice("Failed to copy to daily note")}}onunload(){this.hideIndicator(),console.log("Therapist plugin unloaded")}async loadSettings(){this.settings=Object.assign({},T,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}openMemoryViewer(){if(!this.settings.agentId){new c.Notice("No therapist agent configured");return}new b(this.app,this.lettaService,this.settings.agentId).open()}async indexVault(){if(!this.settings.agentId)throw new Error("No agent configured");let e=this.settings.archiveId;if(!e){let a=(await this.lettaService.listArchives()).find(r=>r.name==="obsidian-vault");a?e=a.id:(e=await this.lettaService.createArchive("obsidian-vault"),await this.lettaService.attachArchive(this.settings.agentId,e)),this.settings.archiveId=e,await this.saveSettings()}await this.lettaService.clearArchive(e);let t=this.app.vault.getMarkdownFiles(),s=0;for(let n of t)if(this.shouldIndexFile(n))try{let a=await this.app.vault.read(n);if(a.trim().length<50)continue;let r=this.chunkContent(a,n.path);for(let o of r)await this.lettaService.addPassage(e,o.text,{source:n.path,title:n.basename});s++}catch(a){console.warn(`Failed to index ${n.path}:`,a)}this.settings.lastIndexed=Date.now(),await this.saveSettings(),console.log(`Indexed ${s} files`)}shouldIndexFile(e){let t=e.path;for(let s of this.settings.excludedFolders)if(!(s===""||s==="/")&&(t.startsWith(s+"/")||t===s))return!1;if(this.settings.includedFolders.length>0){if(this.settings.includedFolders.includes("")||this.settings.includedFolders.includes("/"))return!0;for(let n of this.settings.includedFolders)if(t.startsWith(n+"/")||t===n)return!0;return!1}return!0}chunkContent(e,t){let s=[],a=e.split(/\n\n+/),r=`[${t}]

`;for(let o of a){let d=o.trim();if(d){if(d.length<20&&d.startsWith("#")){r+=d+`

`;continue}r.length+d.length>1500&&r.length>100&&(s.push({text:r.trim()}),r=`[${t}]

`),r+=d+`

`}}return r.trim().length>50&&s.push({text:r.trim()}),s}};
